<!DOCTYPE html><html lang="zh-cn" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Flink | HeavenImmortal</title><meta name="keywords" content="大数据 流式数据数据 分布式"><meta name="author" content="HeavenImmortal,1909312602@qq.com"><meta name="copyright" content="HeavenImmortal"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="description" content="本人学习Flink时的一些随笔">
<meta property="og:type" content="article">
<meta property="og:title" content="Flink">
<meta property="og:url" content="https://heavenimtoral.gitee.io/2021/02/09/Flink/index.html">
<meta property="og:site_name" content="HeavenImmortal">
<meta property="og:description" content="本人学习Flink时的一些随笔">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://heavenimmortal.oss-cn-chengdu.aliyuncs.com/img/20210315195540.jpg">
<meta property="article:published_time" content="2021-02-09T03:10:48.993Z">
<meta property="article:modified_time" content="2021-03-15T12:04:06.564Z">
<meta property="article:author" content="HeavenImmortal">
<meta property="article:tag" content="大数据">
<meta property="article:tag" content="流式数据处理">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://heavenimmortal.oss-cn-chengdu.aliyuncs.com/img/20210315195540.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://heavenimtoral.gitee.io/2021/02/09/Flink/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"We didn't find any results for the search: ${query}"}},
  translate: {"defaultEncoding":1,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: 'days',
  date_suffix: {
    just: 'Just',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: {"limitCount":50,"languages":{"author":"Author: HeavenImmortal","link":"Link: ","source":"Source: HeavenImmortal","info":"Copyright is owned by the author. For commercial reprints, please contact the author for authorization. For non-commercial reprints, please indicate the source."}},
  ClickShowText: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  justifiedGallery: {
    js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
    css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
  },
  isPhotoFigcaption: true,
  islazyload: false,
  isanchor: true
};

var saveToLocal = {
  set: function setWithExpiry(key, value, ttl) {
    const now = new Date()
    const expiryDay = ttl * 86400000
    const item = {
      value: value,
      expiry: now.getTime() + expiryDay,
    }
    localStorage.setItem(key, JSON.stringify(item))
  },

  get: function getWithExpiry(key) {
    const itemStr = localStorage.getItem(key)

    if (!itemStr) {
      return undefined
    }
    const item = JSON.parse(itemStr)
    const now = new Date()

    if (now.getTime() > item.expiry) {
      localStorage.removeItem(key)
      return undefined
    }
    return item.value
  }
}</script><script id="config_change">var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2021-03-15 20:04:06'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(function () {  window.activateDarkMode = function () {
    document.documentElement.setAttribute('data-theme', 'dark')
    if (document.querySelector('meta[name="theme-color"]') !== null) {
      document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
    }
  }
  window.activateLightMode = function () {
    document.documentElement.setAttribute('data-theme', 'light')
   if (document.querySelector('meta[name="theme-color"]') !== null) {
      document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
    }
  }
  const autoChangeMode = 'false'
  const t = saveToLocal.get('theme')
  if (autoChangeMode === '1') {
    const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
    const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
    const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
    const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified
    if (t === undefined) {
      if (isLightMode) activateLightMode()
      else if (isDarkMode) activateDarkMode()
      else if (isNotSpecified || hasNoSupport) {
        const now = new Date()
        const hour = now.getHours()
        const isNight = hour <= 6 || hour >= 18
        isNight ? activateDarkMode() : activateLightMode()
      }
      window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
        if (saveToLocal.get('theme') === undefined) {
          e.matches ? activateDarkMode() : activateLightMode()
        }
      })
    } else if (t === 'light') activateLightMode()
    else activateDarkMode()
  } else if (autoChangeMode === '2') {
    const now = new Date()
    const hour = now.getHours()
    const isNight = hour <= 6 || hour >= 18
    if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
    else if (t === 'light') activateLightMode()
    else activateDarkMode()
  } else {
    if (t === 'dark') activateDarkMode()
    else if (t === 'light') activateLightMode()
  }const asideStatus = saveToLocal.get('aside-status')
if (asideStatus !== undefined) {
   if (asideStatus === 'hide') {
     document.documentElement.classList.add('hide-aside')
   } else {
     document.documentElement.classList.remove('hide-aside')
   }
}})()</script><link rel="stylesheet" href="/css/mine.css"><meta name="generator" content="Hexo 5.2.0"><link rel="alternate" href="/atom.xml" title="HeavenImmortal" type="application/atom+xml">
</head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">Loading...</div></div></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="author-avatar"><img class="avatar-img" src="https://heavenimmortal.oss-cn-chengdu.aliyuncs.com/img/avatar.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">44</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">Tags</div><div class="length-num">40</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">Categories</div><div class="length-num">9</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/messageboard/"><i class="fa-fw fa fa-paper-plane"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fa-fw fa fa-book"></i><span> 找文章</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></li><li><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></li><li><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 时间轴</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fa fa-link"></i><span> 链接</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/link/"><i class="fa-fw fa fa-users"></i><span> 友情链接</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fa fa-list"></i><span> 菜单</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></li></ul></div></div></div></div><div id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(https://heavenimmortal.oss-cn-chengdu.aliyuncs.com/img/20210315195540.jpg)"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">HeavenImmortal</a></span><span id="menus"><div id="search_button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> Search</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/messageboard/"><i class="fa-fw fa fa-paper-plane"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fa-fw fa fa-book"></i><span> 找文章</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></li><li><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></li><li><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 时间轴</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fa fa-link"></i><span> 链接</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/link/"><i class="fa-fw fa fa-users"></i><span> 友情链接</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fa fa-list"></i><span> 菜单</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></li></ul></div></div><span class="close" id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></span></span></nav><div id="post-info"><h1 class="post-title">Flink</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2021-02-09T03:10:48.993Z" title="Created 2021-02-09 11:10:48">2021-02-09</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2021-03-15T12:04:06.564Z" title="Updated 2021-03-15 20:04:06">2021-03-15</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE/">大数据</a></span></div><div class="meta-secondline"> <span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">Word count:</span><span class="word-count">20.1k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">Reading time:</span><span>83min</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post View:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="Flink"><a href="#Flink" class="headerlink" title="Flink"></a>Flink</h1><h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p><a target="_blank" rel="noopener" href="https://flink.apache.org/zh/community.html">官方文档</a></p>
<blockquote>
<p>流处理与批处理</p>
</blockquote>
<p>批处理：当数据量达到一定值的，才对这些数据进行处理。</p>
<p>流处理：每当一个数据到达时，对该数据进行处理。</p>
<blockquote>
<p>Flink是什么</p>
</blockquote>
<p>Apache Flink 是一个<strong>框架</strong>和分布式处理引擎，用于对<strong>无界和有界数据流</strong>进行<strong>状态</strong>计算。</p>
<blockquote>
<p>为什么选择Flink</p>
</blockquote>
<p>流数据更真实地反映了我们的生活方式 </p>
<p>• 传统的数据架构是基于有限数据集（批处理）的 </p>
<p>• 我们的目标 </p>
<p>➢ 低延迟 </p>
<p>➢ 高吞吐</p>
<p> ➢ 结果的准确性和良好的容错性</p>
<blockquote>
<p>哪些行业需要处理流数据</p>
</blockquote>
<p>• 电商和市场营销</p>
<p> ➢ 数据报表、广告投放、业务流程需要 </p>
<p>• 物联网（IOT） </p>
<p>➢ 传感器实时数据采集和显示、实时报警，交通运输业 </p>
<p>• 电信业</p>
<p> ➢ 基站流量调配 </p>
<p>• 银行和金融业 </p>
<p>➢ 实时结算和通知推送，实时检测异常行为</p>
<blockquote>
<p>处理架构</p>
</blockquote>
<p>1.传统数据处理架构</p>
<p>①.事务处理</p>
<p>上层为计算层，数据处理在该层。</p>
<p>下层为存储层，数据存储在该层。</p>
<p>实时性很好，来一个event，处理一个event，但是同时处理数据有限。</p>
<p><img src="https://heavenimmortal.oss-cn-chengdu.aliyuncs.com/img/image-20210209123715297.png" alt="image-20210209123715297"></p>
<p>②.分析处理</p>
<p>将数据从业务数据库复制到数仓，再进行分析和查询</p>
<p>高延迟，实时性不好。</p>
<p><img src="https://heavenimmortal.oss-cn-chengdu.aliyuncs.com/img/image-20210209123754754.png" alt="image-20210209123754754"></p>
<p>2.有状态的流式处理</p>
<p>当前数据处理中需要的数据存放在本地内存的本地状态里，为了防止节点挂了导致状态丢失，所以对这些状态做一个定期的检查，存放进持久化的数据库中，但是数据顺序无法保证</p>
<p><img src="https://heavenimmortal.oss-cn-chengdu.aliyuncs.com/img/image-20210209123851747.png" alt="image-20210209123851747"></p>
<p>3.lambda 架构</p>
<p> 用两套系统，同时保证低延迟和结果准确</p>
<p>batch layer:批处理层</p>
<p>speed layer：流处理层，快速处理</p>
<p>先快速处理，得到一个近似结果，过一段时间，得到批处理的正确结果</p>
<p><img src="https://heavenimmortal.oss-cn-chengdu.aliyuncs.com/img/image-20210209130238966.png" alt="image-20210209130238966"></p>
<p>4.Flink</p>
<p><img src="https://heavenimmortal.oss-cn-chengdu.aliyuncs.com/img/image-20210209130608691.png" alt="image-20210209130608691"></p>
<blockquote>
<p>Flink的特点</p>
</blockquote>
<p>1.事件驱动</p>
<p><img src="https://heavenimmortal.oss-cn-chengdu.aliyuncs.com/img/image-20210209130753834.png" alt="image-20210209130753834"></p>
<p>2.基于流的世界观</p>
<p>在 Flink 的世界观中，一切都是由流组成的，离线数据是有界的 流；实时数据是一个没有界限的流：这就是所谓的有界流和无界 流。</p>
<p><img src="https://heavenimmortal.oss-cn-chengdu.aliyuncs.com/img/image-20210209130918432.png" alt="image-20210209130918432"></p>
<p>3.分成API</p>
<p>越顶层越抽象，表达含义越简明，使用越方便 </p>
<p>越底层越具体，表达能力越丰富，使用越灵活</p>
<p><img src="https://heavenimmortal.oss-cn-chengdu.aliyuncs.com/img/image-20210209130950688.png" alt="image-20210209130950688"></p>
<p>4.其他特点</p>
<p>• 支持事件时间（event-time）和处理时间（processing-time） 语义 </p>
<p>• 精确一次（exactly-once）的状态一致性保证 </p>
<p>• 低延迟，每秒处理数百万个事件，毫秒级延迟 </p>
<p>• 与众多常用存储系统的连接 </p>
<p>• 高可用，动态扩展，实现7*24小时全天候运行</p>
<blockquote>
<p>Flink vs Spark Streaming</p>
</blockquote>
<p>1.流（stream）和微批（micro-batching）</p>
<p><img src="https://heavenimmortal.oss-cn-chengdu.aliyuncs.com/img/image-20210209141444460.png" alt="image-20210209141444460"></p>
<p>2.数据模型</p>
<p>– spark 采用 RDD 模型，spark streaming 的 DStream 实际上也就是一组 组小批 数据 RDD 的集合</p>
<p>– flink 基本数据模型是数据流，以及事件（Event）序列</p>
<p>3.运行时架构</p>
<p>– spark 是批计算，将 DAG 划分为不同的 stage，一个完成后才可以计算下一个</p>
<p> – flink 是标准的流执行模式，一个事件在一个节点处理完后可以直接发往下一个节点进行处理</p>
<h1 id="简单上手"><a href="#简单上手" class="headerlink" title="简单上手"></a>简单上手</h1><h2 id="批处理wordCount"><a href="#批处理wordCount" class="headerlink" title="批处理wordCount"></a>批处理wordCount</h2><p>1.新建项目</p>
<p>2.导入依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.flink<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>flink-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.10.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.flink<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>flink-streaming-java_2.12<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.10.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>3.测试数据</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">hello word</span><br><span class="line">hello flink</span><br><span class="line">hello java</span><br><span class="line">hello mysql</span><br><span class="line">hello vue</span><br><span class="line">hello javascript</span><br></pre></td></tr></table></figure>

<p>4.业务代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.hl.wc;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.api.common.functions.FlatMapFunction;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.api.java.DataSet;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.api.java.ExecutionEnvironment;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.api.java.tuple.Tuple2;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.util.Collector;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * author: huangLong</span></span><br><span class="line"><span class="comment"> * date:2021/2/9 14:29</span></span><br><span class="line"><span class="comment"> * describe: 批处理wordCount</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//批处理wordCount</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WordCount</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        <span class="comment">//创建执行环境</span></span><br><span class="line">        ExecutionEnvironment env = ExecutionEnvironment.getExecutionEnvironment();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//从文件中读取数据</span></span><br><span class="line">        String inputPath = <span class="string">&quot;E:\\ideaProgram\\flinkTest\\src\\main\\resources\\hello.txt&quot;</span>;</span><br><span class="line">        DataSet&lt;String&gt; inputDataSet = env.readTextFile(inputPath);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//对数据集进行处理,按空格分词展开,转换成(word, 1)二元组进行统计</span></span><br><span class="line">        DataSet&lt;Tuple2&lt;String, Integer&gt;&gt; resultSet = inputDataSet.flatMap(<span class="keyword">new</span> MyFlatMapper())</span><br><span class="line">                .groupBy(<span class="number">0</span>)    <span class="comment">// 按照第一个位置的word分组</span></span><br><span class="line">                .sum(<span class="number">1</span>);    <span class="comment">// 将第二个位置上的数据求和</span></span><br><span class="line">          resultSet.print();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 自定义类，实现FlatMapFunction接口</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MyFlatMapper</span> <span class="keyword">implements</span> <span class="title">FlatMapFunction</span>&lt;<span class="title">String</span>, <span class="title">Tuple2</span>&lt;<span class="title">String</span>, <span class="title">Integer</span>&gt;&gt; </span>&#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">flatMap</span><span class="params">(String value, Collector&lt;Tuple2&lt;String, Integer&gt;&gt; out)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">            <span class="comment">// 按空格分词</span></span><br><span class="line">            String[] words = value.split(<span class="string">&quot; &quot;</span>);</span><br><span class="line">            <span class="comment">// 遍历所有word，包成二元组输出</span></span><br><span class="line">            <span class="keyword">for</span> (String word : words) &#123;</span><br><span class="line">                out.collect(<span class="keyword">new</span> Tuple2&lt;String, Integer&gt;(word, <span class="number">1</span>));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>5.结果</p>
<p><img src="https://heavenimmortal.oss-cn-chengdu.aliyuncs.com/img/image-20210209144857277.png" alt="image-20210209144857277"></p>
<h2 id="流处理WordCount"><a href="#流处理WordCount" class="headerlink" title="流处理WordCount"></a>流处理WordCount</h2><p>1.业务代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.hl.wc;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.api.java.ExecutionEnvironment;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.api.java.tuple.Tuple2;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.datastream.DataStream;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.environment.StreamExecutionEnvironment;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * author: huangLong</span></span><br><span class="line"><span class="comment"> * date:2021/2/9 14:49</span></span><br><span class="line"><span class="comment"> * describe: 流处理WordCont</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StreamWordCount</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">//创建执行环境</span></span><br><span class="line">        StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();</span><br><span class="line">		<span class="comment">//设置并行度</span></span><br><span class="line">        env.setParallelism(<span class="number">4</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//从文件中读取数据</span></span><br><span class="line">        String inputPath = <span class="string">&quot;E:\\ideaProgram\\flinkTest\\src\\main\\resources\\hello.txt&quot;</span>;</span><br><span class="line">        DataStream&lt;String&gt; inputDataStream = env.readTextFile(inputPath);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//基于数据流进行转换计算</span></span><br><span class="line">        DataStream&lt;Tuple2&lt;String,Integer&gt;&gt; resultMap =  inputDataStream.flatMap(<span class="keyword">new</span> WordCount.MyFlatMapper())</span><br><span class="line">                .keyBy(<span class="number">0</span>)<span class="comment">//按照当前key的hashcode进行重分区</span></span><br><span class="line">                .sum(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        resultMap.print().setParallelism(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//执行</span></span><br><span class="line">        env.execute();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>2.结果</p>
<p><img src="https://heavenimmortal.oss-cn-chengdu.aliyuncs.com/img/image-20210209150125071.png" alt="image-20210209150125071"></p>
<h2 id="流式数据源"><a href="#流式数据源" class="headerlink" title="流式数据源"></a>流式数据源</h2><p>我们使用linux下的netcat工具模仿 数据源</p>
<blockquote>
<p>netcat</p>
</blockquote>
<p>netcat是一个通过TCP/UDP在网络中进行读写数据工具（命令），被称为“瑞士军刀”，<strong>主要用于调试领域、传输领域甚至黑客攻击领域</strong>。利用该工具，可以将网络中一端的数据完整的发送至另一台主机终端显示或存储，<strong>常见的应用为文件传输、与好友即时通信、传输流媒体或者作为用来验证服务器的独立的客户端。</strong>当然，也可以在脚本中使用该工具。</p>
<p>安装命令：yum install -y nc</p>
<p>使用命令：nc -lk 9999 </p>
<p>1.业务代码</p>
<p>以带参数的形式启动</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.hl.wc;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.api.java.ExecutionEnvironment;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.api.java.tuple.Tuple2;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.api.java.utils.ParameterTool;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.datastream.DataStream;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.environment.StreamExecutionEnvironment;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * author: huangLong</span></span><br><span class="line"><span class="comment"> * date:2021/2/9 14:49</span></span><br><span class="line"><span class="comment"> * describe: 流处理WordCont</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StreamWordCount</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">//创建执行环境</span></span><br><span class="line">        StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//设置并行度</span></span><br><span class="line">        env.setParallelism(<span class="number">4</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//从文件中读取数据</span></span><br><span class="line"><span class="comment">//        String inputPath = &quot;E:\\ideaProgram\\flinkTest\\src\\main\\resources\\hello.txt&quot;;</span></span><br><span class="line"><span class="comment">//        DataStream&lt;String&gt; inputDataStream = env.readTextFile(inputPath);</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//用parameter tool工具从程序启动参数中提取配置项</span></span><br><span class="line">        ParameterTool parameterTool = ParameterTool.fromArgs(args);</span><br><span class="line">        String host = parameterTool.get(<span class="string">&quot;host&quot;</span>);</span><br><span class="line">        <span class="keyword">int</span> port = parameterTool.getInt(<span class="string">&quot;port&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//从socket文本流读取数据,参数为 ip地址和 端口号</span></span><br><span class="line">        DataStream&lt;String&gt; inputDataStream = env.socketTextStream(host,port);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//基于数据流进行转换计算</span></span><br><span class="line">        DataStream&lt;Tuple2&lt;String,Integer&gt;&gt; resultMap =  inputDataStream.flatMap(<span class="keyword">new</span> WordCount.MyFlatMapper())</span><br><span class="line">                .keyBy(<span class="number">0</span>)<span class="comment">//按照当前key的hashcode进行重分区</span></span><br><span class="line">                .sum(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        resultMap.print();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//执行</span></span><br><span class="line">        env.execute();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>2.linux开启netcat，再启动程序</p>
<p><img src="https://heavenimmortal.oss-cn-chengdu.aliyuncs.com/img/image-20210209151616182.png" alt="image-20210209151616182"></p>
<p>3.netcat输入数据</p>
<p>①输入hello word</p>
<p><img src="https://heavenimmortal.oss-cn-chengdu.aliyuncs.com/img/image-20210209151759532.png" alt="image-20210209151759532"></p>
<p><img src="https://heavenimmortal.oss-cn-chengdu.aliyuncs.com/img/image-20210209151811492.png" alt="image-20210209151811492"></p>
<p>②输入hello vue</p>
<p><img src="https://heavenimmortal.oss-cn-chengdu.aliyuncs.com/img/image-20210209151844596.png" alt="image-20210209151844596"></p>
<p><img src="https://heavenimmortal.oss-cn-chengdu.aliyuncs.com/img/image-20210209151856451.png" alt="image-20210209151856451"></p>
<p>③输入how are you </p>
<p><img src="https://heavenimmortal.oss-cn-chengdu.aliyuncs.com/img/image-20210209151943699.png" alt="image-20210209151943699"></p>
<p><img src="https://heavenimmortal.oss-cn-chengdu.aliyuncs.com/img/image-20210209151937772.png" alt="image-20210209151937772"></p>
<p>你会发现每当你输入一条数据，flink就会处理一条数据，这样就是流数据处理，只要你一直输入，flink正常运行下就会一直处理下去，每来一条数据，就处理一条数据，实现了低延迟，实时性。</p>
<h1 id="Flink部署"><a href="#Flink部署" class="headerlink" title="Flink部署"></a>Flink部署</h1><h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p>将flink部署到linux服务器上</p>
<p>1.在官网下载压缩包</p>
<p><img src="https://heavenimmortal.oss-cn-chengdu.aliyuncs.com/img/image-20210209153428033.png" alt="image-20210209153428033"></p>
<p>2.上传到linux服务器上</p>
<p><img src="https://heavenimmortal.oss-cn-chengdu.aliyuncs.com/img/image-20210209153506575.png" alt="image-20210209153506575"></p>
<p>3.解压</p>
<p>tar zxvf flink-1.10.1-bin-scala_2.12.tgz</p>
<p>4.启动 在bin目录下</p>
<p>./start-cluster.sh</p>
<p>5.访问ip地址:8081</p>
<p><img src="https://heavenimmortal.oss-cn-chengdu.aliyuncs.com/img/image-20210209170109980.png" alt="image-20210209170109980"></p>
<h2 id="job的提交方式"><a href="#job的提交方式" class="headerlink" title="job的提交方式"></a>job的提交方式</h2><p>1.打包</p>
<p><img src="https://heavenimmortal.oss-cn-chengdu.aliyuncs.com/img/image-20210209170846589.png" alt="image-20210209170846589"></p>
<p>2.提交</p>
<p><img src="https://heavenimmortal.oss-cn-chengdu.aliyuncs.com/img/image-20210209171014685.png" alt="image-20210209171014685"></p>
<p>3.配置</p>
<p><img src="https://heavenimmortal.oss-cn-chengdu.aliyuncs.com/img/image-20210209171250338.png" alt="image-20210209171250338"></p>
<p>4.结果</p>
<p><img src="https://heavenimmortal.oss-cn-chengdu.aliyuncs.com/img/image-20210209173007726.png" alt="image-20210209173007726"></p>
<h1 id="运行时架构"><a href="#运行时架构" class="headerlink" title="运行时架构"></a>运行时架构</h1><h2 id="运行时组件"><a href="#运行时组件" class="headerlink" title="运行时组件"></a>运行时组件</h2><p><img src="https://heavenimmortal.oss-cn-chengdu.aliyuncs.com/img/image-20210209174820961.png" alt="image-20210209174820961"></p>
<h3 id="作业管理器（jobManager）"><a href="#作业管理器（jobManager）" class="headerlink" title="作业管理器（jobManager）"></a>作业管理器（jobManager）</h3><p>• 控制一个应用程序执行的主进程，也就是说，每个应用程序都会被一个不同的 JobManager 所控制执行。 </p>
<p>• JobManager 会先接收到要执行的应用程序，这个应用程序会包括：作业图 （JobGraph）、逻辑数据流图（logical dataflow graph）和打包了所有的类、 库和其它资源的JAR包。</p>
<p> • JobManager 会把JobGraph转换成一个物理层面的数据流图，这个图被叫做 “执行图”（ExecutionGraph），包含了所有可以并发执行的任务。 </p>
<p>• JobManager 会向资源管理器（ResourceManager）请求执行任务必要的资源， 也就是任务管理器（TaskManager）上的插槽（slot）。一旦它获取到了足够的 资源，就会将执行图分发到真正运行它们的TaskManager上。而在运行过程中， JobManager会负责所有需要中央协调的操作，比如说检查点（checkpoints） 的协调。</p>
<h3 id="任务管理器（TaskManager）"><a href="#任务管理器（TaskManager）" class="headerlink" title="任务管理器（TaskManager）"></a>任务管理器（TaskManager）</h3><p>• Flink中的工作进程。通常在Flink中会有多个TaskManager运行，每一 个TaskManager都包含了一定数量的插槽（slots）。插槽的数量限制 了TaskManager能够执行的任务数量。</p>
<p> • 启动之后，TaskManager会向资源管理器注册它的插槽；收到资源管理 器的指令后，TaskManager就会将一个或者多个插槽提供给 JobManager调用。JobManager就可以向插槽分配任务（tasks）来 执行了。</p>
<p> • 在执行过程中，一个TaskManager可以跟其它运行同一应用程序的 TaskManager交换数据。</p>
<h3 id="资源管理器（ResourceManager）"><a href="#资源管理器（ResourceManager）" class="headerlink" title="资源管理器（ResourceManager）"></a>资源管理器（ResourceManager）</h3><p>• 主要负责管理任务管理器（TaskManager）的插槽（slot）， TaskManger 插槽是Flink中定义的处理资源单元。</p>
<p> • Flink为不同的环境和资源管理工具提供了不同资源管理器，比如YARN、 Mesos、K8s，以及standalone部署。</p>
<p> • 当JobManager申请插槽资源时，ResourceManager会将有空闲插槽 的TaskManager分配给JobManager。如果ResourceManager没有足 够的插槽来满足JobManager的请求，它还可以向资源提供平台发起会 话，以提供启动TaskManager进程的容器。</p>
<h3 id="分发器（Dispatcher）"><a href="#分发器（Dispatcher）" class="headerlink" title="分发器（Dispatcher）"></a>分发器（Dispatcher）</h3><p>• 可以跨作业运行，它为应用提交提供了REST接口。</p>
<p> • 当一个应用被提交执行时，分发器就会启动并将应用移交给一个 JobManager。</p>
<p> • Dispatcher也会启动一个Web UI，用来方便地展示和监控作业 执行的信息。</p>
<p> • Dispatcher在架构中可能并不是必需的，这取决于应用提交运行 的方式。</p>
<h2 id="任务提交流程"><a href="#任务提交流程" class="headerlink" title="任务提交流程"></a>任务提交流程</h2><p><img src="https://heavenimmortal.oss-cn-chengdu.aliyuncs.com/img/image-20210209175704646.png" alt="image-20210209175704646"></p>
<h2 id="任务调度原理"><a href="#任务调度原理" class="headerlink" title="任务调度原理"></a>任务调度原理</h2><p><img src="https://heavenimmortal.oss-cn-chengdu.aliyuncs.com/img/image-20210209180519296.png" alt="image-20210209180519296"></p>
<h2 id="并行度"><a href="#并行度" class="headerlink" title="并行度"></a>并行度</h2><p><img src="https://heavenimmortal.oss-cn-chengdu.aliyuncs.com/img/image-20210209181239808.png" alt="image-20210209181239808"></p>
<p>一个特定算子的 子任务（subtask）的个数被称之为其并行度（parallelism）。 一般情况下，一个 stream 的并行度，可以认为就是其所有算子中最大的并行度。</p>
<h2 id="TaskManager-和-Slots"><a href="#TaskManager-和-Slots" class="headerlink" title="TaskManager 和 Slots"></a>TaskManager 和 Slots</h2><p><img src="https://heavenimmortal.oss-cn-chengdu.aliyuncs.com/img/image-20210209181519368.png" alt="image-20210209181519368"></p>
<p>• Flink 中每一个 TaskManager 都是一个JVM进程，它可能会在独立的线程上执 行一个或多个子任务 </p>
<p>• 为了控制一个 TaskManager 能接收多少个 task， TaskManager 通过 task slot 来进行控制（一个 TaskManager 至少有一个 slot）</p>
<p><img src="https://heavenimmortal.oss-cn-chengdu.aliyuncs.com/img/image-20210209181537143.png" alt="image-20210209181537143"></p>
<p>• 默认情况下，Flink 允许子任务共享 slot，即使它们是不同任务的子任务。 这样 的结果是，一个 slot 可以保存作业的整个管道。</p>
<p> • Task Slot 是静态的概念，是指 TaskManager 具有的并发执行能力</p>
<h2 id="并行子任务的分配"><a href="#并行子任务的分配" class="headerlink" title="并行子任务的分配"></a>并行子任务的分配</h2><p><img src="https://heavenimmortal.oss-cn-chengdu.aliyuncs.com/img/image-20210209181615176.png" alt="image-20210209181615176"></p>
<p><img src="https://heavenimmortal.oss-cn-chengdu.aliyuncs.com/img/image-20210209181637649.png" alt="image-20210209181637649"></p>
<p><img src="https://heavenimmortal.oss-cn-chengdu.aliyuncs.com/img/image-20210209181649704.png" alt="image-20210209181649704"></p>
<h2 id="程序与数据流（DataFlow）"><a href="#程序与数据流（DataFlow）" class="headerlink" title="程序与数据流（DataFlow）"></a>程序与数据流（DataFlow）</h2><p><img src="https://heavenimmortal.oss-cn-chengdu.aliyuncs.com/img/image-20210209181711447.png" alt="image-20210209181711447"></p>
<p>• 所有的Flink程序都是由三部分组成的： Source 、Transformation 和 Sink。</p>
<p> • Source 负责读取数据源，Transformation 利用各种算子进行处理加工，Sink 负责输出</p>
<p>• 在运行时，Flink上运行的程序会被映射成“逻辑数据流”（dataflows），它包 含了这三部分 </p>
<p>• 每一个dataflow以一个或多个sources开始以一个或多个sinks结束。dataflow 类似于任意的有向无环图（DAG） </p>
<p>• 在大部分情况下，程序中的转换运算（transformations）跟dataflow中的算子 （operator）是一一对应的关系</p>
<p><img src="https://heavenimmortal.oss-cn-chengdu.aliyuncs.com/img/image-20210209184826111.png" alt="image-20210209184826111"></p>
<h2 id="执行图（ExecutionGraph）"><a href="#执行图（ExecutionGraph）" class="headerlink" title="执行图（ExecutionGraph）"></a>执行图（ExecutionGraph）</h2><p>• Flink 中的执行图可以分成四层：StreamGraph -&gt; JobGraph -&gt; ExecutionGraph -&gt; 物理执行图 </p>
<p>➢ StreamGraph：是根据用户通过 Stream API 编写的代码生成的最初的图。用来 表示程序的拓扑结构。 </p>
<p>➢ JobGraph：StreamGraph经过优化后生成了 JobGraph，提交给 JobManager 的数据结构。主要的优化为，将多个符合条件的节点 chain 在一起作为一个节点 </p>
<p>➢ ExecutionGraph：JobManager 根据 JobGraph 生成ExecutionGraph。 ExecutionGraph是JobGraph的并行化版本，是调度层最核心的数据结构。 </p>
<p>➢ 物理执行图：JobManager 根据 ExecutionGraph 对 Job 进行调度后，在各个 TaskManager 上部署 Task 后形成的“图”，并不是一个具体的数据结构。</p>
<p><img src="https://heavenimmortal.oss-cn-chengdu.aliyuncs.com/img/image-20210209181825800.png" alt="image-20210209181825800"></p>
<h2 id="数据传输形式"><a href="#数据传输形式" class="headerlink" title="数据传输形式"></a>数据传输形式</h2><p>• 一个程序中，不同的算子可能具有不同的并行度</p>
<p> • 算子之间传输数据的形式可以是 one-to-one (forwarding) 的模式也可以是 redistributing 的模式，具体是哪一种形式，取决于算子的种类 </p>
<p>➢ One-to-one：stream维护着分区以及元素的顺序（比如source和map之间）。 这意味着map 算子的子任务看到的元素的个数以及顺序跟 source 算子的子任务 生产的元素的个数、顺序相同。map、fliter、flatMap等算子都是one-to-one 的对应关系。</p>
<p> ➢ Redistributing：stream的分区会发生改变。每一个算子的子任务依据所选择的 transformation发送数据到不同的目标任务。例如，keyBy 基于 hashCode 重 分区、而 broadcast 和 rebalance 会随机重新分区，这些算子都会引起 redistribute过程，而 redistribute 过程就类似于 Spark 中的 shuffle 过程。</p>
<h2 id="任务链（Operator-Chains）"><a href="#任务链（Operator-Chains）" class="headerlink" title="任务链（Operator Chains）"></a>任务链（Operator Chains）</h2><p>• Flink 采用了一种称为任务链的优化技术，可以在特定条件下减少本地 通信的开销。为了满足任务链的要求，必须将两个或多个算子设为相同 的并行度，并通过本地转发（local forward）的方式进行连接</p>
<p> • 相同并行度的 one-to-one 操作，Flink 这样相连的算子链接在一起形 成一个 task，原来的算子成为里面的 subtask </p>
<p>• 并行度相同、并且是 one-to-one 操作，两个条件缺一不可</p>
<p><img src="https://heavenimmortal.oss-cn-chengdu.aliyuncs.com/img/image-20210209181940656.png" alt="image-20210209181940656"></p>
<h1 id="流处理API"><a href="#流处理API" class="headerlink" title="流处理API"></a>流处理API</h1><h2 id="Environment"><a href="#Environment" class="headerlink" title="Environment"></a>Environment</h2><p>1.Flink中你可以使用StreamExecutionEnvironment.getExecutionEnvironment创建l流式程序的运行环境。<br>例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();</span><br></pre></td></tr></table></figure>

<p>2.如果没有设置并行度，会以Flink-conf.yaml文件的配置为准，默认为1。<br>3.createLocalEnvironment，返回本地执行环境，需要在调用时指定并行度。<br>4.createRemoteEnvirometn，返回集群的运行环境，将Jar提交到远程服务器。需要在调用时指定JobManager的IP和端口号，并制定在集群中运行的Jar包。</p>
<h2 id="Source"><a href="#Source" class="headerlink" title="Source"></a>Source</h2><h3 id="fromCollection"><a href="#fromCollection" class="headerlink" title="fromCollection"></a>fromCollection</h3><p>从集合中读取数据</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ts.flink;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 传感器温度读数的数据类型</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SensorReading</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 属性：id，时间戳，温度值</span></span><br><span class="line">    <span class="keyword">private</span> String id;</span><br><span class="line">    <span class="keyword">private</span> Long timestamp;</span><br><span class="line">    <span class="keyword">private</span> Double temperature;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SensorReading</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SensorReading</span><span class="params">(String id, Long timestamp, Double temperature)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.id = id;</span><br><span class="line">        <span class="keyword">this</span>.timestamp = timestamp;</span><br><span class="line">        <span class="keyword">this</span>.temperature = temperature;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setId</span><span class="params">(String id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.id = id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Long <span class="title">getTimestamp</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> timestamp;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setTimestamp</span><span class="params">(Long timestamp)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.timestamp = timestamp;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Double <span class="title">getTemperature</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> temperature;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setTemperature</span><span class="params">(Double temperature)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.temperature = temperature;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;SensorReading&#123;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;id=&#x27;&quot;</span> + id + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&quot;, timestamp=&quot;</span> + timestamp +</span><br><span class="line">                <span class="string">&quot;, temperature=&quot;</span> + temperature +</span><br><span class="line">                <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">----------</span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> com.ts.flink;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.datastream.DataStream;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.environment.StreamExecutionEnvironment;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SourceTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        <span class="comment">// 创建执行环境</span></span><br><span class="line">        StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();</span><br><span class="line">        env.setParallelism(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 从集合中读取数据</span></span><br><span class="line">        DataStream&lt;SensorReading&gt; dataStream = env.fromCollection(Arrays.asList(</span><br><span class="line">                <span class="keyword">new</span> SensorReading(<span class="string">&quot;sensor_1&quot;</span>, <span class="number">1547718199L</span>, <span class="number">35.8</span>),</span><br><span class="line">                <span class="keyword">new</span> SensorReading(<span class="string">&quot;sensor_6&quot;</span>, <span class="number">1547718201L</span>, <span class="number">15.4</span>),</span><br><span class="line">                <span class="keyword">new</span> SensorReading(<span class="string">&quot;sensor_7&quot;</span>, <span class="number">1547718202L</span>, <span class="number">6.7</span>),</span><br><span class="line">                <span class="keyword">new</span> SensorReading(<span class="string">&quot;sensor_10&quot;</span>, <span class="number">1547718205L</span>, <span class="number">38.1</span>)</span><br><span class="line">        ));</span><br><span class="line"></span><br><span class="line">        DataStream&lt;Integer&gt; integerDataStream = env.fromElements(<span class="number">1</span>, <span class="number">2</span>, <span class="number">4</span>, <span class="number">67</span>, <span class="number">189</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 打印输出</span></span><br><span class="line">        dataStream.print(<span class="string">&quot;data&quot;</span>);</span><br><span class="line">        integerDataStream.print(<span class="string">&quot;int&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 执行</span></span><br><span class="line">        env.execute();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">----------</span><br><span class="line"><span class="keyword">int</span>&gt; <span class="number">1</span></span><br><span class="line"><span class="keyword">int</span>&gt; <span class="number">2</span></span><br><span class="line"><span class="keyword">int</span>&gt; <span class="number">4</span></span><br><span class="line"><span class="keyword">int</span>&gt; <span class="number">67</span></span><br><span class="line"><span class="keyword">int</span>&gt; <span class="number">189</span></span><br><span class="line">data&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_1&#x27;</span>, timestamp=<span class="number">1547718199</span>, temperature=<span class="number">35.8</span>&#125;</span><br><span class="line">data&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_6&#x27;</span>, timestamp=<span class="number">1547718201</span>, temperature=<span class="number">15.4</span>&#125;</span><br><span class="line">data&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_7&#x27;</span>, timestamp=<span class="number">1547718202</span>, temperature=<span class="number">6.7</span>&#125;</span><br><span class="line">data&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_10&#x27;</span>, timestamp=<span class="number">1547718205</span>, temperature=<span class="number">38.1</span>&#125;</span><br></pre></td></tr></table></figure>

<h3 id="readTextFile"><a href="#readTextFile" class="headerlink" title="readTextFile"></a>readTextFile</h3><p>从文件中读取数据</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ts.flink;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.datastream.DataStream;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.environment.StreamExecutionEnvironment;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SourceTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        <span class="comment">// 创建执行环境</span></span><br><span class="line">        StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();</span><br><span class="line">        env.setParallelism(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 从文件读取数据</span></span><br><span class="line">        DataStream&lt;String&gt; dataStream = env.readTextFile(<span class="string">&quot;..\\resources\\sensor.txt&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 打印输出</span></span><br><span class="line">        dataStream.print();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 执行</span></span><br><span class="line">        env.execute();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">----------</span><br><span class="line">sensor_1,<span class="number">1547718199</span>,<span class="number">35.8</span></span><br><span class="line">sensor_6,<span class="number">1547718201</span>,<span class="number">15.4</span></span><br><span class="line">sensor_7,<span class="number">1547718202</span>,<span class="number">6.7</span></span><br><span class="line">sensor_10,<span class="number">1547718205</span>,<span class="number">38.1</span></span><br><span class="line">sensor_1,<span class="number">1547718207</span>,<span class="number">36.3</span></span><br><span class="line">sensor_1,<span class="number">1547718209</span>,<span class="number">32.8</span></span><br><span class="line">sensor_1,<span class="number">1547718212</span>,<span class="number">37.1</span></span><br></pre></td></tr></table></figure>

<h3 id="FlinkKafkaConsumer"><a href="#FlinkKafkaConsumer" class="headerlink" title="FlinkKafkaConsumer"></a>FlinkKafkaConsumer</h3><p>从kafka中读取数据</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ts.flink;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.api.common.serialization.SimpleStringSchema;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.datastream.DataStream;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.environment.StreamExecutionEnvironment;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.connectors.kafka.FlinkKafkaConsumer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Properties;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SourceTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        <span class="comment">// 创建执行环境</span></span><br><span class="line">        StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();</span><br><span class="line">        env.setParallelism(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        Properties properties = <span class="keyword">new</span> Properties();</span><br><span class="line">        properties.setProperty(<span class="string">&quot;bootstrap.servers&quot;</span>, <span class="string">&quot;192.168.110.110:9092&quot;</span>);</span><br><span class="line">        properties.setProperty(<span class="string">&quot;group.id&quot;</span>, <span class="string">&quot;consumer-group&quot;</span>);</span><br><span class="line">        properties.setProperty(<span class="string">&quot;key.deserializer&quot;</span>, <span class="string">&quot;org.apache.kafka.common.serialization.StringDeserializer&quot;</span>);</span><br><span class="line">        properties.setProperty(<span class="string">&quot;value.deserializer&quot;</span>, <span class="string">&quot;org.apache.kafka.common.serialization.StringDeserializer&quot;</span>);</span><br><span class="line">        properties.setProperty(<span class="string">&quot;auto.offset.reset&quot;</span>, <span class="string">&quot;latest&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 从文件读取数据  管道名称  连接方法  配置信息</span></span><br><span class="line">        DataStream&lt;String&gt; dataStream = env.addSource( <span class="keyword">new</span> FlinkKafkaConsumer&lt;String&gt;(<span class="string">&quot;sensor&quot;</span>, <span class="keyword">new</span> SimpleStringSchema(), properties));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 打印输出</span></span><br><span class="line">        dataStream.print();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 执行</span></span><br><span class="line">        env.execute();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://heavenimmortal.oss-cn-chengdu.aliyuncs.com/img/1ec7322ad2ae90e6dd85ba759435bc50.png" alt="image-20201231112444563"></p>
<p><img src="https://heavenimmortal.oss-cn-chengdu.aliyuncs.com/img/1ec7322ad2ae90e6dd85ba759435bc50.png" alt="image-20201231112501759"></p>
<h3 id="SourceFunction"><a href="#SourceFunction" class="headerlink" title="SourceFunction"></a>SourceFunction</h3><p>自定义数据来源</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ts.flink;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.datastream.DataStream;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.environment.StreamExecutionEnvironment;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.functions.source.SourceFunction;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Random;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SourceTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        <span class="comment">// 创建执行环境</span></span><br><span class="line">        StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();</span><br><span class="line">        env.setParallelism(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        DataStream&lt;SensorReading&gt; dataStream = env.addSource( <span class="keyword">new</span> MySensorSource() );</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 打印输出</span></span><br><span class="line">        dataStream.print();</span><br><span class="line"></span><br><span class="line">        env.execute();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 实现自定义的SourceFunction</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MySensorSource</span> <span class="keyword">implements</span> <span class="title">SourceFunction</span>&lt;<span class="title">SensorReading</span>&gt; </span>&#123;</span><br><span class="line">        <span class="comment">// 定义一个标识位，用来控制数据的产生</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">boolean</span> running = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">(SourceContext&lt;SensorReading&gt; ctx)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">            <span class="comment">// 定义一个随机数发生器</span></span><br><span class="line">            Random random = <span class="keyword">new</span> Random();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 设置10个传感器的初始温度</span></span><br><span class="line">            HashMap&lt;String, Double&gt; sensorTempMap = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">            <span class="keyword">for</span>( <span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++ )&#123;</span><br><span class="line">                sensorTempMap.put(<span class="string">&quot;sensor_&quot;</span> + (i+<span class="number">1</span>), <span class="number">60</span> + random.nextGaussian() * <span class="number">20</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">while</span> (running)&#123;</span><br><span class="line">                <span class="keyword">for</span>( String sensorId: sensorTempMap.keySet() )&#123;</span><br><span class="line">                    <span class="comment">// 在当前温度基础上随机波动</span></span><br><span class="line">                    Double newtemp = sensorTempMap.get(sensorId) + random.nextGaussian();</span><br><span class="line">                    sensorTempMap.put(sensorId, newtemp);</span><br><span class="line">                    ctx.collect(<span class="keyword">new</span> SensorReading(sensorId, System.currentTimeMillis(), newtemp));</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 控制输出频率</span></span><br><span class="line">                Thread.sleep(<span class="number">1000L</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">cancel</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            running = <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">----------</span><br><span class="line">SensorReading&#123;id=<span class="string">&#x27;sensor_10&#x27;</span>, timestamp=<span class="number">1609393775349</span>, temperature=<span class="number">61.48794806847098</span>&#125;</span><br><span class="line">SensorReading&#123;id=<span class="string">&#x27;sensor_4&#x27;</span>, timestamp=<span class="number">1609393775349</span>, temperature=<span class="number">41.17315799659017</span>&#125;</span><br><span class="line">SensorReading&#123;id=<span class="string">&#x27;sensor_1&#x27;</span>, timestamp=<span class="number">1609393775349</span>, temperature=<span class="number">60.646840931571724</span>&#125;</span><br><span class="line">SensorReading&#123;id=<span class="string">&#x27;sensor_2&#x27;</span>, timestamp=<span class="number">1609393775349</span>, temperature=<span class="number">76.26340337275492</span>&#125;</span><br><span class="line">SensorReading&#123;id=<span class="string">&#x27;sensor_7&#x27;</span>, timestamp=<span class="number">1609393775349</span>, temperature=<span class="number">71.9787630892099</span>&#125;</span><br><span class="line">SensorReading&#123;id=<span class="string">&#x27;sensor_8&#x27;</span>, timestamp=<span class="number">1609393775349</span>, temperature=<span class="number">57.1961185158635</span>&#125;</span><br><span class="line">SensorReading&#123;id=<span class="string">&#x27;sensor_5&#x27;</span>, timestamp=<span class="number">1609393775349</span>, temperature=<span class="number">49.45034930571155</span>&#125;</span><br><span class="line">SensorReading&#123;id=<span class="string">&#x27;sensor_6&#x27;</span>, timestamp=<span class="number">1609393775349</span>, temperature=<span class="number">90.86870265386753</span>&#125;</span><br><span class="line">SensorReading&#123;id=<span class="string">&#x27;sensor_9&#x27;</span>, timestamp=<span class="number">1609393775349</span>, temperature=<span class="number">56.67807942587405</span>&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Transform转换算子"><a href="#Transform转换算子" class="headerlink" title="Transform转换算子"></a>Transform转换算子</h2><h3 id="Map"><a href="#Map" class="headerlink" title="Map"></a>Map</h3><p>1对1转换。</p>
<p><img src="https://heavenimmortal.oss-cn-chengdu.aliyuncs.com/img/935c7bdc2aa815e8144a679e1f1633a2.png" alt="image-20201231135930774"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ts.flink;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.api.common.functions.MapFunction;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.datastream.DataStream;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.environment.StreamExecutionEnvironment;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TransformTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();</span><br><span class="line">        env.setParallelism(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 从文件读取数据</span></span><br><span class="line">        DataStream&lt;String&gt; inputStream = env.readTextFile(<span class="string">&quot;..\\resources\\sensor.txt&quot;</span>);</span><br><span class="line">        <span class="comment">// map，把String转换成长度输出</span></span><br><span class="line">        DataStream&lt;Integer&gt; mapStream = inputStream.map(<span class="keyword">new</span> MapFunction&lt;String, Integer&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> Integer <span class="title">map</span><span class="params">(String value)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> value.length();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 打印输出</span></span><br><span class="line">        mapStream.print(<span class="string">&quot;map&quot;</span>);</span><br><span class="line">        env.execute();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">----------</span><br><span class="line">map&gt; <span class="number">24</span></span><br><span class="line">map&gt; <span class="number">24</span></span><br><span class="line">map&gt; <span class="number">23</span></span><br><span class="line">map&gt; <span class="number">25</span></span><br><span class="line">map&gt; <span class="number">24</span></span><br><span class="line">map&gt; <span class="number">24</span></span><br><span class="line">map&gt; <span class="number">24</span></span><br></pre></td></tr></table></figure>

<h3 id="flatMap"><a href="#flatMap" class="headerlink" title="flatMap"></a>flatMap</h3><p>1对多转换。</p>
<p><img src="https://heavenimmortal.oss-cn-chengdu.aliyuncs.com/img/c471a1c1a8dc2927a11b6f77ba853e32.png" alt="E6iVM8KHzYrDTy2"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ts.flink;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.api.common.functions.FlatMapFunction;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.datastream.DataStream;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.environment.StreamExecutionEnvironment;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.util.Collector;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TransformTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();</span><br><span class="line">        env.setParallelism(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 从文件读取数据</span></span><br><span class="line">        DataStream&lt;String&gt; inputStream = env.readTextFile(<span class="string">&quot;..\\resources\\sensor.txt&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// flatmap，按逗号分字段</span></span><br><span class="line">        DataStream&lt;String&gt; flatMapStream = inputStream.flatMap(<span class="keyword">new</span> FlatMapFunction&lt;String, String&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">flatMap</span><span class="params">(String value, Collector&lt;String&gt; out)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                String[] fields = value.split(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">                <span class="keyword">for</span>( String field: fields )</span><br><span class="line">                    out.collect(field);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 打印输出</span></span><br><span class="line">        flatMapStream.print(<span class="string">&quot;flatMap&quot;</span>);</span><br><span class="line"></span><br><span class="line">        env.execute();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">----------</span><br><span class="line">flatMap&gt; sensor_1</span><br><span class="line">flatMap&gt; <span class="number">1547718199</span></span><br><span class="line">flatMap&gt; <span class="number">35.8</span></span><br><span class="line">flatMap&gt; sensor_6</span><br><span class="line">flatMap&gt; <span class="number">1547718201</span></span><br><span class="line">flatMap&gt; <span class="number">15.4</span></span><br><span class="line">flatMap&gt; sensor_7</span><br><span class="line">flatMap&gt; <span class="number">1547718202</span></span><br><span class="line">flatMap&gt; <span class="number">6.7</span></span><br><span class="line">flatMap&gt; sensor_10</span><br><span class="line">flatMap&gt; <span class="number">1547718205</span></span><br><span class="line">flatMap&gt; <span class="number">38.1</span></span><br><span class="line">flatMap&gt; sensor_1</span><br><span class="line">flatMap&gt; <span class="number">1547718207</span></span><br><span class="line">flatMap&gt; <span class="number">36.3</span></span><br><span class="line">flatMap&gt; sensor_1</span><br><span class="line">flatMap&gt; <span class="number">1547718209</span></span><br><span class="line">flatMap&gt; <span class="number">32.8</span></span><br><span class="line">flatMap&gt; sensor_1</span><br><span class="line">flatMap&gt; <span class="number">1547718212</span></span><br><span class="line">flatMap&gt; <span class="number">37.1</span></span><br></pre></td></tr></table></figure>

<h3 id="filter"><a href="#filter" class="headerlink" title="filter"></a>filter</h3><p>过滤转换。</p>
<p><img src="https://heavenimmortal.oss-cn-chengdu.aliyuncs.com/img/363ccd8cba633a84616449e876258aab.png" alt="image-20201231140031077"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ts.flink;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.api.common.functions.FilterFunction;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.api.common.functions.FlatMapFunction;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.api.common.functions.MapFunction;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.datastream.DataStream;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.environment.StreamExecutionEnvironment;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.util.Collector;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TransformTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();</span><br><span class="line">        env.setParallelism(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 从文件读取数据</span></span><br><span class="line">        DataStream&lt;String&gt; inputStream = env.readTextFile(<span class="string">&quot;..\\resources\\sensor.txt&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// filter, 筛选sensor_1开头的id对应的数据</span></span><br><span class="line">        DataStream&lt;String&gt; filterStream = inputStream.filter(<span class="keyword">new</span> FilterFunction&lt;String&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">filter</span><span class="params">(String value)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> value.startsWith(<span class="string">&quot;sensor_1,&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 打印输出</span></span><br><span class="line">        filterStream.print(<span class="string">&quot;filter&quot;</span>);</span><br><span class="line"></span><br><span class="line">        env.execute();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">----------</span><br><span class="line">filter&gt; sensor_1,<span class="number">1547718199</span>,<span class="number">35.8</span></span><br><span class="line">filter&gt; sensor_1,<span class="number">1547718207</span>,<span class="number">36.3</span></span><br><span class="line">filter&gt; sensor_1,<span class="number">1547718209</span>,<span class="number">32.8</span></span><br><span class="line">filter&gt; sensor_1,<span class="number">1547718212</span>,<span class="number">37.1</span></span><br></pre></td></tr></table></figure>

<h3 id="KeyBy"><a href="#KeyBy" class="headerlink" title="KeyBy"></a>KeyBy</h3><p>分组转换。</p>
<p><img src="https://heavenimmortal.oss-cn-chengdu.aliyuncs.com/img/063f2254b608759b973f780b89b3346e.png" alt="image-20201231140440813"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ts.flink;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.datastream.DataStream;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.datastream.KeyedStream;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.environment.StreamExecutionEnvironment;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TransformTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();</span><br><span class="line">        env.setParallelism(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 从文件读取数据</span></span><br><span class="line">        DataStream&lt;String&gt; inputStream = env.readTextFile(<span class="string">&quot;..\\resources\\sensor.txt&quot;</span>);</span><br><span class="line"></span><br><span class="line">        DataStream&lt;SensorReading&gt; dataStream = inputStream.map( line -&gt; &#123;</span><br><span class="line">            String[] fields = line.split(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> SensorReading(fields[<span class="number">0</span>], <span class="keyword">new</span> Long(fields[<span class="number">1</span>]), <span class="keyword">new</span> Double(fields[<span class="number">2</span>]));</span><br><span class="line">        &#125; );</span><br><span class="line"></span><br><span class="line">        KeyedStream&lt;SensorReading, String&gt; keyedStream = dataStream.keyBy(data -&gt; data.getId());</span><br><span class="line"></span><br><span class="line">        keyedStream.print();</span><br><span class="line">        env.execute();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">----------</span><br><span class="line">SensorReading&#123;id=<span class="string">&#x27;sensor_1&#x27;</span>, timestamp=<span class="number">1547718199</span>, temperature=<span class="number">35.8</span>&#125;</span><br><span class="line">SensorReading&#123;id=<span class="string">&#x27;sensor_6&#x27;</span>, timestamp=<span class="number">1547718201</span>, temperature=<span class="number">15.4</span>&#125;</span><br><span class="line">SensorReading&#123;id=<span class="string">&#x27;sensor_7&#x27;</span>, timestamp=<span class="number">1547718202</span>, temperature=<span class="number">6.7</span>&#125;</span><br><span class="line">SensorReading&#123;id=<span class="string">&#x27;sensor_10&#x27;</span>, timestamp=<span class="number">1547718205</span>, temperature=<span class="number">38.1</span>&#125;</span><br><span class="line">SensorReading&#123;id=<span class="string">&#x27;sensor_1&#x27;</span>, timestamp=<span class="number">1547718207</span>, temperature=<span class="number">36.3</span>&#125;</span><br><span class="line">SensorReading&#123;id=<span class="string">&#x27;sensor_1&#x27;</span>, timestamp=<span class="number">1547718209</span>, temperature=<span class="number">32.8</span>&#125;</span><br><span class="line">SensorReading&#123;id=<span class="string">&#x27;sensor_1&#x27;</span>, timestamp=<span class="number">1547718212</span>, temperature=<span class="number">37.1</span>&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Rolling-Aggregation"><a href="#Rolling-Aggregation" class="headerlink" title="Rolling Aggregation"></a>Rolling Aggregation</h3><p>sum,max,min,maxby,minby。</p>
<p>都是常用的聚合操作，需要和KeyBy合用。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ts.flink;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.datastream.DataStream;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.datastream.KeyedStream;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.environment.StreamExecutionEnvironment;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TransformTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();</span><br><span class="line">        env.setParallelism(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 从文件读取数据</span></span><br><span class="line">        DataStream&lt;String&gt; inputStream = env.readTextFile(<span class="string">&quot;..\\resources\\sensor.txt&quot;</span>);</span><br><span class="line"></span><br><span class="line">        DataStream&lt;SensorReading&gt; dataStream = inputStream.map( line -&gt; &#123;</span><br><span class="line">            String[] fields = line.split(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> SensorReading(fields[<span class="number">0</span>], <span class="keyword">new</span> Long(fields[<span class="number">1</span>]), <span class="keyword">new</span> Double(fields[<span class="number">2</span>]));</span><br><span class="line">        &#125; );</span><br><span class="line"></span><br><span class="line">        KeyedStream&lt;SensorReading, String&gt; keyedStream = dataStream.keyBy(data -&gt; data.getId());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// sum</span></span><br><span class="line">        DataStream&lt;SensorReading&gt; sumStream = keyedStream.sum(<span class="string">&quot;temperature&quot;</span>);</span><br><span class="line">        sumStream.print(<span class="string">&quot;sum&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// max</span></span><br><span class="line">        DataStream&lt;SensorReading&gt; maxStream = keyedStream.max(<span class="string">&quot;temperature&quot;</span>);</span><br><span class="line">        maxStream.print(<span class="string">&quot;max&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// min</span></span><br><span class="line">        DataStream&lt;SensorReading&gt; minStream = keyedStream.min(<span class="string">&quot;temperature&quot;</span>);</span><br><span class="line">        minStream.print(<span class="string">&quot;min&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// maxBy</span></span><br><span class="line">        DataStream&lt;SensorReading&gt; maxByStream = keyedStream.maxBy(<span class="string">&quot;temperature&quot;</span>);</span><br><span class="line">        maxByStream.print(<span class="string">&quot;maxBy&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// minBy</span></span><br><span class="line">        DataStream&lt;SensorReading&gt; minByStream = keyedStream.minBy(<span class="string">&quot;temperature&quot;</span>);</span><br><span class="line">        minByStream.print(<span class="string">&quot;minBy&quot;</span>);</span><br><span class="line"></span><br><span class="line">        env.execute();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">----------</span><br><span class="line">sum&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_1&#x27;</span>, timestamp=<span class="number">1547718199</span>, temperature=<span class="number">35.8</span>&#125;</span><br><span class="line">sum&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_6&#x27;</span>, timestamp=<span class="number">1547718201</span>, temperature=<span class="number">15.4</span>&#125;</span><br><span class="line">sum&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_7&#x27;</span>, timestamp=<span class="number">1547718202</span>, temperature=<span class="number">6.7</span>&#125;</span><br><span class="line">sum&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_10&#x27;</span>, timestamp=<span class="number">1547718205</span>, temperature=<span class="number">38.1</span>&#125;</span><br><span class="line">sum&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_1&#x27;</span>, timestamp=<span class="number">1547718199</span>, temperature=<span class="number">72.1</span>&#125;</span><br><span class="line">sum&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_1&#x27;</span>, timestamp=<span class="number">1547718199</span>, temperature=<span class="number">104.9</span>&#125;</span><br><span class="line">sum&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_1&#x27;</span>, timestamp=<span class="number">1547718199</span>, temperature=<span class="number">142.0</span>&#125;</span><br><span class="line"></span><br><span class="line">max&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_1&#x27;</span>, timestamp=<span class="number">1547718199</span>, temperature=<span class="number">35.8</span>&#125;</span><br><span class="line">max&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_6&#x27;</span>, timestamp=<span class="number">1547718201</span>, temperature=<span class="number">15.4</span>&#125;</span><br><span class="line">max&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_7&#x27;</span>, timestamp=<span class="number">1547718202</span>, temperature=<span class="number">6.7</span>&#125;</span><br><span class="line">max&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_10&#x27;</span>, timestamp=<span class="number">1547718205</span>, temperature=<span class="number">38.1</span>&#125;</span><br><span class="line">max&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_1&#x27;</span>, timestamp=<span class="number">1547718199</span>, temperature=<span class="number">36.3</span>&#125;</span><br><span class="line">max&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_1&#x27;</span>, timestamp=<span class="number">1547718199</span>, temperature=<span class="number">36.3</span>&#125;</span><br><span class="line">max&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_1&#x27;</span>, timestamp=<span class="number">1547718199</span>, temperature=<span class="number">37.1</span>&#125;</span><br><span class="line"></span><br><span class="line">min&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_1&#x27;</span>, timestamp=<span class="number">1547718199</span>, temperature=<span class="number">35.8</span>&#125;</span><br><span class="line">min&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_6&#x27;</span>, timestamp=<span class="number">1547718201</span>, temperature=<span class="number">15.4</span>&#125;</span><br><span class="line">min&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_7&#x27;</span>, timestamp=<span class="number">1547718202</span>, temperature=<span class="number">6.7</span>&#125;</span><br><span class="line">min&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_10&#x27;</span>, timestamp=<span class="number">1547718205</span>, temperature=<span class="number">38.1</span>&#125;</span><br><span class="line">min&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_1&#x27;</span>, timestamp=<span class="number">1547718199</span>, temperature=<span class="number">35.8</span>&#125;</span><br><span class="line">min&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_1&#x27;</span>, timestamp=<span class="number">1547718199</span>, temperature=<span class="number">32.8</span>&#125;</span><br><span class="line">min&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_1&#x27;</span>, timestamp=<span class="number">1547718199</span>, temperature=<span class="number">32.8</span>&#125;</span><br><span class="line"></span><br><span class="line">maxBy&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_1&#x27;</span>, timestamp=<span class="number">1547718199</span>, temperature=<span class="number">35.8</span>&#125;</span><br><span class="line">maxBy&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_6&#x27;</span>, timestamp=<span class="number">1547718201</span>, temperature=<span class="number">15.4</span>&#125;</span><br><span class="line">maxBy&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_7&#x27;</span>, timestamp=<span class="number">1547718202</span>, temperature=<span class="number">6.7</span>&#125;</span><br><span class="line">maxBy&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_10&#x27;</span>, timestamp=<span class="number">1547718205</span>, temperature=<span class="number">38.1</span>&#125;</span><br><span class="line">maxBy&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_1&#x27;</span>, timestamp=<span class="number">1547718207</span>, temperature=<span class="number">36.3</span>&#125;</span><br><span class="line">maxBy&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_1&#x27;</span>, timestamp=<span class="number">1547718207</span>, temperature=<span class="number">36.3</span>&#125;</span><br><span class="line">maxBy&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_1&#x27;</span>, timestamp=<span class="number">1547718212</span>, temperature=<span class="number">37.1</span>&#125;</span><br><span class="line"></span><br><span class="line">minBy&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_1&#x27;</span>, timestamp=<span class="number">1547718199</span>, temperature=<span class="number">35.8</span>&#125;</span><br><span class="line">minBy&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_6&#x27;</span>, timestamp=<span class="number">1547718201</span>, temperature=<span class="number">15.4</span>&#125;</span><br><span class="line">minBy&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_7&#x27;</span>, timestamp=<span class="number">1547718202</span>, temperature=<span class="number">6.7</span>&#125;</span><br><span class="line">minBy&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_10&#x27;</span>, timestamp=<span class="number">1547718205</span>, temperature=<span class="number">38.1</span>&#125;</span><br><span class="line">minBy&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_1&#x27;</span>, timestamp=<span class="number">1547718199</span>, temperature=<span class="number">35.8</span>&#125;</span><br><span class="line">minBy&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_1&#x27;</span>, timestamp=<span class="number">1547718209</span>, temperature=<span class="number">32.8</span>&#125;</span><br><span class="line">minBy&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_1&#x27;</span>, timestamp=<span class="number">1547718209</span>, temperature=<span class="number">32.8</span>&#125;</span><br></pre></td></tr></table></figure>

<h3 id="reduce"><a href="#reduce" class="headerlink" title="reduce"></a>reduce</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ts.flink;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.api.common.functions.ReduceFunction;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.datastream.DataStream;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.datastream.KeyedStream;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.environment.StreamExecutionEnvironment;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TransformTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();</span><br><span class="line">        env.setParallelism(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 从文件读取数据</span></span><br><span class="line">        DataStream&lt;String&gt; inputStream = env.readTextFile(<span class="string">&quot;..\\resources\\sensor.txt&quot;</span>);</span><br><span class="line"></span><br><span class="line">        DataStream&lt;SensorReading&gt; dataStream = inputStream.map( line -&gt; &#123;</span><br><span class="line">            String[] fields = line.split(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> SensorReading(fields[<span class="number">0</span>], <span class="keyword">new</span> Long(fields[<span class="number">1</span>]), <span class="keyword">new</span> Double(fields[<span class="number">2</span>]));</span><br><span class="line">        &#125; );</span><br><span class="line"></span><br><span class="line">        KeyedStream&lt;SensorReading, String&gt; keyedStream = dataStream.keyBy(data -&gt; data.getId());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// reduce 聚合，取最小的温度值，并输出当前的时间戳</span></span><br><span class="line">        DataStream&lt;SensorReading&gt; reduceStream = keyedStream.reduce(<span class="keyword">new</span></span><br><span class="line">            ReduceFunction&lt;SensorReading&gt;() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> SensorReading <span class="title">reduce</span><span class="params">(SensorReading value1, SensorReading value2)</span></span></span><br><span class="line"><span class="function">                        <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">new</span> SensorReading(</span><br><span class="line">                            value1.getId(),</span><br><span class="line">                            value2.getTimestamp(),</span><br><span class="line">                            Math.min(value1.getTemperature(), value2.getTemperature()));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        reduceStream.print(<span class="string">&quot;reduce&quot;</span>);</span><br><span class="line"></span><br><span class="line">        env.execute();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">----------</span><br><span class="line"></span><br><span class="line">reduce&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_1&#x27;</span>, timestamp=<span class="number">1547718199</span>, temperature=<span class="number">35.8</span>&#125;</span><br><span class="line">reduce&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_6&#x27;</span>, timestamp=<span class="number">1547718201</span>, temperature=<span class="number">15.4</span>&#125;</span><br><span class="line">reduce&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_7&#x27;</span>, timestamp=<span class="number">1547718202</span>, temperature=<span class="number">6.7</span>&#125;</span><br><span class="line">reduce&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_10&#x27;</span>, timestamp=<span class="number">1547718205</span>, temperature=<span class="number">38.1</span>&#125;</span><br><span class="line">reduce&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_1&#x27;</span>, timestamp=<span class="number">1547718207</span>, temperature=<span class="number">35.8</span>&#125;</span><br><span class="line">reduce&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_1&#x27;</span>, timestamp=<span class="number">1547718209</span>, temperature=<span class="number">32.8</span>&#125;</span><br><span class="line">reduce&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_1&#x27;</span>, timestamp=<span class="number">1547718212</span>, temperature=<span class="number">32.8</span>&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Split-on-select"><a href="#Split-on-select" class="headerlink" title="Split on select"></a>Split on select</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ts.flink;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.collector.selector.OutputSelector;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.datastream.DataStream;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.datastream.SplitStream;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.environment.StreamExecutionEnvironment;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Collections;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TransformTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();</span><br><span class="line">        env.setParallelism(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 从文件读取数据</span></span><br><span class="line">        DataStream&lt;String&gt; inputStream = env.readTextFile(<span class="string">&quot;..\\resources\\sensor.txt&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 转换成SensorReading</span></span><br><span class="line">        DataStream&lt;SensorReading&gt; dataStream = inputStream.map(line -&gt; &#123;</span><br><span class="line">            String[] fields = line.split(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> SensorReading(fields[<span class="number">0</span>], <span class="keyword">new</span> Long(fields[<span class="number">1</span>]), <span class="keyword">new</span> Double(fields[<span class="number">2</span>]));</span><br><span class="line">        &#125; );</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 分流，按照温度值30度为界分为两条流</span></span><br><span class="line">        SplitStream&lt;SensorReading&gt; splitStream = dataStream.split(<span class="keyword">new</span> OutputSelector&lt;SensorReading&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> Iterable&lt;String&gt; <span class="title">select</span><span class="params">(SensorReading value)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> (value.getTemperature() &gt; <span class="number">30</span>) ? Collections.singletonList(<span class="string">&quot;high&quot;</span>) : Collections.singletonList(<span class="string">&quot;low&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        </span><br><span class="line">		<span class="comment">// 查询，查询不同的流</span></span><br><span class="line">        DataStream&lt;SensorReading&gt; highTempStream = splitStream.select(<span class="string">&quot;high&quot;</span>);</span><br><span class="line">        DataStream&lt;SensorReading&gt; lowTempStream = splitStream.select(<span class="string">&quot;low&quot;</span>);</span><br><span class="line">        DataStream&lt;SensorReading&gt; allTempStream = splitStream.select(<span class="string">&quot;high&quot;</span>, <span class="string">&quot;low&quot;</span>);</span><br><span class="line"></span><br><span class="line">        highTempStream.print(<span class="string">&quot;high&quot;</span>);</span><br><span class="line">        lowTempStream.print(<span class="string">&quot;low&quot;</span>);</span><br><span class="line">        allTempStream.print(<span class="string">&quot;all&quot;</span>);</span><br><span class="line"></span><br><span class="line">        env.execute();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">----------</span><br><span class="line">    </span><br><span class="line">high&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_1&#x27;</span>, timestamp=<span class="number">1547718199</span>, temperature=<span class="number">35.8</span>&#125;</span><br><span class="line">all&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_1&#x27;</span>, timestamp=<span class="number">1547718199</span>, temperature=<span class="number">35.8</span>&#125;</span><br><span class="line">all&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_6&#x27;</span>, timestamp=<span class="number">1547718201</span>, temperature=<span class="number">15.4</span>&#125;</span><br><span class="line">low&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_6&#x27;</span>, timestamp=<span class="number">1547718201</span>, temperature=<span class="number">15.4</span>&#125;</span><br><span class="line">all&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_7&#x27;</span>, timestamp=<span class="number">1547718202</span>, temperature=<span class="number">6.7</span>&#125;</span><br><span class="line">low&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_7&#x27;</span>, timestamp=<span class="number">1547718202</span>, temperature=<span class="number">6.7</span>&#125;</span><br><span class="line">high&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_10&#x27;</span>, timestamp=<span class="number">1547718205</span>, temperature=<span class="number">38.1</span>&#125;</span><br><span class="line">all&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_10&#x27;</span>, timestamp=<span class="number">1547718205</span>, temperature=<span class="number">38.1</span>&#125;</span><br><span class="line">high&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_1&#x27;</span>, timestamp=<span class="number">1547718207</span>, temperature=<span class="number">36.3</span>&#125;</span><br><span class="line">all&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_1&#x27;</span>, timestamp=<span class="number">1547718207</span>, temperature=<span class="number">36.3</span>&#125;</span><br><span class="line">high&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_1&#x27;</span>, timestamp=<span class="number">1547718209</span>, temperature=<span class="number">32.8</span>&#125;</span><br><span class="line">all&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_1&#x27;</span>, timestamp=<span class="number">1547718209</span>, temperature=<span class="number">32.8</span>&#125;</span><br><span class="line">high&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_1&#x27;</span>, timestamp=<span class="number">1547718212</span>, temperature=<span class="number">37.1</span>&#125;</span><br><span class="line">all&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_1&#x27;</span>, timestamp=<span class="number">1547718212</span>, temperature=<span class="number">37.1</span>&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Connect-on-CoMap"><a href="#Connect-on-CoMap" class="headerlink" title="Connect on CoMap"></a><strong>Connect</strong> on CoMap</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ts.flink;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.collector.selector.OutputSelector;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.datastream.DataStream;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.datastream.SplitStream;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.environment.StreamExecutionEnvironment;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Collections;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TransformTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();</span><br><span class="line">        env.setParallelism(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 从文件读取数据</span></span><br><span class="line">        DataStream&lt;String&gt; inputStream = env.readTextFile(<span class="string">&quot;..\\resources\\sensor.txt&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 转换成SensorReading</span></span><br><span class="line">        DataStream&lt;SensorReading&gt; dataStream = inputStream.map(line -&gt; &#123;</span><br><span class="line">            String[] fields = line.split(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> SensorReading(fields[<span class="number">0</span>], <span class="keyword">new</span> Long(fields[<span class="number">1</span>]), <span class="keyword">new</span> Double(fields[<span class="number">2</span>]));</span><br><span class="line">        &#125; );</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 分流，按照温度值30度为界分为两条流</span></span><br><span class="line">        SplitStream&lt;SensorReading&gt; splitStream = dataStream.split(<span class="keyword">new</span> OutputSelector&lt;SensorReading&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> Iterable&lt;String&gt; <span class="title">select</span><span class="params">(SensorReading value)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> (value.getTemperature() &gt; <span class="number">30</span>) ? Collections.singletonList(<span class="string">&quot;high&quot;</span>) : Collections.singletonList(<span class="string">&quot;low&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        DataStream&lt;SensorReading&gt; highTempStream = splitStream.select(<span class="string">&quot;high&quot;</span>);</span><br><span class="line">        DataStream&lt;SensorReading&gt; lowTempStream = splitStream.select(<span class="string">&quot;low&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 合流 connect，将高温流转换成二元组类型，与低温流连接合并之后，输出状态信息</span></span><br><span class="line">        DataStream&lt;Tuple2&lt;String, Double&gt;&gt; warningStream = highTempStream.map(<span class="keyword">new</span> MapFunction&lt;SensorReading, Tuple2&lt;String, Double&gt;&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> Tuple2&lt;String, Double&gt; <span class="title">map</span><span class="params">(SensorReading value)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> Tuple2&lt;&gt;(value.getId(), value.getTemperature());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        ConnectedStreams&lt;Tuple2&lt;String, Double&gt;, SensorReading&gt; connectedStreams = warningStream.connect(lowTempStream);</span><br><span class="line"></span><br><span class="line">        DataStream&lt;Object&gt; resultStream = connectedStreams.map(<span class="keyword">new</span> CoMapFunction&lt;Tuple2&lt;String, Double&gt;, SensorReading, Object&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> Object <span class="title">map1</span><span class="params">(Tuple2&lt;String, Double&gt; value)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> Tuple3&lt;&gt;(value.f0, value.f1, <span class="string">&quot;high temp warning&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> Object <span class="title">map2</span><span class="params">(SensorReading value)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> Tuple2&lt;&gt;(value.getId(), <span class="string">&quot;normal&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        warningStream.print(<span class="string">&quot;Connect&quot;</span>);</span><br><span class="line">        resultStream.print(<span class="string">&quot;CoMap&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        env.execute();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">----------</span><br><span class="line">    </span><br><span class="line">Connect&gt; (sensor_1,<span class="number">35.8</span>)</span><br><span class="line">Connect&gt; (sensor_10,<span class="number">38.1</span>)</span><br><span class="line">Connect&gt; (sensor_1,<span class="number">36.3</span>)</span><br><span class="line">Connect&gt; (sensor_1,<span class="number">32.8</span>)</span><br><span class="line">Connect&gt; (sensor_1,<span class="number">37.1</span>)</span><br><span class="line">CoMap&gt; (sensor_1,<span class="number">35.8</span>,high temp warning)</span><br><span class="line">CoMap&gt; (sensor_6,normal)</span><br><span class="line">CoMap&gt; (sensor_10,<span class="number">38.1</span>,high temp warning)</span><br><span class="line">CoMap&gt; (sensor_7,normal)</span><br><span class="line">CoMap&gt; (sensor_1,<span class="number">36.3</span>,high temp warning)</span><br><span class="line">CoMap&gt; (sensor_1,<span class="number">32.8</span>,high temp warning)</span><br><span class="line">CoMap&gt; (sensor_1,<span class="number">37.1</span>,high temp warning)</span><br></pre></td></tr></table></figure>

<h3 id="Union"><a href="#Union" class="headerlink" title="Union"></a>Union</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ts.flink;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.api.common.functions.MapFunction;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.api.java.tuple.Tuple2;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.api.java.tuple.Tuple3;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.collector.selector.OutputSelector;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.datastream.ConnectedStreams;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.datastream.DataStream;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.datastream.SplitStream;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.environment.StreamExecutionEnvironment;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.functions.co.CoMapFunction;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Collections;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TransformTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();</span><br><span class="line">        env.setParallelism(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 从文件读取数据</span></span><br><span class="line">        DataStream&lt;String&gt; inputStream = env.readTextFile(<span class="string">&quot;..\\resources\\sensor.txt&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 转换成SensorReading</span></span><br><span class="line">        DataStream&lt;SensorReading&gt; dataStream = inputStream.map(line -&gt; &#123;</span><br><span class="line">            String[] fields = line.split(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> SensorReading(fields[<span class="number">0</span>], <span class="keyword">new</span> Long(fields[<span class="number">1</span>]), <span class="keyword">new</span> Double(fields[<span class="number">2</span>]));</span><br><span class="line">        &#125; );</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 分流，按照温度值30度为界分为两条流</span></span><br><span class="line">        SplitStream&lt;SensorReading&gt; splitStream = dataStream.split(<span class="keyword">new</span> OutputSelector&lt;SensorReading&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> Iterable&lt;String&gt; <span class="title">select</span><span class="params">(SensorReading value)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> (value.getTemperature() &gt; <span class="number">30</span>) ? Collections.singletonList(<span class="string">&quot;high&quot;</span>) : Collections.singletonList(<span class="string">&quot;low&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        DataStream&lt;SensorReading&gt; highTempStream = splitStream.select(<span class="string">&quot;high&quot;</span>);</span><br><span class="line">        DataStream&lt;SensorReading&gt; lowTempStream = splitStream.select(<span class="string">&quot;low&quot;</span>);</span><br><span class="line">        DataStream&lt;SensorReading&gt; allTempStream = splitStream.select(<span class="string">&quot;high&quot;</span>, <span class="string">&quot;low&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3. union联合多条流</span></span><br><span class="line">        DataStream&lt;SensorReading&gt; unionStream = highTempStream.union(lowTempStream, allTempStream);</span><br><span class="line">        unionStream.print(<span class="string">&quot;union&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        env.execute();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">----------</span><br><span class="line"></span><br><span class="line">union&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_1&#x27;</span>, timestamp=<span class="number">1547718199</span>, temperature=<span class="number">35.8</span>&#125;</span><br><span class="line">union&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_10&#x27;</span>, timestamp=<span class="number">1547718205</span>, temperature=<span class="number">38.1</span>&#125;</span><br><span class="line">union&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_1&#x27;</span>, timestamp=<span class="number">1547718207</span>, temperature=<span class="number">36.3</span>&#125;</span><br><span class="line">union&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_1&#x27;</span>, timestamp=<span class="number">1547718209</span>, temperature=<span class="number">32.8</span>&#125;</span><br><span class="line">union&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_1&#x27;</span>, timestamp=<span class="number">1547718212</span>, temperature=<span class="number">37.1</span>&#125;</span><br><span class="line">union&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_6&#x27;</span>, timestamp=<span class="number">1547718201</span>, temperature=<span class="number">15.4</span>&#125;</span><br><span class="line">union&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_7&#x27;</span>, timestamp=<span class="number">1547718202</span>, temperature=<span class="number">6.7</span>&#125;</span><br><span class="line">union&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_1&#x27;</span>, timestamp=<span class="number">1547718199</span>, temperature=<span class="number">35.8</span>&#125;</span><br><span class="line">union&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_6&#x27;</span>, timestamp=<span class="number">1547718201</span>, temperature=<span class="number">15.4</span>&#125;</span><br><span class="line">union&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_7&#x27;</span>, timestamp=<span class="number">1547718202</span>, temperature=<span class="number">6.7</span>&#125;</span><br><span class="line">union&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_10&#x27;</span>, timestamp=<span class="number">1547718205</span>, temperature=<span class="number">38.1</span>&#125;</span><br><span class="line">union&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_1&#x27;</span>, timestamp=<span class="number">1547718207</span>, temperature=<span class="number">36.3</span>&#125;</span><br><span class="line">union&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_1&#x27;</span>, timestamp=<span class="number">1547718209</span>, temperature=<span class="number">32.8</span>&#125;</span><br><span class="line">union&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_1&#x27;</span>, timestamp=<span class="number">1547718212</span>, temperature=<span class="number">37.1</span>&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Sink"><a href="#Sink" class="headerlink" title="Sink"></a>Sink</h2><p>Flink 没有类似于 spark 中 foreach 方法，让用户进行迭代的操作。虽有对外的输出操作都要利用 Sink 完成。最后通过类似如下方式完成整个任务最终输出操作。</p>
<h3 id="Kafka"><a href="#Kafka" class="headerlink" title="Kafka"></a>Kafka</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ts.flink;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.api.common.serialization.SimpleStringSchema;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.datastream.DataStream;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.environment.StreamExecutionEnvironment;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.connectors.kafka.FlinkKafkaConsumer;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.connectors.kafka.FlinkKafkaProducer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Properties;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">KafkaConnector</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();</span><br><span class="line">        env.setParallelism(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        Properties properties = <span class="keyword">new</span> Properties();</span><br><span class="line">        properties.setProperty(<span class="string">&quot;bootstrap.servers&quot;</span>, <span class="string">&quot;192.168.110.110:9092&quot;</span>);</span><br><span class="line">        properties.setProperty(<span class="string">&quot;group.id&quot;</span>, <span class="string">&quot;consumer-group&quot;</span>);</span><br><span class="line">        properties.setProperty(<span class="string">&quot;key.deserializer&quot;</span>, <span class="string">&quot;org.apache.kafka.common.serialization.StringDeserializer&quot;</span>);</span><br><span class="line">        properties.setProperty(<span class="string">&quot;value.deserializer&quot;</span>, <span class="string">&quot;org.apache.kafka.common.serialization.StringDeserializer&quot;</span>);</span><br><span class="line">        properties.setProperty(<span class="string">&quot;auto.offset.reset&quot;</span>, <span class="string">&quot;latest&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 从kafka接受数据</span></span><br><span class="line">        DataStream&lt;String&gt; inputStream = env.addSource( <span class="keyword">new</span> FlinkKafkaConsumer&lt;String&gt;(<span class="string">&quot;sensor&quot;</span>, <span class="keyword">new</span> SimpleStringSchema(), properties));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 转换成SensorReading类型</span></span><br><span class="line">        DataStream&lt;String&gt; dataStream = inputStream.map(line -&gt; &#123;</span><br><span class="line">            String[] fields = line.split(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> SensorReading(fields[<span class="number">0</span>], <span class="keyword">new</span> Long(fields[<span class="number">1</span>]), <span class="keyword">new</span> Double(fields[<span class="number">2</span>])).toString();</span><br><span class="line">        &#125;);</span><br><span class="line">		</span><br><span class="line">        <span class="comment">// 输出到kafka</span></span><br><span class="line">        dataStream.addSink( <span class="keyword">new</span> FlinkKafkaProducer&lt;String&gt;(<span class="string">&quot;192.168.110.110:9092&quot;</span>, <span class="string">&quot;sinktest&quot;</span>, <span class="keyword">new</span> SimpleStringSchema()));</span><br><span class="line"></span><br><span class="line">        env.execute();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://heavenimmortal.oss-cn-chengdu.aliyuncs.com/img/a6d221abebc786de137857fae977eb13.png" alt="image-20210104155850424"></p>
<p><img src="https://heavenimmortal.oss-cn-chengdu.aliyuncs.com/img/42f607691af16502f616aa4125cf3122.png" alt="image-20210104160059014"></p>
<h3 id="Redis"><a href="#Redis" class="headerlink" title="Redis"></a>Redis</h3><p>导入jar包：flink-connector-redis_2.10-1.1.5.jar</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ts.flink;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.datastream.DataStream;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.environment.StreamExecutionEnvironment;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.connectors.redis.RedisSink;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.connectors.redis.common.config.FlinkJedisPoolConfig;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.connectors.redis.common.mapper.RedisCommand;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.connectors.redis.common.mapper.RedisCommandDescription;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.connectors.redis.common.mapper.RedisMapper;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RedisConnector</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();</span><br><span class="line">        env.setParallelism(<span class="number">1</span>);</span><br><span class="line">		<span class="comment">// 从文件读取数据</span></span><br><span class="line">        DataStream&lt;String&gt; inputStream = env.readTextFile(<span class="string">&quot;..\\resources\\sensor.txt&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 转换成SensorReading类型</span></span><br><span class="line">        DataStream&lt;SensorReading&gt; dataStream = inputStream.map(line -&gt; &#123;</span><br><span class="line">            String[] fields = line.split(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> SensorReading(fields[<span class="number">0</span>], <span class="keyword">new</span> Long(fields[<span class="number">1</span>]), <span class="keyword">new</span> Double(fields[<span class="number">2</span>]));</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 定义jedis连接配置</span></span><br><span class="line">        org.apache.flink.streaming.connectors.redis.common.config.FlinkJedisPoolConfig config = <span class="keyword">new</span> FlinkJedisPoolConfig.Builder()</span><br><span class="line">                .setHost(<span class="string">&quot;localhost&quot;</span>)</span><br><span class="line">                .setPort(<span class="number">6379</span>)</span><br><span class="line">                .build();</span><br><span class="line"></span><br><span class="line">        dataStream.addSink( <span class="keyword">new</span> RedisSink&lt;&gt;(config, <span class="keyword">new</span> MyRedisMapper()));</span><br><span class="line"></span><br><span class="line">        env.execute();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 自定义RedisMapper</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MyRedisMapper</span> <span class="keyword">implements</span> <span class="title">RedisMapper</span>&lt;<span class="title">SensorReading</span>&gt; </span>&#123;</span><br><span class="line">        <span class="comment">// 定义保存数据到redis的命令，存成Hash表，hset表类型 sensor_temp表名 id字段名 temperature字段名</span></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> RedisCommandDescription <span class="title">getCommandDescription</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> RedisCommandDescription(RedisCommand.HSET, <span class="string">&quot;sensor_temp&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">getKeyFromData</span><span class="params">(SensorReading data)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> data.getId();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">getValueFromData</span><span class="params">(SensorReading data)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> data.getTemperature().toString();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Elasticsearch"><a href="#Elasticsearch" class="headerlink" title="Elasticsearch"></a>Elasticsearch</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ts.flink;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.api.common.functions.RuntimeContext;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.datastream.DataStream;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.environment.StreamExecutionEnvironment;</span><br><span class="line"><span class="keyword">import</span> org.apache.http.HttpHost;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.action.index.IndexRequest;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.client.Requests;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EsConnector</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();</span><br><span class="line">        env.setParallelism(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 从文件读取数据</span></span><br><span class="line">        DataStream&lt;String&gt; inputStream = env.readTextFile(<span class="string">&quot;..\\resources\\sensor.txt&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 转换成SensorReading类型</span></span><br><span class="line">        DataStream&lt;SensorReading&gt; dataStream = inputStream.map(line -&gt; &#123;</span><br><span class="line">            String[] fields = line.split(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> SensorReading(fields[<span class="number">0</span>], <span class="keyword">new</span> Long(fields[<span class="number">1</span>]), <span class="keyword">new</span> Double(fields[<span class="number">2</span>]));</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 定义es的连接配置</span></span><br><span class="line">        ArrayList&lt;HttpHost&gt; httpHosts = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        httpHosts.add(<span class="keyword">new</span> HttpHost(<span class="string">&quot;localhost&quot;</span>, <span class="number">9200</span>));</span><br><span class="line"></span><br><span class="line">        dataStream.addSink(<span class="keyword">new</span> ElasticsearchSink.Builder&lt;SensorReading&gt;(httpHosts, <span class="keyword">new</span> MyEsSinkFunction()).build());</span><br><span class="line"></span><br><span class="line">        env.execute();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 实现自定义的ES写入操作</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MyEsSinkFunction</span> <span class="keyword">implements</span> <span class="title">ElasticsearchSinkFunction</span>&lt;<span class="title">SensorReading</span>&gt;</span>&#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">(SensorReading element, RuntimeContext ctx, RequestIndexer indexer)</span> </span>&#123;</span><br><span class="line">            <span class="comment">// 定义写入的数据source</span></span><br><span class="line">            HashMap&lt;String, String&gt; dataSource = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">            dataSource.put(<span class="string">&quot;id&quot;</span>, element.getId());</span><br><span class="line">            dataSource.put(<span class="string">&quot;temp&quot;</span>, element.getTemperature().toString());</span><br><span class="line">            dataSource.put(<span class="string">&quot;ts&quot;</span>, element.getTimestamp().toString());</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 创建请求，作为向es发起的写入命令</span></span><br><span class="line">            IndexRequest indexRequest = Requests.indexRequest()</span><br><span class="line">                    .index(<span class="string">&quot;sensor&quot;</span>)</span><br><span class="line">                    .type(<span class="string">&quot;readingdata&quot;</span>)</span><br><span class="line">                    .source(dataSource);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 用index发送请求</span></span><br><span class="line">            indexer.add(indexRequest);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="JDBC"><a href="#JDBC" class="headerlink" title="JDBC"></a>JDBC</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ts.flink;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.configuration.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.datastream.DataStream;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.environment.StreamExecutionEnvironment;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.functions.sink.RichSinkFunction;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.sql.Connection;</span><br><span class="line"><span class="keyword">import</span> java.sql.DriverManager;</span><br><span class="line"><span class="keyword">import</span> java.sql.PreparedStatement;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JdbcConnector</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();</span><br><span class="line">        env.setParallelism(<span class="number">1</span>);</span><br><span class="line">        </span><br><span class="line">        DataStream&lt;SensorReading&gt; dataStream = env.addSource(<span class="keyword">new</span> SourceTest.MySensorSource());</span><br><span class="line"></span><br><span class="line">        dataStream.addSink(<span class="keyword">new</span> MyJdbcSink());</span><br><span class="line"></span><br><span class="line">        env.execute();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 实现自定义的SinkFunction</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MyJdbcSink</span> <span class="keyword">extends</span> <span class="title">RichSinkFunction</span>&lt;<span class="title">SensorReading</span>&gt; </span>&#123;</span><br><span class="line">        <span class="comment">// 声明连接和预编译语句</span></span><br><span class="line">        Connection connection = <span class="keyword">null</span>;</span><br><span class="line">        PreparedStatement insertStmt = <span class="keyword">null</span>;</span><br><span class="line">        PreparedStatement updateStmt = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">open</span><span class="params">(Configuration parameters)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">            connection = DriverManager.getConnection(<span class="string">&quot;jdbc:mysql://localhost:3306/test&quot;</span>, <span class="string">&quot;root&quot;</span>, <span class="string">&quot;123456&quot;</span>);</span><br><span class="line">            insertStmt = connection.prepareStatement(<span class="string">&quot;insert into sensor_temp (id, temp) values (?, ?)&quot;</span>);</span><br><span class="line">            updateStmt = connection.prepareStatement(<span class="string">&quot;update sensor_temp set temp = ? where id = ?&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 每来一条数据，调用连接，执行sql</span></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">invoke</span><span class="params">(SensorReading value, Context context)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">            <span class="comment">// 直接执行更新语句，如果没有更新那么就插入</span></span><br><span class="line">            updateStmt.setDouble(<span class="number">1</span>, value.getTemperature());</span><br><span class="line">            updateStmt.setString(<span class="number">2</span>, value.getId());</span><br><span class="line">            updateStmt.execute();</span><br><span class="line">            <span class="keyword">if</span>( updateStmt.getUpdateCount() == <span class="number">0</span> )&#123;</span><br><span class="line">                insertStmt.setString(<span class="number">1</span>, value.getId());</span><br><span class="line">                insertStmt.setDouble(<span class="number">2</span>, value.getTemperature());</span><br><span class="line">                insertStmt.execute();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">            insertStmt.close();</span><br><span class="line">            updateStmt.close();</span><br><span class="line">            connection.close();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="window-API"><a href="#window-API" class="headerlink" title="window API"></a>window API</h1><h2 id="window概念"><a href="#window概念" class="headerlink" title="window概念"></a>window概念</h2><h3 id="窗口（window）"><a href="#窗口（window）" class="headerlink" title="窗口（window）"></a>窗口（window）</h3><p><img src="https://heavenimmortal.oss-cn-chengdu.aliyuncs.com/img/image-20210211105120180.png" alt="image-20210211105120180"></p>
<p>• 一般真实的流都是无界的，怎样处理无界的数据？ </p>
<p>• 可以把无限的数据流进行切分，得到有限的数据集进行处理 —— 也 就是得到有界流 </p>
<p>• 窗口（window）就是将无限流切割为有限流的一种方式，它会将流 数据分发到有限大小的桶（bucket）中进行分析</p>
<h2 id="window类型"><a href="#window类型" class="headerlink" title="window类型"></a>window类型</h2><p>• 时间窗口（Time Window）</p>
<p> ➢ 滚动时间窗口 </p>
<p>➢ 滑动时间窗口 </p>
<p>➢ 会话窗口 </p>
<p>• 计数窗口（Count Window） </p>
<p>➢ 滚动计数窗口 </p>
<p>➢ 滑动计数窗口</p>
<h3 id="滚动窗口（Tumbling-Windows）"><a href="#滚动窗口（Tumbling-Windows）" class="headerlink" title="滚动窗口（Tumbling Windows）"></a>滚动窗口（Tumbling Windows）</h3><p><img src="https://heavenimmortal.oss-cn-chengdu.aliyuncs.com/img/image-20210211105308382.png" alt="image-20210211105308382"></p>
<p>• 将数据依据固定的窗口长度对数据进行切分 </p>
<p>• 时间对齐，窗口长度固定，没有重叠</p>
<h3 id="滑动窗口（Sliding-Windows）"><a href="#滑动窗口（Sliding-Windows）" class="headerlink" title="滑动窗口（Sliding Windows）"></a>滑动窗口（Sliding Windows）</h3><p><img src="https://heavenimmortal.oss-cn-chengdu.aliyuncs.com/img/image-20210211105346374.png" alt="image-20210211105346374"></p>
<p>• 滑动窗口是固定窗口的更广义的一种形式，滑动窗口由固定的窗口 长度和滑动间隔组成</p>
<p> • 窗口长度固定，可以有重叠</p>
<h3 id="会话窗口（Session-Windows）"><a href="#会话窗口（Session-Windows）" class="headerlink" title="会话窗口（Session Windows）"></a>会话窗口（Session Windows）</h3><p><img src="https://heavenimmortal.oss-cn-chengdu.aliyuncs.com/img/image-20210211105422109.png" alt="image-20210211105422109"></p>
<p>• 由一系列事件组合一个指定时间长度的 timeout 间隙组成，也就 是一段时间没有接收到新数据就会生成新的窗口 </p>
<p>• 特点：时间无对齐</p>
<h2 id="window-API-1"><a href="#window-API-1" class="headerlink" title="window API"></a>window API</h2><p>• 窗口分配器 —— window() 方法 </p>
<p>➢ 我们可以用 .window() 来定义一个窗口，然后基于这个 window 去做一些聚 合或者其它处理操作。注意 window () 方法必须在 keyBy 之后才能用。 </p>
<p>➢ Flink 提供了更加简单的 .timeWindow 和 .countWindow 方法，用于定义 时间窗口和计数窗口。</p>
<p><img src="https://heavenimmortal.oss-cn-chengdu.aliyuncs.com/img/image-20210211105520629.png" alt="image-20210211105520629"></p>
<h2 id="窗口分配器（window-assigner）"><a href="#窗口分配器（window-assigner）" class="headerlink" title="窗口分配器（window assigner）"></a>窗口分配器（window assigner）</h2><p>• window() 方法接收的输入参数是一个 WindowAssigner </p>
<p>• WindowAssigner 负责将每条输入的数据分发到正确的 window 中</p>
<p> • Flink 提供了通用的 WindowAssigner</p>
<p> ➢ 滚动窗口（tumbling window）</p>
<p> ➢ 滑动窗口（sliding window）</p>
<p> ➢ 会话窗口（session window）</p>
<p> ➢ 全局窗口（global window）</p>
<h2 id="创建不同类型的窗口"><a href="#创建不同类型的窗口" class="headerlink" title="创建不同类型的窗口"></a>创建不同类型的窗口</h2><p>• 滚动时间窗口（tumbling time window）</p>
<p><img src="https://heavenimmortal.oss-cn-chengdu.aliyuncs.com/img/image-20210211105639638.png" alt="image-20210211105639638"></p>
<p> • 滑动时间窗口（sliding time window）</p>
<p><img src="https://heavenimmortal.oss-cn-chengdu.aliyuncs.com/img/image-20210211105648981.png" alt="image-20210211105648981"></p>
<p> • 会话窗口（session window）</p>
<p><img src="https://heavenimmortal.oss-cn-chengdu.aliyuncs.com/img/image-20210211105700468.png" alt="image-20210211105700468"></p>
<p>• 滚动计数窗口（tumbling count window） </p>
<p><img src="https://heavenimmortal.oss-cn-chengdu.aliyuncs.com/img/image-20210211105803908.png" alt="image-20210211105803908"></p>
<p>• 滑动计数窗口（sliding count window）</p>
<p><img src="https://heavenimmortal.oss-cn-chengdu.aliyuncs.com/img/image-20210211105812517.png" alt="image-20210211105812517"></p>
<h2 id="窗口函数（window-function）"><a href="#窗口函数（window-function）" class="headerlink" title="窗口函数（window function）"></a>窗口函数（window function）</h2><p>• window function 定义了要对窗口中收集的数据做的计算操作</p>
<p> • 可以分为两类 </p>
<p>➢ 增量聚合函数（incremental aggregation functions） </p>
<p>• 每条数据到来就进行计算，保持一个简单的状态 </p>
<p>• ReduceFunction, AggregateFunction</p>
<p> ➢ 全窗口函数（full window functions）</p>
<p> • 先把窗口所有数据收集起来，等到计算的时候会遍历所有数据</p>
<p> • ProcessWindowFunction，WindowFunction</p>
<h2 id="其它可选-API"><a href="#其它可选-API" class="headerlink" title="其它可选 API"></a>其它可选 API</h2><p>• .trigger() —— 触发器 </p>
<p>➢ 定义 window 什么时候关闭，触发计算并输出结果 </p>
<p>• .evictor() —— 移除器 </p>
<p>➢ 定义移除某些数据的逻辑</p>
<p> • .allowedLateness() —— 允许处理迟到的数据 </p>
<p>• .sideOutputLateData() —— 将迟到的数据放入侧输出流</p>
<p> • .getSideOutput() —— 获取侧输出流</p>
<h1 id="Flink-中的-时间语义和-watermark"><a href="#Flink-中的-时间语义和-watermark" class="headerlink" title="Flink 中的 时间语义和 watermark"></a>Flink 中的 时间语义和 watermark</h1><h2 id="Flink-中的时间语义"><a href="#Flink-中的时间语义" class="headerlink" title="Flink 中的时间语义"></a>Flink 中的时间语义</h2><p><img src="https://heavenimmortal.oss-cn-chengdu.aliyuncs.com/img/image-20210211125329491.png" alt="image-20210211125329491"></p>
<p>• Event Time：事件创建的时间 </p>
<p>• Ingestion Time：数据进入Flink的时间 </p>
<p>• Processing Time：执行操作算子的本地系统时间，与机器相关</p>
<blockquote>
<p>哪种时间语义更重要</p>
</blockquote>
<p><img src="https://heavenimmortal.oss-cn-chengdu.aliyuncs.com/img/image-20210211135151112.png" alt="image-20210211135151112"></p>
<p>• 不同的时间语义有不同的应用场合 </p>
<p>• 我们往往更关心事件时间（Event Time）</p>
<p><img src="https://heavenimmortal.oss-cn-chengdu.aliyuncs.com/img/image-20210211135225595.png" alt="image-20210211135225595"></p>
<p>• 某些应用场合，不应该使用 Processing Time </p>
<p>• Event Time 可以从日志数据的时间戳（timestamp）中提取 ➢ 2017-11-02 18:37:15.624 INFO Fail over to rm</p>
<h2 id="在代码中设置-Event-Time"><a href="#在代码中设置-Event-Time" class="headerlink" title="在代码中设置 Event Time"></a>在代码中设置 Event Time</h2><p> • 我们可以直接在代码中，对执行环境调用 setStreamTimeCharacteristic 方法，设置流的时间特性</p>
<p> • 具体的时间，还需要从数据中提取时间戳（timestamp）</p>
<p><img src="https://heavenimmortal.oss-cn-chengdu.aliyuncs.com/img/image-20210211135316379.png" alt="image-20210211135316379"></p>
<h2 id="乱序数据的影响"><a href="#乱序数据的影响" class="headerlink" title="乱序数据的影响"></a>乱序数据的影响</h2><p><img src="https://heavenimmortal.oss-cn-chengdu.aliyuncs.com/img/image-20210211135333148.png" alt="image-20210211135333148"></p>
<p>• 当 Flink 以 Event Time 模式处理数据流时，它会根据数据里的时间戳来 处理基于时间的算子</p>
<p>• 由于网络、分布式等原因，会导致乱序数据的产生</p>
<p>• 乱序数据会让窗口计算不准确</p>
<h2 id="水位线（Watermark）"><a href="#水位线（Watermark）" class="headerlink" title="水位线（Watermark）"></a>水位线（Watermark）</h2><p>➢ 怎样避免乱序数据带来计算不正确？</p>
<p> ➢ 遇到一个时间戳达到了窗口关闭时间，不应该立刻触发窗口计算，而是等 待一段时间，等迟到的数据来了再关闭窗口 • Watermark 是一种衡量 Event Time 进展的机制，可以设定延迟触发</p>
<p> • Watermark 是用于处理乱序事件的，而正确的处理乱序事件，通常用 Watermark 机制结合 window 来实现； </p>
<p>• 数据流中的 Watermark 用于表示 timestamp 小于 Watermark 的数据， 都已经到达了，因此，window 的执行也是由 Watermark 触发的。</p>
<p> • watermark 用来让程序自己平衡延迟和结果正确性</p>
<blockquote>
<p>watermark 的特点</p>
</blockquote>
<p><img src="https://heavenimmortal.oss-cn-chengdu.aliyuncs.com/img/image-20210211135502739.png" alt="image-20210211135502739"></p>
<p>• watermark 是一条特殊的数据记录 </p>
<p>• watermark 必须单调递增，以确保任务的事件时间时钟在向前推进，而 不是在后退</p>
<p> • watermark 与数据的时间戳相关</p>
<blockquote>
<p>watermark 的传递</p>
</blockquote>
<p><img src="https://heavenimmortal.oss-cn-chengdu.aliyuncs.com/img/image-20210211135533341.png" alt="image-20210211135533341"></p>
<h2 id="watermark-的引入"><a href="#watermark-的引入" class="headerlink" title="watermark 的引入"></a>watermark 的引入</h2><p>• Event Time 的使用一定要指定数据源中的时间戳 </p>
<p>• 调用 assignTimestampAndWatermarks 方法，传入一个 BoundedOutOfOrdernessTimestampExtractor，就可以指定</p>
<p><img src="https://heavenimmortal.oss-cn-chengdu.aliyuncs.com/img/image-20210211135556728.png" alt="image-20210211135556728"></p>
<p>• 对于排好序的数据，不需要延迟触发，可以只指定时间戳就行了</p>
<p><img src="https://heavenimmortal.oss-cn-chengdu.aliyuncs.com/img/image-20210211135612628.png" alt="image-20210211135612628"></p>
<p>• Flink 暴露了 TimestampAssigner 接口供我们实现，使我们可以自定义 如何从事件数据中抽取时间戳和生成watermark</p>
<p><img src="https://heavenimmortal.oss-cn-chengdu.aliyuncs.com/img/image-20210211135628476.png" alt="image-20210211135628476"></p>
<p>➢ MyAssigner 可以有两种类型，都继承自 TimestampAssigner</p>
<h2 id="TimestampAssigner"><a href="#TimestampAssigner" class="headerlink" title="TimestampAssigner"></a>TimestampAssigner</h2><p>• 定义了抽取时间戳，以及生成 watermark 的方法，有两种类型</p>
<p> ➢ AssignerWithPeriodicWatermarks</p>
<p> • 周期性的生成 watermark：系统会周期性的将 watermark 插入到流中 </p>
<p>• 默认周期是200毫秒，可以使用 ExecutionConfig.setAutoWatermarkInterval() 方法进行设置</p>
<p> • 升序和前面乱序的处理 BoundedOutOfOrdernessTimestampExtractor， 都是基于周期性 watermark 的。 </p>
<p>➢ AssignerWithPunctuatedWatermarks</p>
<p> • 没有时间周期规律，可打断的生成 watermark</p>
<h2 id="watermark-的设定"><a href="#watermark-的设定" class="headerlink" title="watermark 的设定"></a>watermark 的设定</h2><p>• 在 Flink 中，watermark 由应用程序开发人员生成，这通常需要对相应 的领域有一定的了解 </p>
<p>• 如果watermark设置的延迟太久，收到结果的速度可能就会很慢，解决 办法是在水位线到达之前输出一个近似结果</p>
<p> • 而如果watermark到达得太早，则可能收到错误结果，不过 Flink 处理迟 到数据的机制可以解决这个问题</p>
<h1 id="状态管理"><a href="#状态管理" class="headerlink" title="状态管理"></a>状态管理</h1><h2 id="Flink-中的状态"><a href="#Flink-中的状态" class="headerlink" title="Flink 中的状态"></a>Flink 中的状态</h2><p><img src="https://heavenimmortal.oss-cn-chengdu.aliyuncs.com/img/image-20210211160618832.png" alt="image-20210211160618832"></p>
<p> 由一个任务维护，并且用来计算某个结果的所有数据，都属于这个任务的状 态</p>
<p> • 可以认为状态就是一个本地变量，可以被任务的业务逻辑访问</p>
<p> • Flink 会进行状态管理，包括状态一致性、故障处理以及高效存储和访问，以 便开发人员可以专注于应用程序的逻辑</p>
<p>• 在 Flink 中，状态始终与特定算子相关联 </p>
<p>• 为了使运行时的 Flink 了解算子的状态，算子需要预先注册其状态 </p>
<p>➢ 总的说来，有两种类型的状态：</p>
<p> • 算子状态（Operator State）</p>
<p> • 算子状态的作用范围限定为算子任务 </p>
<p>• 键控状态（Keyed State） </p>
<p>• 根据输入数据流中定义的键（key）来维护和访问</p>
<h2 id="算子状态（Operator-State）"><a href="#算子状态（Operator-State）" class="headerlink" title="算子状态（Operator State）"></a>算子状态（Operator State）</h2><p><img src="https://heavenimmortal.oss-cn-chengdu.aliyuncs.com/img/image-20210211160728464.png"></p>
<p>• 算子状态的作用范围限定为算子任务，由同一并行任务所处理的所有数据都 可以访问到相同的状态</p>
<p> • 状态对于同一子任务而言是共享的</p>
<p> • 算子状态不能由相同或不同算子的另一个子任务访问</p>
<h3 id="算子状态数据结构"><a href="#算子状态数据结构" class="headerlink" title="算子状态数据结构"></a>算子状态数据结构</h3><p>➢ 列表状态（List state） </p>
<p>• 将状态表示为一组数据的列表 </p>
<p>➢ 联合列表状态（Union list state）</p>
<p> • 也将状态表示为数据的列表。它与常规列表状态的区别在于，在发生故 障时，或者从保存点（savepoint）启动应用程序时如何恢复 </p>
<p>➢ 广播状态（Broadcast state）</p>
<p> • 如果一个算子有多项任务，而它的每项任务状态又都相同，那么这种特 殊情况最适合应用广播状态。</p>
<h2 id="键控状态（Keyed-State）"><a href="#键控状态（Keyed-State）" class="headerlink" title="键控状态（Keyed State）"></a>键控状态（Keyed State）</h2><p><img src="https://heavenimmortal.oss-cn-chengdu.aliyuncs.com/img/image-20210211161001782.png" alt="image-20210211161001782"></p>
<p>• 键控状态是根据输入数据流中定义的键（key）来维护和访问的 </p>
<p>• Flink 为每个 key 维护一个状态实例，并将具有相同键的所有数据，都分区到 同一个算子任务中，这个任务会维护和处理这个 key 对应的状态</p>
<p> • 当任务处理一条数据时，它会自动将状态的访问范围限定为当前数据的 key</p>
<h3 id="键控状态数据结构"><a href="#键控状态数据结构" class="headerlink" title="键控状态数据结构"></a>键控状态数据结构</h3><p>➢ 值状态（Value state）</p>
<p> • 将状态表示为单个的值 </p>
<p>➢ 列表状态（List state）</p>
<p> • 将状态表示为一组数据的列表 </p>
<p>➢ 映射状态（Map state）</p>
<p> • 将状态表示为一组 Key-Value 对</p>
<p> ➢ 聚合状态（Reducing state &amp; Aggregating State） </p>
<p>• 将状态表示为一个用于聚合操作的列表</p>
<h3 id="键控状态的使用"><a href="#键控状态的使用" class="headerlink" title="键控状态的使用"></a>键控状态的使用</h3><p>• 声明一个键控状态</p>
<p><img src="https://heavenimmortal.oss-cn-chengdu.aliyuncs.com/img/image-20210211161131414.png" alt="image-20210211161131414"></p>
<p>• 读取状态</p>
<p><img src="https://heavenimmortal.oss-cn-chengdu.aliyuncs.com/img/image-20210211161201944.png" alt="image-20210211161201944"></p>
<p>• 对状态赋值</p>
<p><img src="https://heavenimmortal.oss-cn-chengdu.aliyuncs.com/img/image-20210211161220697.png" alt="image-20210211161220697"></p>
<h2 id="状态后端（State-Backends）"><a href="#状态后端（State-Backends）" class="headerlink" title="状态后端（State Backends）"></a>状态后端（State Backends）</h2><p>• 每传入一条数据，有状态的算子任务都会读取和更新状态</p>
<p> • 由于有效的状态访问对于处理数据的低延迟至关重要，因此每个并行 任务都会在本地维护其状态，以确保快速的状态访问 </p>
<p>• 状态的存储、访问以及维护，由一个可插入的组件决定，这个组件就 叫做状态后端（state backend） </p>
<p>• 状态后端主要负责两件事：本地的状态管理，以及将检查点 （checkpoint）状态写入远程存储</p>
<h3 id="选择一个状态后端"><a href="#选择一个状态后端" class="headerlink" title="选择一个状态后端"></a>选择一个状态后端</h3><p>➢ MemoryStateBackend </p>
<p>• 内存级的状态后端，会将键控状态作为内存中的对象进行管理，将它们存储在 TaskManager 的 JVM 堆上，而将 checkpoint 存储在 JobManager 的内存 中 </p>
<p>• 特点：快速、低延迟，但不稳定 </p>
<p>➢ FsStateBackend </p>
<p>• 将 checkpoint 存到远程的持久化文件系统（FileSystem）上，而对于本地状 态，跟 MemoryStateBackend 一样，也会存在 TaskManager 的 JVM 堆上 </p>
<p>• 同时拥有内存级的本地访问速度，和更好的容错保证</p>
<p> ➢ RocksDBStateBackend</p>
<p> • 将所有状态序列化后，存入本地的 RocksDB 中存储。</p>
<h1 id="ProcessFunction-API（底层API）"><a href="#ProcessFunction-API（底层API）" class="headerlink" title="ProcessFunction API（底层API）"></a>ProcessFunction API（底层API）</h1><p>我们之前学习的转换算子是无法访问事件的时间戳信息和水位线信息的。而这在一些应用场景下，极为重要。例如MapFunction这样的map转换算子就无法访问时间戳或者当前事件的事件时间。</p>
<p>   基于此，DataStream API提供了一系列的Low-Level转换算子。可以访问时间戳、watermark以及注册定时事件。还可以输出特定的一些事件，例如超时事件等。              Process Function用来构建事件驱动的应用以及实现自定义的业务逻辑(使用之前的window函数和转换算子无法实现)。例如，Flink SQL就是使用Process Function实现的。</p>
<p>Flink提供了8个Process Function：</p>
<p>   •  ProcessFunction</p>
<p>   •  KeyedProcessFunction</p>
<p>   •  CoProcessFunction</p>
<p>   •  ProcessJoinFunction</p>
<p>   •  BroadcastProcessFunction</p>
<p>   •  KeyedBroadcastProcessFunction</p>
<p>   •  ProcessWindowFunction</p>
<p>   •  ProcessAllWindowFunction</p>
<h2 id="KeyedProcessFunction"><a href="#KeyedProcessFunction" class="headerlink" title="KeyedProcessFunction"></a>KeyedProcessFunction</h2><p>   这里我们重点介绍KeyedProcessFunction。</p>
<p>   KeyedProcessFunction用来操作KeyedStream。KeyedProcessFunction会处理流的每一个元素，输出为0个、1个或者多个元素。所有的Process Function都继承自RichFunction接口，所以都有open()、close()和getRuntimeContext()等方法。而KeyedProcessFunction[KEY, IN, OUT]还额外提供了两个方法:</p>
<p>   •  processElement(v: IN, ctx: Context, out: Collector[OUT]), 流中的每一个元素都会调用这个方法，调用结果将会放在Collector数据类型中输出。Context可以访问元素的时间戳，元素的key，以及TimerService时间服务。Context还可以将结果输出到别的流(side outputs)。</p>
<p>   •  onTimer(timestamp: Long, ctx: OnTimerContext, out: Collector[OUT])是一个回调函数。当之前注册的定时器触发时调用。参数timestamp为定时器所设定的触发的时间戳。Collector为输出结果的集合。OnTimerContext和processElement的Context参数一样，提供了上下文的一些信息，例如定时器触发的时间信息(事件时间或者处理时间)。</p>
<h2 id="TimerService-和-定时器（Timers）"><a href="#TimerService-和-定时器（Timers）" class="headerlink" title="TimerService 和 定时器（Timers）"></a>TimerService 和 定时器（Timers）</h2><p>   Context和OnTimerContext所持有的TimerService对象拥有以下方法:</p>
<p>   •  currentProcessingTime(): Long 返回当前处理时间</p>
<p>   •  currentWatermark(): Long 返回当前watermark的时间戳</p>
<p>   •  registerProcessingTimeTimer(timestamp: Long): Unit 会注册当前key的processing time的定时器。当processing time到达定时时间时，触发timer。</p>
<p>   •  registerEventTimeTimer(timestamp: Long): Unit 会注册当前key的event time 定时器。当水位线大于等于定时器注册的时间时，触发定时器执行回调函数。</p>
<p>   •  deleteProcessingTimeTimer(timestamp: Long): Unit 删除之前注册处理时间定时器。如果没有这个时间戳的定时器，则不执行。</p>
<p>   •  deleteEventTimeTimer(timestamp: Long): Unit 删除之前注册的事件时间定时器，如果没有此时间戳的定时器，则不执行。</p>
<p>   当定时器timer触发时，会执行回调函数onTimer()。注意定时器timer只能在keyed streams上面使用。</p>
<p>   下面举个例子说明KeyedProcessFunction如何操作KeyedStream。</p>
<p>   需求：监控温度传感器的温度值，如果温度值在一秒钟之内(processing time)连续上升，则报警。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">val warnings &#x3D; readings</span><br><span class="line">.keyBy(_.id)</span><br><span class="line">.process(new TempIncreaseAlertFunction)</span><br></pre></td></tr></table></figure>

<p>   看一下TempIncreaseAlertFunction如何实现, 程序中使用了ValueState这样一个状态变量。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">class TempIncreaseAlertFunction extends KeyedProcessFunction[String, SensorReading, String] &#123;</span><br><span class="line"></span><br><span class="line">  &#x2F;&#x2F; 保存上一个传感器温度值</span><br><span class="line">  lazy val lastTemp: ValueState[Double] &#x3D; getRuntimeContext.getState(</span><br><span class="line">  new ValueStateDescriptor[Double](&quot;lastTemp&quot;, Types.of[Double])</span><br><span class="line">  )</span><br><span class="line">  &#x2F;&#x2F; 保存注册的定时器的时间戳</span><br><span class="line"> lazy val currentTimer: ValueState[Long] &#x3D; getRuntimeContext.getState(</span><br><span class="line">    new ValueStateDescriptor[Long](&quot;timer&quot;, Types.of[Long])</span><br><span class="line">  )</span><br><span class="line">  override def processElement(r: SensorReading, ctx: KeyedProcessFunction[String, SensorReading, String]#Context, out: Collector[String]): Unit &#x3D; &#123;</span><br><span class="line">    &#x2F;&#x2F; 取出上一次的温度</span><br><span class="line">    val prevTemp &#x3D; lastTemp.value()</span><br><span class="line">    &#x2F;&#x2F; 将当前温度更新到上一次的温度这个变量中</span><br><span class="line">    lastTemp.update(r.temperature)</span><br><span class="line">    val curTimerTimestamp &#x3D; currentTimer.value()</span><br><span class="line">    if (prevTemp &#x3D;&#x3D; 0.0 || r.temperature &lt; prevTemp) &#123;</span><br><span class="line">      &#x2F;&#x2F; 温度下降或者是第一个温度值，删除定时器</span><br><span class="line">      ctx.timerService().deleteProcessingTimeTimer(curTimerTimestamp)</span><br><span class="line">      &#x2F;&#x2F; 清空状态变量</span><br><span class="line">      currentTimer.clear()</span><br><span class="line">    &#125; else if (r.temperature &gt; prevTemp &amp;&amp; curTimerTimestamp &#x3D;&#x3D; 0) &#123;</span><br><span class="line">      &#x2F;&#x2F; 温度上升且我们并没有设置定时器</span><br><span class="line">      val timerTs &#x3D; ctx.timerService().currentProcessingTime() + 1000</span><br><span class="line">      ctx.timerService().registerProcessingTimeTimer(timerTs)</span><br><span class="line">      currentTimer.update(timerTs)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  override def onTimer(ts: Long,</span><br><span class="line">                    ctx: KeyedProcessFunction[String, SensorReading, String]#OnTimerContext,</span><br><span class="line">             out: Collector[String]): Unit &#x3D; &#123;</span><br><span class="line">    out.collect(&quot;传感器id为: &quot; + ctx.getCurrentKey + &quot;的传感器温度值已经连续1s上升了。&quot;)</span><br><span class="line">    currentTimer.clear()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>3.侧输出流（SideOutput）</p>
<p>   大部分的DataStream API的算子的输出是单一输出，也就是某种数据类型的流。除了split算子，可以将一条流分成多条流，这些流的数据类型也都相同。process function的side outputs功能可以产生多条流，并且这些流的数据类型可以不一样。一个side output可以定义为OutputTag[X]对象，X是输出流的数据类型。process function可以通过Context对象发射一个事件到一个或者多个side outputs。   下面是一个示例程序：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">val monitoredReadings: DataStream[SensorReading] &#x3D; readings</span><br><span class="line">  .process(new FreezingMonitor)</span><br><span class="line">monitoredReadings</span><br><span class="line">  .getSideOutput(new OutputTag[String](&quot;freezing-alarms&quot;))</span><br><span class="line">  .print()</span><br><span class="line">readings.print()</span><br></pre></td></tr></table></figure>

<p>   接下来我们实现FreezingMonitor函数，用来监控传感器温度值，将温度值低于32F的温度输出到side output。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">class FreezingMonitor extends ProcessFunction[SensorReading, SensorReading] &#123;</span><br><span class="line">  &#x2F;&#x2F; 定义一个侧输出标签</span><br><span class="line">  lazy val freezingAlarmOutput: OutputTag[String] &#x3D;</span><br><span class="line">    new OutputTag[String](&quot;freezing-alarms&quot;)</span><br><span class="line">  override def processElement(r: SensorReading,</span><br><span class="line">                              ctx: ProcessFunction[SensorReading, SensorReading]#Context,</span><br><span class="line">               out: Collector[SensorReading]): Unit &#x3D; &#123;</span><br><span class="line">    &#x2F;&#x2F; 温度在32F以下时，输出警告信息</span><br><span class="line">    if (r.temperature &lt; 32.0) &#123;</span><br><span class="line">      ctx.output(freezingAlarmOutput, s&quot;Freezing Alarm for $&#123;r.id&#125;&quot;)</span><br><span class="line">    &#125;</span><br><span class="line">    &#x2F;&#x2F; 所有数据直接常规输出到主流</span><br><span class="line">    out.collect(r)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>4.CoProcessFunction</p>
<p>   对于两条输入流，DataStream API提供了CoProcessFunction这样的low-level操作。CoProcessFunction提供了操作每一个输入流的方法: processElement1()和processElement2()。</p>
<p>   类似于ProcessFunction，这两种方法都通过Context对象来调用。这个Context对象可以访问事件数据，定时器时间戳，TimerService，以及side outputs。CoProcessFunction也提供了onTimer()回调函数。</p>
<h1 id="容错机制"><a href="#容错机制" class="headerlink" title="容错机制"></a>容错机制</h1><h2 id="一致性检查点（checkpoint）"><a href="#一致性检查点（checkpoint）" class="headerlink" title="一致性检查点（checkpoint）"></a>一致性检查点（checkpoint）</h2><p><img src="https://heavenimmortal.oss-cn-chengdu.aliyuncs.com/img/image-20210211161423451.png" alt="image-20210211161423451"></p>
<p>• Flink 故障恢复机制的核心，就是应用状态的一致性检查点 </p>
<p>• 有状态流应用的一致检查点，其实就是所有任务的状态，在某个时间点的一份 拷贝（一份快照）；这个时间点，应该是所有任务都恰好处理完一个相同的输 入数据的时候</p>
<h2 id="从检查点恢复状态"><a href="#从检查点恢复状态" class="headerlink" title="从检查点恢复状态"></a>从检查点恢复状态</h2><p><img src="https://heavenimmortal.oss-cn-chengdu.aliyuncs.com/img/image-20210211161459417.png" alt="image-20210211161459417"></p>
<p>•在执行流应用程序期间，Flink 会定期保存状态的一致检查点</p>
<p> • 如果发生故障， Flink 将会使用最近的检查点来一致恢复应用程序的状态，并 重新启动处理流程</p>
<p>• 遇到故障之后，第一步就是重启应用</p>
<p><img src="https://heavenimmortal.oss-cn-chengdu.aliyuncs.com/img/image-20210211161822683.png" alt="image-20210211161822683"></p>
<p>• 第二步是从 checkpoint 中读取状态，将状态重置 </p>
<p>• 从检查点重新启动应用程序后，其内部状态与检查点完成时的状态完全相同</p>
<p><img src="https://heavenimmortal.oss-cn-chengdu.aliyuncs.com/img/image-20210211161853107.png" alt="image-20210211161853107"></p>
<p>• 第三步：开始消费并处理检查点到发生故障之间的所有数据</p>
<p> • 这种检查点的保存和恢复机制可以为应用程序状态提供“精确一次” （exactly-once）的一致性，因为所有算子都会保存检查点并恢复其所有状 态，这样一来所有的输入流就都会被重置到检查点完成时的位置</p>
<h2 id="检查点的实现算法"><a href="#检查点的实现算法" class="headerlink" title="检查点的实现算法"></a>检查点的实现算法</h2><p>• 一种简单的想法 </p>
<p>—— 暂停应用，保存状态到检查点，再重新恢复应用 </p>
<p>• Flink 的改进实现 —— 基于 Chandy-Lamport 算法的分布式快照 </p>
<p>—— 将检查点的保存和数据处理分离开，不暂停整个应用</p>
<h3 id="Flink-检查点算法"><a href="#Flink-检查点算法" class="headerlink" title="Flink 检查点算法"></a>Flink 检查点算法</h3><p>➢ 检查点分界线（Checkpoint Barrier）</p>
<p> • Flink 的检查点算法用到了一种称为分界线（barrier）的特殊数据形式， 用来把一条流上数据按照不同的检查点分开 </p>
<p>• 分界线之前到来的数据导致的状态更改，都会被包含在当前分界线所属 的检查点中；而基于分界线之后的数据导致的所有更改，就会被包含在 之后的检查点中</p>
<p><img src="https://heavenimmortal.oss-cn-chengdu.aliyuncs.com/img/image-20210211162030966.png" alt="image-20210211162030966"></p>
<p>• 现在是一个有两个输入流的应用程序，用并行的两个 Source 任务来读取</p>
<p><img src="https://heavenimmortal.oss-cn-chengdu.aliyuncs.com/img/image-20210211162047245.png" alt="image-20210211162047245"></p>
<p>• JobManager 会向每个 source 任务发送一条带有新检查点 ID 的消息，通过这 种方式来启动检查点</p>
<p><img src="https://heavenimmortal.oss-cn-chengdu.aliyuncs.com/img/image-20210211162102508.png" alt="image-20210211162102508"></p>
<p>• 数据源将它们的状态写入检查点，并发出一个检查点 barrier </p>
<p>• 状态后端在状态存入检查点之后，会返回通知给 source 任务，source 任务就会 向 JobManager 确认检查点完成</p>
<p><img src="https://heavenimmortal.oss-cn-chengdu.aliyuncs.com/img/image-20210211162123596.png" alt="image-20210211162123596"></p>
<p>• 分界线对齐：barrier 向下游传递，sum 任务会等待所有输入分区的 barrier 到 达</p>
<p> • 对于barrier已经到达的分区，继续到达的数据会被缓存</p>
<p> • 而barrier尚未到达的分区，数据会被正常处理</p>
<p><img src="https://heavenimmortal.oss-cn-chengdu.aliyuncs.com/img/image-20210211162153028.png" alt="image-20210211162153028"></p>
<p>• 当收到所有输入分区的 barrier 时，任务就将其状态保存到状态后端的检查点中， 然后将 barrier 继续向下游转发</p>
<p><img src="https://heavenimmortal.oss-cn-chengdu.aliyuncs.com/img/image-20210211162218883.png" alt="image-20210211162218883"></p>
<p>• 向下游转发检查点 barrier 后，任务继续正常的数据处理</p>
<p><img src="https://heavenimmortal.oss-cn-chengdu.aliyuncs.com/img/image-20210211162233203.png" alt="image-20210211162233203"></p>
<p>• Sink 任务向 JobManager 确认状态保存到 checkpoint 完毕</p>
<p> • 当所有任务都确认已成功将状态保存到检查点时，检查点就真正完成了</p>
<h2 id="保存点（Savepoints）"><a href="#保存点（Savepoints）" class="headerlink" title="保存点（Savepoints）"></a>保存点（Savepoints）</h2><p>• Flink 还提供了可以自定义的镜像保存功能，就是保存点（savepoints）</p>
<p> • 原则上，创建保存点使用的算法与检查点完全相同，因此保存点可以认 为就是具有一些额外元数据的检查点</p>
<p> • Flink不会自动创建保存点，因此用户（或者外部调度程序）必须明确地 触发创建操作 </p>
<p>• 保存点是一个强大的功能。除了故障恢复外，保存点可以用于：有计划 的手动备份，更新应用程序，版本迁移，暂停和重启应用，等等</p>
<h1 id="状态一致性"><a href="#状态一致性" class="headerlink" title="状态一致性"></a>状态一致性</h1><h2 id="状态一致性-1"><a href="#状态一致性-1" class="headerlink" title="状态一致性"></a>状态一致性</h2><blockquote>
<p>什么是状态一致性</p>
</blockquote>
<p><img src="https://heavenimmortal.oss-cn-chengdu.aliyuncs.com/img/image-20210211233440607.png" alt="image-20210211233440607"></p>
<p>• 有状态的流处理，内部每个算子任务都可以有自己的状态</p>
<p> • 对于流处理器内部来说，所谓的状态一致性，其实就是我们所说的计 算结果要保证准确。</p>
<p> • 一条数据不应该丢失，也不应该重复计算</p>
<p> • 在遇到故障时可以恢复状态，恢复以后的重新计算，结果应该也是完 全正确的。</p>
<blockquote>
<p>状态一致性分类</p>
</blockquote>
<p>• AT-MOST-ONCE（最多一次）</p>
<p>➢ 当任务故障时，最简单的做法是什么都不干，既不恢复丢失的状态，也不重 播丢失的数据。At-most-once 语义的含义是最多处理一次事件。</p>
<p> • AT-LEAST-ONCE（至少一次） </p>
<p>➢ 在大多数的真实应用场景，我们希望不丢失事件。这种类型的保障称为 atleast-once，意思是所有的事件都得到了处理，而一些事件还可能被处理多 次。 </p>
<p>• EXACTLY-ONCE（精确一次）</p>
<p> ➢ 恰好处理一次是最严格的保证，也是最难实现的。恰好处理一次语义不仅仅 意味着没有事件丢失，还意味着针对每一个数据，内部状态仅仅更新一次。</p>
<h2 id="一致性检查点（checkpoint）-1"><a href="#一致性检查点（checkpoint）-1" class="headerlink" title="一致性检查点（checkpoint）"></a>一致性检查点（checkpoint）</h2><p>• Flink 使用了一种轻量级快照机制 —— 检查点（checkpoint）来保 证 exactly-once 语义 </p>
<p>• 有状态流应用的一致检查点，其实就是：所有任务的状态，在某个时 间点的一份拷贝（一份快照）。而这个时间点，应该是所有任务都恰 好处理完一个相同的输入数据的时候。 </p>
<p>• 应用状态的一致检查点，是 Flink 故障恢复机制的核心</p>
<p><img src="https://heavenimmortal.oss-cn-chengdu.aliyuncs.com/img/image-20210211233618880.png" alt="image-20210211233618880"></p>
<h2 id="端到端（end-to-end）状态一致性"><a href="#端到端（end-to-end）状态一致性" class="headerlink" title="端到端（end-to-end）状态一致性"></a>端到端（end-to-end）状态一致性</h2><p>• 目前我们看到的一致性保证都是由流处理器实现的，也就是说都是在 Flink 流处理器内部保证的；而在真实应用中，流处理应用除了流处 理器以外还包含了数据源（例如 Kafka）和输出到持久化系统</p>
<p> • 端到端的一致性保证，意味着结果的正确性贯穿了整个流处理应用的 始终；每一个组件都保证了它自己的一致性 </p>
<p>• 整个端到端的一致性级别取决于所有组件中一致性最弱的组件</p>
<h2 id="端到端的精确一次（exactly-once）保证"><a href="#端到端的精确一次（exactly-once）保证" class="headerlink" title="端到端的精确一次（exactly-once）保证"></a>端到端的精确一次（exactly-once）保证</h2><p>内部保证 —— checkpoint</p>
<p> • source 端 —— 可重设数据的读取位置 </p>
<p>• sink 端 —— 从故障恢复时，数据不会重复写入外部系统 </p>
<p>➢ 幂等写入</p>
<p> ➢ 事务写入</p>
<h3 id="幂等写入（Idempotent-Writes）"><a href="#幂等写入（Idempotent-Writes）" class="headerlink" title="幂等写入（Idempotent Writes）"></a>幂等写入（Idempotent Writes）</h3><p>所谓幂等操作，是说一个操作，可以重复执行很多次，但只导致一次 结果更改，也就是说，后面再重复执行就不起作用了</p>
<p><img src="https://heavenimmortal.oss-cn-chengdu.aliyuncs.com/img/image-20210211233753354.png" alt="image-20210211233753354"></p>
<h3 id="事务写入（Transactional-Writes）"><a href="#事务写入（Transactional-Writes）" class="headerlink" title="事务写入（Transactional Writes）"></a>事务写入（Transactional Writes）</h3><p>• 事务（Transaction） </p>
<p>➢ 应用程序中一系列严密的操作，所有操作必须成功完成，否则在每个操作中所 作的所有更改都会被撤消</p>
<p> ➢ 具有原子性：一个事务中的一系列的操作要么全部成功，要么一个都不做 </p>
<p>• 实现思想：构建的事务对应着 checkpoint，等到 checkpoint 真正完成 的时候，才把所有对应的结果写入 sink 系统中 </p>
<p>• 实现方式 </p>
<blockquote>
<p>预写日志</p>
</blockquote>
<p>把结果数据先当成状态保存，然后在收到 checkpoint 完成的通知时， 一次性写入 sink 系统</p>
<p> • 简单易于实现，由于数据提前在状态后端中做了缓存，所以无论什么 sink 系统，都能用这种方式一批搞定</p>
<p> • DataStream API 提供了一个模板类：GenericWriteAheadSink，来 实现这种事务性 sink </p>
<blockquote>
<p>两阶段提交</p>
</blockquote>
<p>• 对于每个 checkpoint，sink 任务会启动一个事务，并将接下来所有 接收的数据添加到事务里</p>
<p> • 然后将这些数据写入外部 sink 系统，但不提交它们 —— 这时只是 “预提交” </p>
<p>• 当它收到 checkpoint 完成的通知时，它才正式提交事务，实现结果 的真正写入 </p>
<p>➢ 这种方式真正实现了 exactly-once，它需要一个提供事务支持的外部 sink 系统。Flink 提供了 TwoPhaseCommitSinkFunction 接口。</p>
<blockquote>
<p>2PC 对外部 sink 系统的要求</p>
</blockquote>
<p>• 外部 sink 系统必须提供事务支持，或者 sink 任务必须能够模拟外部系 统上的事务</p>
<p> • 在 checkpoint 的间隔期间里，必须能够开启一个事务并接受数据写入 </p>
<p>• 在收到 checkpoint 完成的通知之前，事务必须是“等待提交”的状态。 在故障恢复的情况下，这可能需要一些时间。如果这个时候sink系统关 闭事务（例如超时了），那么未提交的数据就会丢失 </p>
<p>• sink 任务必须能够在进程失败后恢复事务 </p>
<p>• 提交事务必须是幂等操作</p>
<p><img src="https://heavenimmortal.oss-cn-chengdu.aliyuncs.com/img/image-20210212113831513.png" alt="image-20210212113831513"></p>
<h2 id="Flink-Kafka-端到端状态一致性的保证"><a href="#Flink-Kafka-端到端状态一致性的保证" class="headerlink" title="Flink+Kafka 端到端状态一致性的保证"></a>Flink+Kafka 端到端状态一致性的保证</h2><p>• 内部 —— 利用 checkpoint 机制，把状态存盘，发生故障的时候可以恢 复，保证内部的状态一致性</p>
<p> • source —— kafka consumer 作为 source，可以将偏移量保存下来， 如果后续任务出现了故障，恢复的时候可以由连接器重置偏移量，重新 消费数据，保证一致性</p>
<p> • sink —— kafka producer 作为sink，采用两阶段提交 sink，需要实现 一个 TwoPhaseCommitSinkFunction</p>
<h1 id="Table-API-和-Flink-SQL"><a href="#Table-API-和-Flink-SQL" class="headerlink" title="Table API 和 Flink SQL"></a>Table API 和 Flink SQL</h1><blockquote>
<p>Table API 和 Flink SQL 是什么</p>
</blockquote>
<p>• Flink 对批处理和流处理，提供了统一的上层 API </p>
<p>• Table API 是一套内嵌在 Java 和 Scala 语言中的查询API，它允许以非常直 观的方式组合来自一些关系运算符的查询</p>
<p> • Flink 的 SQL 支持基于实现了 SQL 标准的 Apache Calcite</p>
<p><img src="https://heavenimmortal.oss-cn-chengdu.aliyuncs.com/img/image-20210212123243519.png" alt="image-20210212123243519"></p>
<h2 id="基本程序结构"><a href="#基本程序结构" class="headerlink" title="基本程序结构"></a>基本程序结构</h2><p>Table API 和 SQL 的程序结构，与流式处理的程序结构十分类似</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">StreamTableEnvironment tableEnv &#x3D; ... &#x2F;&#x2F; 创建表的执行环境</span><br><span class="line">&#x2F;&#x2F; 创建一张表，用于读取数据</span><br><span class="line">tableEnv.connect(...).createTemporaryTable(&quot;inputTable&quot;);</span><br><span class="line">&#x2F;&#x2F; 注册一张表，用于把计算结果输出</span><br><span class="line">tableEnv.connect(...).createTemporaryTable(&quot;outputTable&quot;);</span><br><span class="line">&#x2F;&#x2F; 通过 Table API 查询算子，得到一张结果表</span><br><span class="line">Table result &#x3D; tableEnv.from(&quot;inputTable&quot;).select(...);</span><br><span class="line">&#x2F;&#x2F; 通过 SQL查询语句，得到一张结果表</span><br><span class="line">Table sqlResult &#x3D; tableEnv.sqlQuery(&quot;SELECT ... FROM inputTable ...&quot;);</span><br><span class="line">&#x2F;&#x2F; 将结果表写入输出表中</span><br><span class="line">result.insertInto(&quot;outputTable&quot;);</span><br></pre></td></tr></table></figure>

<h3 id="创建-TableEnvironment"><a href="#创建-TableEnvironment" class="headerlink" title="创建 TableEnvironment"></a>创建 TableEnvironment</h3><p>创建表的执行环境，需要将 flink 流处理的执行环境传入 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">StreamTableEnvironment tableEnv &#x3D; StreamTableEnvironment.create(env); </span><br></pre></td></tr></table></figure>

<p>• TableEnvironment 是 flink 中集成 Table API 和 SQL 的核心概念，所有对 表的操作都基于 TableEnvironment</p>
<p> – 注册 Catalog</p>
<p> – 在 Catalog 中注册表 </p>
<p>– 执行 SQL 查询</p>
<p> – 注册用户自定义函数（UDF）</p>
<h3 id="配置-TableEnvironment"><a href="#配置-TableEnvironment" class="headerlink" title="配置 TableEnvironment"></a>配置 TableEnvironment</h3><h4 id="配置老版本-planner-的流式查询"><a href="#配置老版本-planner-的流式查询" class="headerlink" title="配置老版本 planner 的流式查询"></a>配置老版本 planner 的流式查询</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">EnvironmentSettings settings &#x3D; EnvironmentSettings.newInstance()</span><br><span class="line">.useOldPlanner()</span><br><span class="line">.inStreamingMode()</span><br><span class="line">.build();</span><br><span class="line">StreamTableEnvironment tableEnv &#x3D; StreamTableEnvironment</span><br><span class="line">.create(env, settings);</span><br></pre></td></tr></table></figure>

<h4 id="配置老版本-planner-的批式查询"><a href="#配置老版本-planner-的批式查询" class="headerlink" title="配置老版本 planner 的批式查询"></a>配置老版本 planner 的批式查询</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ExecutionEnvironment batchEnv &#x3D; ExecutionEnvironment.getExecutionEnvironment;</span><br><span class="line">BatchTableEnvironment batchTableEnv &#x3D; BatchTableEnvironment.create(batchEnv);</span><br></pre></td></tr></table></figure>

<h4 id="配置-blink-planner-的流式查询"><a href="#配置-blink-planner-的流式查询" class="headerlink" title="配置 blink planner 的流式查询"></a>配置 blink planner 的流式查询</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">EnvironmentSettings bsSettings &#x3D; EnvironmentSettings.newInstance()</span><br><span class="line">.useBlinkPlanner()</span><br><span class="line">.inStreamingMode()</span><br><span class="line">.build();</span><br><span class="line">StreamTableEnvironment bsTableEnv &#x3D; StreamTableEnvironment</span><br><span class="line">.create(env, bsSettings);</span><br></pre></td></tr></table></figure>

<h4 id="配置-blink-planner-的批式查询"><a href="#配置-blink-planner-的批式查询" class="headerlink" title="配置 blink planner 的批式查询"></a>配置 blink planner 的批式查询</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">EnvironmentSettings bbSettings &#x3D; EnvironmentSettings.newInstance()</span><br><span class="line">.useBlinkPlanner()</span><br><span class="line">.inBatchMode()</span><br><span class="line">.build();</span><br><span class="line">TableEnvironment bbTableEnv &#x3D; TableEnvironment.create(bbSettings);</span><br></pre></td></tr></table></figure>

<h3 id="表（Table）"><a href="#表（Table）" class="headerlink" title="表（Table）"></a>表（Table）</h3><p>• TableEnvironment 可以注册目录 Catalog，并可以基于 Catalog 注册表 </p>
<p>• 表（Table）是由一个“标识符”（identifier）来指定的，由3部分组成： Catalog名、数据库（database）名和对象名 </p>
<p>• 表可以是常规的，也可以是虚拟的（视图，View）</p>
<p> • 常规表（Table）一般可以用来描述外部数据，比如文件、数据库表或消息队 列的数据，也可以直接从 DataStream转换而来</p>
<p> • 视图（View）可以从现有的表中创建，通常是 table API 或者 SQL 查询的 一个结果集</p>
<h4 id="创建表"><a href="#创建表" class="headerlink" title="创建表"></a>创建表</h4><p>TableEnvironment 可以调用 .connect() 方法，连接外部系统，并调 用 .createTemporaryTable() 方法，在 Catalog 中注册表</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">tableEnv</span><br><span class="line">.connect(...) &#x2F;&#x2F; 定义表的数据来源，和外部系统建立连接</span><br><span class="line">.withFormat(...) &#x2F;&#x2F; 定义数据格式化方法</span><br><span class="line">.withSchema(...) &#x2F;&#x2F; 定义表结构</span><br><span class="line">.createTemporaryTable(&quot;MyTable&quot;); &#x2F;&#x2F; 创建临时表</span><br></pre></td></tr></table></figure>

<p>可以创建 Table 来描述文件数据，它可以从文件中读取，或者将数据写入文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">tableEnv</span><br><span class="line">.connect(</span><br><span class="line">new FileSystem().path(“YOUR_Path&#x2F;sensor.txt”)</span><br><span class="line">) &#x2F;&#x2F; 定义到文件系统的连接</span><br><span class="line">.withFormat(new Csv()) &#x2F;&#x2F; 定义以csv格式进行数据格式化</span><br><span class="line">.withSchema( new Schema()</span><br><span class="line">.field(&quot;id&quot;, DataTypes.STRING())</span><br><span class="line">.field(&quot;timestamp&quot;, DataTypes.BIGINT())</span><br><span class="line">.field(&quot;temperature&quot;, DataTypes.DOUBLE())</span><br><span class="line">) &#x2F;&#x2F; 定义表结构</span><br><span class="line">.createTemporaryTable(&quot;sensorTable&quot;); &#x2F;&#x2F; 创建临时表</span><br></pre></td></tr></table></figure>

<h2 id="表的查询-–-Table-API"><a href="#表的查询-–-Table-API" class="headerlink" title="表的查询 – Table API"></a>表的查询 – Table API</h2><p>• Table API 是集成在 Scala 和 Java 语言内的查询 API </p>
<p>• Table API 基于代表“表”的 Table 类，并提供一整套操作处理的方法 API； 这些方法会返回一个新的 Table 对象，表示对输入表应用转换操作的结果 </p>
<p>• 有些关系型转换操作，可以由多个方法调用组成，构成链式调用结构</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Table sensorTable &#x3D; tableEnv.from(&quot;inputTable&quot;);</span><br><span class="line">Table resultTable &#x3D; sensorTable</span><br><span class="line">.select(&quot;id, temperature&quot;)</span><br><span class="line">.filter(&quot;id &#x3D; &#39;sensor_1&#39;&quot;);</span><br></pre></td></tr></table></figure>

<p>• Flink 的 SQL 集成，基于实现 了SQL 标准的 Apache Calcite </p>
<p>• 在 Flink 中，用常规字符串来定义 SQL 查询语句</p>
<p> • SQL 查询的结果，也是一个新的 Table</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Table resultSqlTable &#x3D; tableEnv</span><br><span class="line">.sqlQuery(&quot;select id, temperature from sensorTable where id &#x3D;&#39;sensor_1&#39;&quot;);</span><br></pre></td></tr></table></figure>

<h2 id="输出"><a href="#输出" class="headerlink" title="输出"></a>输出</h2><h3 id="输出表"><a href="#输出表" class="headerlink" title="输出表"></a>输出表</h3><p>• 表的输出，是通过将数据写入 TableSink 来实现的</p>
<p> • TableSink 是一个通用接口，可以支持不同的文件格式、存储数据库和消息队 列 </p>
<p>• 输出表最直接的方法，就是通过 Table.insertInto() 方法将一个 Table 写入注 册过的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">tableEnv.connect(...)</span><br><span class="line">.createTemporaryTable(&quot;outputTable&quot;);</span><br><span class="line">Table resultSqlTable &#x3D; ...</span><br><span class="line">resultTable.insertInto(&quot;outputTable&quot;);</span><br></pre></td></tr></table></figure>

<h3 id="输出到文件"><a href="#输出到文件" class="headerlink" title="输出到文件"></a>输出到文件</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">tableEnv.connect(</span><br><span class="line">new FileSystem().path(&quot;output.txt&quot;)</span><br><span class="line">) &#x2F;&#x2F; 定义到文件系统的连接</span><br><span class="line">.withFormat(new Csv())</span><br><span class="line">.withSchema(new Schema()</span><br><span class="line">.field(&quot;id&quot;, DataTypes.STRING())</span><br><span class="line">.field(&quot;temp&quot;, DataTypes.Double())</span><br><span class="line">)</span><br><span class="line">.createTemporaryTable(&quot;outputTable&quot;) ; &#x2F;&#x2F; 创建临时表</span><br><span class="line">resultTable.insertInto(&quot;outputTable&quot;); &#x2F;&#x2F; 输出表</span><br></pre></td></tr></table></figure>

<h4 id="更新模式"><a href="#更新模式" class="headerlink" title="更新模式"></a>更新模式</h4><p>• 对于流式查询，需要声明如何在表和外部连接器之间执行转换</p>
<p> • 与外部系统交换的消息类型，由更新模式（Update Mode）指定</p>
<p> ➢ 追加（Append）模式 – 表只做插入操作，和外部连接器只交换插入（Insert）消息 </p>
<p>➢ 撤回（Retract）模式 – 表和外部连接器交换添加（Add）和撤回（Retract）消息 – 插入操作（Insert）编码为 Add 消息；删除（Delete）编码为 Retract 消息；更新（Update） 编码为上一条的 Retract 和下一条的 Add 消息</p>
<p> ➢ 更新插入（Upsert）模式 – 更新和插入都被编码为 Upsert 消息；删除编码为 Delete 消息</p>
<h3 id="输出到-Kafka"><a href="#输出到-Kafka" class="headerlink" title="输出到 Kafka"></a>输出到 Kafka</h3><p>• 可以创建 Table 来描述 kafka 中的数据，作为输入或输出的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">tableEnv.connect(</span><br><span class="line">new Kafka()</span><br><span class="line">.version(&quot;0.11&quot;)</span><br><span class="line">.topic(&quot;sinkTest&quot;)</span><br><span class="line">.property(&quot;zookeeper.connect&quot;, &quot;localhost:2181&quot;)</span><br><span class="line">.property(&quot;bootstrap.servers&quot;, &quot;localhost:9092&quot;)</span><br><span class="line">)</span><br><span class="line">.withFormat( new Csv() )</span><br><span class="line">.withSchema( new Schema()</span><br><span class="line">.field(&quot;id&quot;, DataTypes.STRING())</span><br><span class="line">.field(&quot;temp&quot;, DataTypes.DOUBLE())</span><br><span class="line">)</span><br><span class="line">.createTemporaryTable(&quot;kafkaOutputTable&quot;);</span><br><span class="line">resultTable.insertInto(&quot;kafkaOutputTable&quot;);</span><br></pre></td></tr></table></figure>

<h3 id="输出到-ES"><a href="#输出到-ES" class="headerlink" title="输出到 ES"></a>输出到 ES</h3><p>可以创建 Table 来描述 ES 中的数据，作为输出的 TableSink</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">tableEnv.connect(</span><br><span class="line">new Elasticsearch()</span><br><span class="line">.version(&quot;6&quot;)</span><br><span class="line">.host(&quot;localhost&quot;, 9200, &quot;http&quot;)</span><br><span class="line">.index(&quot;sensor&quot;)</span><br><span class="line">.documentType(&quot;temp&quot;)</span><br><span class="line">)</span><br><span class="line">.inUpsertMode()</span><br><span class="line">.withFormat(new Json())</span><br><span class="line">.withSchema( new Schema()</span><br><span class="line">.field(&quot;id&quot;, DataTypes.STRING())</span><br><span class="line">.field(&quot;count&quot;, DataTypes.BIGINT())</span><br><span class="line">)</span><br><span class="line">.createTemporaryTable(&quot;esOutputTable&quot;);</span><br><span class="line">aggResultTable.insertInto(&quot;esOutputTable&quot;);</span><br></pre></td></tr></table></figure>

<h3 id="输出到-MySql"><a href="#输出到-MySql" class="headerlink" title="输出到 MySql"></a>输出到 MySql</h3><p>可以创建 Table 来描述 MySql 中的数据，作为输入和输出</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">String sinkDDL&#x3D;</span><br><span class="line">&quot;create table jdbcOutputTable (&quot; +</span><br><span class="line">&quot; id varchar(20) not null, &quot; +</span><br><span class="line">&quot; cnt bigint not null &quot; +</span><br><span class="line">&quot;) with (&quot; +</span><br><span class="line">&quot; &#39;connector.type&#39; &#x3D; &#39;jdbc&#39;, &quot; +</span><br><span class="line">&quot; &#39;connector.url&#39; &#x3D; &#39;jdbc:mysql:&#x2F;&#x2F;localhost:3306&#x2F;test&#39;, &quot; +</span><br><span class="line">&quot; &#39;connector.table&#39; &#x3D; &#39;sensor_count&#39;, &quot; +</span><br><span class="line">&quot; &#39;connector.driver&#39; &#x3D; &#39;com.mysql.jdbc.Driver&#39;, &quot; +</span><br><span class="line">&quot; &#39;connector.username&#39; &#x3D; &#39;root&#39;, &quot; +</span><br><span class="line">&quot; &#39;connector.password&#39; &#x3D; &#39;123456&#39; )&quot;;</span><br><span class="line">tableEnv.sqlUpdate(sinkDDL) &#x2F;&#x2F; 执行 DDL创建表</span><br><span class="line">aggResultSqlTable.insertInto(&quot;jdbcOutputTable&quot;);</span><br></pre></td></tr></table></figure>

<h2 id="将-Table-转换成-DataStream"><a href="#将-Table-转换成-DataStream" class="headerlink" title="将 Table 转换成 DataStream"></a>将 Table 转换成 DataStream</h2><p>• 表可以转换为 DataStream 或 DataSet ，这样自定义流处理或批处理程序就 可以继续在 Table API 或 SQL 查询的结果上运行了 </p>
<p>• 将表转换为 DataStream 或 DataSet 时，需要指定生成的数据类型，即要将 表的每一行转换成的数据类型 </p>
<p>• 表作为流式查询的结果，是动态更新的 </p>
<p>• 转换有两种转换模式：追加（Append）模式和撤回（Retract）模式</p>
<p>➢ 追加模式（Append Mode） </p>
<p>– 用于表只会被插入（Insert）操作更改的场景</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DataStream&lt;Row&gt; resultStream &#x3D; tableEnv.toAppendStream(resultTable, Row.class);</span><br></pre></td></tr></table></figure>

<p> ➢ 撤回模式（Retract Mode） </p>
<p>– 用于任何场景。</p>
<p>有些类似于更新模式中 Retract 模式，它只有 Insert 和 Delete 两类操作。 </p>
<p>– 得到的数据会增加一个 Boolean 类型的标识位（返回的第一个字段），用它来表示到底是 新增的数据（Insert），还是被删除的数据（Delete） </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">DataStream&lt;Tuple2&lt;Boolean, Row&gt;&gt; aggResultStream &#x3D; tableEnv</span><br><span class="line">.toRetractStream(aggResultTable , Row.class);</span><br></pre></td></tr></table></figure>

<p>• 对于一个 DataStream，可以直接转换成 Table，进而方便地调用 Table API 做转换操作</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">DataStream&lt;SensorReading&gt; dataStream &#x3D; ...</span><br><span class="line">Table sensorTable &#x3D; tableEnv.fromDataStream(dataStream);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>• 默认转换后的 Table schema 和 DataStream 中的字段定义一一对应，也可 以单独指定出来</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">DataStream&lt;SensorReading&gt; dataStream &#x3D; ...</span><br><span class="line">Table sensorTable &#x3D; tableEnv.fromDataStream(dataStream,</span><br><span class="line">&quot;id, timestamp as ts, temperature&quot;);</span><br></pre></td></tr></table></figure>

<h2 id="创建临时视图（Temporary-View）"><a href="#创建临时视图（Temporary-View）" class="headerlink" title="创建临时视图（Temporary View）"></a>创建临时视图（Temporary View）</h2><p>• 基于 DataStream 创建临时视图</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">tableEnv.createTemporaryView(&quot;sensorView&quot;, dataStream);</span><br><span class="line">tableEnv.createTemporaryView(&quot;sensorView&quot;,</span><br><span class="line">dataStream, &quot;id, temperature, timestamp as ts&quot;);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>• 基于 Table 创建临时视图</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tableEnv.createTemporaryView(&quot;sensorView&quot;, sensorTable);</span><br></pre></td></tr></table></figure>

<h2 id="查看执行计划"><a href="#查看执行计划" class="headerlink" title="查看执行计划"></a>查看执行计划</h2><p>• Table API 提供了一种机制来解释计算表的逻辑和优化查询计划 </p>
<p>• 查看执行计划，可以通过 TableEnvironment.explain(table) 方法或 TableEnvironment.explain() 方法完成，返回一个字符串，描述三个计划</p>
<p> ➢ 优化的逻辑查询计划</p>
<p> ➢ 优化后的逻辑查询计划 </p>
<p>➢ 实际执行计划。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">String explaination &#x3D; tableEnv.explain(resultTable);</span><br><span class="line">System.out.println(explaination);</span><br></pre></td></tr></table></figure>

<p><img src="https://heavenimmortal.oss-cn-chengdu.aliyuncs.com/img/image-20210212132853845.png" alt="image-20210212132853845"></p>
<h2 id="动态表（Dynamic-Tables）"><a href="#动态表（Dynamic-Tables）" class="headerlink" title="动态表（Dynamic Tables）"></a>动态表（Dynamic Tables）</h2><p>• 动态表是 Flink 对流数据的 Table API 和 SQL 支持的核心概念 </p>
<p>• 与表示批处理数据的静态表不同，动态表是随时间变化的</p>
<p> ➢ 持续查询（Continuous Query）</p>
<p> • 动态表可以像静态的批处理表一样进行查询，查询一个动态表会产生持续查 询（Continuous Query）</p>
<p> • 连续查询永远不会终止，并会生成另一个动态表</p>
<p> • 查询会不断更新其动态结果表，以反映其动态输入表上的更改</p>
<blockquote>
<p>动态表和持续查询</p>
</blockquote>
<p><img src="https://heavenimmortal.oss-cn-chengdu.aliyuncs.com/img/image-20210212132938792.png" alt="image-20210212132938792"></p>
<p>➢ 流式表查询的处理过程：</p>
<ol>
<li>流被转换为动态表</li>
<li>对动态表计算连续查询，生成新的动态表</li>
<li> 生成的动态表被转换回流</li>
</ol>
<h3 id="将流转换成动态表"><a href="#将流转换成动态表" class="headerlink" title="将流转换成动态表"></a>将流转换成动态表</h3><p>• 为了处理带有关系查询的流，必须先将其转换为表 </p>
<p>• 从概念上讲，流的每个数据记录，都被解释为对结果表的插入 （Insert）修改操作</p>
<p><img src="https://heavenimmortal.oss-cn-chengdu.aliyuncs.com/img/image-20210212133107947.png" alt="image-20210212133107947"></p>
<h3 id="持续查询"><a href="#持续查询" class="headerlink" title="持续查询"></a>持续查询</h3><p>• 持续查询会在动态表上做计算处理，并作为结果生成新的动态表</p>
<p><img src="https://heavenimmortal.oss-cn-chengdu.aliyuncs.com/img/image-20210212133131655.png" alt="image-20210212133131655"></p>
<h3 id="将动态表转换成-DataStream"><a href="#将动态表转换成-DataStream" class="headerlink" title="将动态表转换成 DataStream"></a>将动态表转换成 DataStream</h3><p>• 与常规的数据库表一样，动态表可以通过插入（Insert）、更新（Update）和删 除（Delete）更改，进行持续的修改</p>
<p> • 将动态表转换为流或将其写入外部系统时，需要对这些更改进行编码</p>
<p> ➢ 仅追加（Append-only）流 </p>
<p>– 仅通过插入（Insert）更改来修改的动态表，可以直接转换为仅追加流 </p>
<p>➢ 撤回（Retract）流 </p>
<p>– 撤回流是包含两类消息的流：添加（Add）消息和撤回（Retract）消息 </p>
<p>➢ Upsert（更新插入）流 </p>
<p>– Upsert 流也包含两种类型的消息：Upsert 消息和删除（Delete）消息。</p>
<p><img src="https://heavenimmortal.oss-cn-chengdu.aliyuncs.com/img/image-20210212133230483.png" alt="image-20210212133230483"></p>
<h2 id="时间特性"><a href="#时间特性" class="headerlink" title="时间特性"></a>时间特性</h2><p>• 基于时间的操作（比如 Table API 和 SQL 中窗口操作），需要定义相关的时 间语义和时间数据来源的信息 </p>
<p>• Table 可以提供一个逻辑上的时间字段，用于在表处理程序中，指示时间和 访问相应的时间戳 </p>
<p>• 时间属性，可以是每个表schema的一部分。一旦定义了时间属性，它就可以 作为一个字段引用，并且可以在基于时间的操作中使用 </p>
<p>• 时间属性的行为类似于常规时间戳，可以访问，并且进行计算</p>
<h3 id="定义处理时间（Processing-Time）"><a href="#定义处理时间（Processing-Time）" class="headerlink" title="定义处理时间（Processing Time）"></a>定义处理时间（Processing Time）</h3><p>• 处理时间语义下，允许表处理程序根据机器的本地时间生成结果。它是时间 的最简单概念。它既不需要提取时间戳，也不需要生成 watermark </p>
<p>➢ 由 DataStream 转换成表时指定 </p>
<p>• 在定义Schema期间，可以使用.proctime，指定字段名定义处理时间字段 </p>
<p>• 这个proctime属性只能通过附加逻辑字段，来扩展物理schema。因此，只 能在schema定义的末尾定义它</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Table sensorTable &#x3D; tableEnv.fromDataStream(dataStream,</span><br><span class="line">&quot;id, temperature, timestamp, pt.proctime&quot;);</span><br></pre></td></tr></table></figure>

<p>➢ 定义 Table Schema 时指定</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">.withSchema(new Schema()</span><br><span class="line">.field(&quot;id&quot;, DataTypes.STRING())</span><br><span class="line">.field(&quot;timestamp&quot;, DataTypes.BIGINT())</span><br><span class="line">.field(&quot;temperature&quot;, DataTypes.DOUBLE())</span><br><span class="line">.field(&quot;pt&quot;, DataTypes.TIMESTAMP(3))</span><br><span class="line">.proctime()</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>➢ 在创建表的 DDL 中定义</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">String sinkDDL &#x3D;</span><br><span class="line">&quot;create table dataTable (&quot; +</span><br><span class="line">&quot; id varchar(20) not null, &quot; +</span><br><span class="line">&quot; ts bigint, &quot; +</span><br><span class="line">&quot; temperature double, &quot; +</span><br><span class="line">&quot; pt AS PROCTIME() &quot; +</span><br><span class="line">&quot;) with (&quot; +</span><br><span class="line">&quot; &#39;connector.type&#39; &#x3D; &#39;filesystem&#39;, &quot; +</span><br><span class="line">&quot; &#39;connector.path&#39; &#x3D; &#39;&#x2F;sensor.txt&#39;, &quot; +</span><br><span class="line">&quot; &#39;format.type&#39; &#x3D; &#39;csv&#39;)&quot;;</span><br><span class="line">tableEnv.sqlUpdate(sinkDDL);</span><br></pre></td></tr></table></figure>

<h3 id="定义事件时间（Event-Time）"><a href="#定义事件时间（Event-Time）" class="headerlink" title="定义事件时间（Event Time）"></a>定义事件时间（Event Time）</h3><p>• 事件时间语义，允许表处理程序根据每个记录中包含的时间生成结果。这样 即使在有乱序事件或者延迟事件时，也可以获得正确的结果。</p>
<p> • 为了处理无序事件，并区分流中的准时和迟到事件；Flink 需要从事件数据中， 提取时间戳，并用来推进事件时间的进展</p>
<p> • 定义事件时间，同样有三种方法： </p>
<p>➢ 由 DataStream 转换成表时指定 </p>
<p>➢ 定义 Table Schema 时指定 </p>
<p>➢ 在创建表的 DDL 中定义</p>
<p>➢ 由 DataStream 转换成表时指定 </p>
<p>• 在 DataStream 转换成 Table，使用 .rowtime 可以定义事件时间属性</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; 将 DataStream转换为 Table，并指定时间字段</span><br><span class="line">Table sensorTable &#x3D; tableEnv.fromDataStream(dataStream,</span><br><span class="line">&quot;id, timestamp.rowtime, temperature&quot;);</span><br><span class="line">&#x2F;&#x2F; 或者，直接追加时间字段</span><br><span class="line">Table sensorTable &#x3D; tableEnv.fromDataStream(dataStream,</span><br><span class="line">&quot; id, temperature, timestamp, rt.rowtime&quot;);</span><br></pre></td></tr></table></figure>

<p>• 定义 Table Schema 时指定</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">.withSchema(new Schema()</span><br><span class="line">.field(&quot;id&quot;, DataTypes.STRING())</span><br><span class="line">.field(&quot;timestamp&quot;, DataTypes.BIGINT())</span><br><span class="line">.rowtime(</span><br><span class="line">new Rowtime()</span><br><span class="line">.timestampsFromField(&quot;timestamp&quot;) &#x2F;&#x2F; 从字段中提取时间戳</span><br><span class="line">.watermarksPeriodicBounded(1000) &#x2F;&#x2F; watermark延迟1秒</span><br><span class="line">)</span><br><span class="line">.field(&quot;temperature&quot;, DataTypes.DOUBLE())</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>• 在创建表的 DDL 中定义</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">String sinkDDL&#x3D;</span><br><span class="line">&quot;create table dataTable (&quot; +</span><br><span class="line">&quot; id varchar(20) not null, &quot; +</span><br><span class="line">&quot; ts bigint, &quot; +</span><br><span class="line">&quot; temperature double, &quot; +</span><br><span class="line">&quot; rt AS TO_TIMESTAMP( FROM_UNIXTIME(ts) ), &quot; +</span><br><span class="line">&quot; watermark for rt as rt - interval &#39;1&#39; second&quot; +</span><br><span class="line">&quot;) with (&quot; +</span><br><span class="line">&quot; &#39;connector.type&#39; &#x3D; &#39;filesystem&#39;, &quot; +</span><br><span class="line">&quot; &#39;connector.path&#39; &#x3D; &#39;&#x2F;sensor.txt&#39;, &quot; +</span><br><span class="line">&quot; &#39;format.type&#39; &#x3D; &#39;csv&#39;)&quot;;</span><br><span class="line">tableEnv.sqlUpdate(sinkDDL);</span><br></pre></td></tr></table></figure>

<h2 id="窗口"><a href="#窗口" class="headerlink" title="窗口"></a>窗口</h2><p>• 时间语义，要配合窗口操作才能发挥作用 </p>
<p>• 在 Table API 和 SQL 中，主要有两种窗口</p>
<p> ➢ Group Windows（分组窗口）</p>
<p> – 根据时间或行计数间隔，将行聚合到有限的组（Group）中，并对每个组的数据 执行一次聚合函数</p>
<p> ➢ Over Windows </p>
<p>– 针对每个输入行，计算相邻行范围内的聚合</p>
<h3 id="Group-Windows"><a href="#Group-Windows" class="headerlink" title="Group Windows"></a>Group Windows</h3><p>• Group Windows 是使用 window（w:GroupWindow）子句定义的，并且 必须由as子句指定一个别名。</p>
<p> • 为了按窗口对表进行分组，窗口的别名必须在 group by 子句中，像常规的 分组字段一样引用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Table table &#x3D; input</span><br><span class="line">.window([w: GroupWindow] as &quot;w&quot;) &#x2F;&#x2F; 定义窗口，别名为 w</span><br><span class="line">.groupBy(&quot;w, a&quot;) &#x2F;&#x2F; 按照字段 a和窗口 w分组</span><br><span class="line">.select(&quot;a, b.sum&quot;); &#x2F;&#x2F; 聚合</span><br></pre></td></tr></table></figure>

<p>• Table API 提供了一组具有特定语义的预定义 Window 类，这些类会被转换 为底层 DataStream 或 DataSet 的窗口操作</p>
<h3 id="滚动窗口（Tumbling-windows）"><a href="#滚动窗口（Tumbling-windows）" class="headerlink" title="滚动窗口（Tumbling windows）"></a>滚动窗口（Tumbling windows）</h3><p>• 滚动窗口要用 Tumble 类来定义</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; Tumbling Event-time Window</span><br><span class="line">.window(Tumble.over(&quot;10.minutes&quot;).on(&quot;rowtime&quot;).as(&quot;w&quot;))</span><br><span class="line">&#x2F;&#x2F; Tumbling Processing-time Window</span><br><span class="line">.window(Tumble.over(&quot;10.minutes&quot;).on(&quot;proctime&quot;).as(&quot;w&quot;))</span><br><span class="line">&#x2F;&#x2F; Tumbling Row-count Window</span><br><span class="line">.window(Tumble.over(&quot;10.rows&quot;).on(&quot;proctime&quot;).as(&quot;w&quot;))</span><br></pre></td></tr></table></figure>

<h3 id="滑动窗口（Sliding-windows）"><a href="#滑动窗口（Sliding-windows）" class="headerlink" title="滑动窗口（Sliding windows）"></a>滑动窗口（Sliding windows）</h3><p>• 滑动窗口要用 Slide 类来定义</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; Sliding Event-time Window</span><br><span class="line">.window(Slide.over(&quot;10.minutes&quot;).every(&quot;5.minutes&quot;).on(&quot;rowtime&quot;).as(&quot;w&quot;))</span><br><span class="line">&#x2F;&#x2F; Sliding Processing-time window</span><br><span class="line">.window(Slide.over(&quot;10.minutes&quot;).every(&quot;5.minutes&quot;).on(&quot;proctime&quot;).as(&quot;w&quot;))</span><br><span class="line">&#x2F;&#x2F; Sliding Row-count window</span><br><span class="line">.window(Slide.over(&quot;10.rows&quot;).every(&quot;5.rows&quot;).on(&quot;proctime&quot;).as(&quot;w&quot;))</span><br></pre></td></tr></table></figure>

<h3 id="会话窗口（Session-windows）"><a href="#会话窗口（Session-windows）" class="headerlink" title="会话窗口（Session windows）"></a>会话窗口（Session windows）</h3><p>• 会话窗口要用 Session 类来定义</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; Session Event-time Window</span><br><span class="line">.window(Session.withGap(&quot;10.minutes&quot;).on(&quot;rowtime&quot;).as(&quot;w&quot;))</span><br><span class="line">&#x2F;&#x2F; Session Processing-time Window</span><br><span class="line">.window(Session.withGap(&quot;10.minutes&quot;).on(“proctime&quot;).as(&quot;w&quot;))</span><br></pre></td></tr></table></figure>

<h3 id="SQL-中的-Group-Windows"><a href="#SQL-中的-Group-Windows" class="headerlink" title="SQL 中的 Group Windows"></a>SQL 中的 Group Windows</h3><p>• Group Windows 定义在 SQL 查询的 Group By 子句中 </p>
<p>➢ TUMBLE(time_attr, interval) </p>
<p>• 定义一个滚动窗口，第一个参数是时间字段，第二个参数是窗口长度 ➢ HOP(time_attr, interval, interval)</p>
<p> • 定义一个滑动窗口，第一个参数是时间字段，第二个参数是窗口滑动步长，第三个是 窗口长度 </p>
<p>➢ SESSION(time_attr, interval)</p>
<p> • 定义一个会话窗口，第一个参数是时间字段，第二个参数是窗口间隔</p>
<h3 id="Over-Windows"><a href="#Over-Windows" class="headerlink" title="Over Windows"></a>Over Windows</h3><p>• Over window 聚合是标准 SQL 中已有的（over 子句），可以在查询的 SELECT 子句中定义</p>
<p> • Over window 聚合，会针对每个输入行，计算相邻行范围内的聚合 </p>
<p>• Over windows 使用 window（w:overwindows*）子句定义，并在 select （）方法中通过别名来引用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Table table &#x3D; input</span><br><span class="line">.window([w: OverWindow] as &quot;w&quot;)</span><br><span class="line">.select(&quot;a, b.sum over w, c.min over w&quot;);</span><br></pre></td></tr></table></figure>

<p>• Table API 提供了 Over 类，来配置 Over 窗口的属性</p>
<h3 id="无界-Over-Windows"><a href="#无界-Over-Windows" class="headerlink" title="无界 Over Windows"></a>无界 Over Windows</h3><p>• 可以在事件时间或处理时间，以及指定为时间间隔、或行计数的范围内，定 义 Over windows </p>
<p>• 无界的 over window 是使用常量指定的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; 无界的事件时间 over window</span><br><span class="line">.window(Over.partitionBy(&quot;a&quot;).orderBy(&quot;rowtime&quot;).preceding(UNBOUNDED_RANGE).as(&quot;w&quot;))</span><br><span class="line">&#x2F;&#x2F;无界的处理时间 over window</span><br><span class="line">.window(Over.partitionBy(&quot;a&quot;).orderBy(&quot;proctime&quot;).preceding(UNBOUNDED_RANGE).as(&quot;w&quot;))</span><br><span class="line">&#x2F;&#x2F; 无界的事件时间 Row-count over window</span><br><span class="line">.window(Over.partitionBy(&quot;a&quot;).orderBy(&quot;rowtime&quot;).preceding(UNBOUNDED_ROW).as(&quot;w&quot;))</span><br><span class="line">&#x2F;&#x2F;无界的处理时间 Row-count over window</span><br><span class="line">.window(Over.partitionBy(&quot;a&quot;).orderBy(&quot;proctime&quot;).preceding(UNBOUNDED_ROW).as(&quot;w&quot;))</span><br></pre></td></tr></table></figure>

<h3 id="有界-Over-Windows"><a href="#有界-Over-Windows" class="headerlink" title="有界 Over Windows"></a>有界 Over Windows</h3><p>• 有界的 over window 是用间隔的大小指定的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; 有界的事件时间 over window</span><br><span class="line">.window(Over.partitionBy(&quot;a&quot;).orderBy(&quot;rowtime&quot;).preceding(&quot;1.minutes&quot;).as(&quot;w&quot;))</span><br><span class="line">&#x2F;&#x2F; 有界的处理时间 over window</span><br><span class="line">.window(Over.partitionBy(&quot;a&quot;).orderBy(&quot;proctime&quot;).preceding(&quot;1.minutes&quot;).as(&quot;w&quot;))</span><br><span class="line">&#x2F;&#x2F; 有界的事件时间 Row-count over window</span><br><span class="line">.window(Over.partitionBy(&quot;a&quot;).orderBy(&quot;rowtime&quot;).preceding(&quot;10.rows&quot;).as(&quot;w&quot;))</span><br><span class="line">&#x2F;&#x2F; 有界的处理时间 Row-count over window</span><br><span class="line">.window(Over.partitionBy(&quot;a&quot;).orderBy(&quot;procime&quot;).preceding(&quot;10.rows&quot;).as(&quot;w&quot;))</span><br></pre></td></tr></table></figure>

<h3 id="SQL-中的-Over-Windows"><a href="#SQL-中的-Over-Windows" class="headerlink" title="SQL 中的 Over Windows"></a>SQL 中的 Over Windows</h3><p>• 用 Over 做窗口聚合时，所有聚合必须在同一窗口上定义，也就是说必须是 相同的分区、排序和范围</p>
<p> • 目前仅支持在当前行范围之前的窗口 </p>
<p>• ORDER BY 必须在单一的时间属性上指定</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">SELECT COUNT(amount) OVER (</span><br><span class="line">PARTITION BY user</span><br><span class="line">ORDER BY proctime</span><br><span class="line">ROWS BETWEEN 2 PRECEDING AND CURRENT ROW)</span><br><span class="line">FROM Orders</span><br></pre></td></tr></table></figure>

<h2 id="函数（Functions）"><a href="#函数（Functions）" class="headerlink" title="函数（Functions）"></a>函数（Functions）</h2><p>• Flink Table API 和 SQL 为用户提供了一组用于数据转换的内置函数</p>
<p> • SQL 中支持的很多函数，Table API 和 SQL 都已经做了实现</p>
<p><img src="https://heavenimmortal.oss-cn-chengdu.aliyuncs.com/img/image-20210212160732332.png" alt="image-20210212160732332"></p>
<p><img src="https://heavenimmortal.oss-cn-chengdu.aliyuncs.com/img/image-20210212160743984.png" alt="image-20210212160743984"></p>
<h3 id="用户自定义函数（UDF）"><a href="#用户自定义函数（UDF）" class="headerlink" title="用户自定义函数（UDF）"></a>用户自定义函数（UDF）</h3><p>• 用户定义函数（User-defined Functions，UDF）是一个重要的特性，它们 显著地扩展了查询的表达能力 </p>
<p>• 在大多数情况下，用户定义的函数必须先注册，然后才能在查询中使用</p>
<p> • 函数通过调用 registerFunction（）方法在 TableEnvironment 中注册。当 用户定义的函数被注册时，它被插入到 TableEnvironment 的函数目录中， 这样Table API 或 SQL 解析器就可以识别并正确地解释它</p>
<h3 id="标量函数（Scalar-Functions）"><a href="#标量函数（Scalar-Functions）" class="headerlink" title="标量函数（Scalar Functions）"></a>标量函数（Scalar Functions）</h3><p>• 用户定义的标量函数，可以将0、1或多个标量值，映射到新的标量值</p>
<p> • 为了定义标量函数，必须在 org.apache.flink.table.functions 中扩展基类 Scalar Function，并实现（一个或多个）求值（eval）方法</p>
<p> • 标量函数的行为由求值方法决定，求值方法必须公开声明并命名为 eval</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">public static class HashCode extends ScalarFunction &#123;</span><br><span class="line">private int factor &#x3D; 13;</span><br><span class="line">public HashCode(int factor) &#123;</span><br><span class="line">this.factor &#x3D; factor;</span><br><span class="line">&#125;</span><br><span class="line">public int eval(String s) &#123;</span><br><span class="line">return s.hashCode() * factor;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="表函数（Table-Functions）"><a href="#表函数（Table-Functions）" class="headerlink" title="表函数（Table Functions）"></a>表函数（Table Functions）</h3><p>• 用户定义的表函数，也可以将0、1或多个标量值作为输入参数；与标量函数不同 的是，它可以返回任意数量的行作为输出，而不是单个值 </p>
<p>• 为了定义一个表函数，必须扩展 org.apache.flink.table.functions 中的基类 TableFunction 并实现（一个或多个）求值方法</p>
<p> • 表函数的行为由其求值方法决定，求值方法必须是 public 的，并命名为 eval</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">public static class Split extends TableFunction&lt;Tuple2&lt;String, Integer&gt;&gt; &#123;</span><br><span class="line">private String separator &#x3D; &quot;,&quot;;</span><br><span class="line">public Split(String separator) &#123;</span><br><span class="line">this.separator &#x3D; separator;</span><br><span class="line">&#125;</span><br><span class="line">public void eval(String str) &#123;</span><br><span class="line">for (String s : str.split(separator)) &#123;</span><br><span class="line">collect(new Tuple2&lt;String, Integer&gt;(s, s.length()));</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="聚合函数（Aggregate-Functions）"><a href="#聚合函数（Aggregate-Functions）" class="headerlink" title="聚合函数（Aggregate Functions）"></a>聚合函数（Aggregate Functions）</h3><p>• 用户自定义聚合函数（User-Defined Aggregate Functions，UDAGGs） 可以把一个表中的数据，聚合成一个标量值</p>
<p> • 用户定义的聚合函数，是通过继承 AggregateFunction 抽象类实现的</p>
<p><img src="https://heavenimmortal.oss-cn-chengdu.aliyuncs.com/img/image-20210212160941324.png" alt="image-20210212160941324"></p>
<p>• AggregationFunction要求必须实现的方法：</p>
<p> – createAccumulator() </p>
<p>– accumulate() </p>
<p>– getValue() </p>
<p>• AggregateFunction 的工作原理如下： </p>
<p>– 首先，它需要一个累加器（Accumulator），用来保存聚合中间结果的数据结构； 可以通过调用 createAccumulator() 方法创建空累加器</p>
<p> – 随后，对每个输入行调用函数的 accumulate() 方法来更新累加器</p>
<p> – 处理完所有行后，将调用函数的 getValue() 方法来计算并返回最终结果</p>
<h3 id="表聚合函数（Table-Aggregate-Functions）"><a href="#表聚合函数（Table-Aggregate-Functions）" class="headerlink" title="表聚合函数（Table Aggregate Functions）"></a>表聚合函数（Table Aggregate Functions）</h3><p>• AggregationFunction 要求必须实现的方法：</p>
<p> – createAccumulator() – accumulate() </p>
<p>– emitValue() </p>
<p>• TableAggregateFunction 的工作原理如下: </p>
<p>– 首先，它同样需要一个累加器（Accumulator），它是保存聚合中间结果的数据 结构。通过调用 createAccumulator() 方法可以创建空累加器。 </p>
<p>– 随后，对每个输入行调用函数的 accumulate() 方法来更新累加器。 </p>
<p>– 处理完所有行后，将调用函数的 emitValue() 方法来计算并返回最终结果。</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:1909312602@qq.com">HeavenImmortal</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="https://heavenimtoral.gitee.io/2021/02/09/Flink/">https://heavenimtoral.gitee.io/2021/02/09/Flink/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E5%A4%A7%E6%95%B0%E6%8D%AE/">大数据</a><a class="post-meta__tags" href="/tags/%E6%B5%81%E5%BC%8F%E6%95%B0%E6%8D%AE%E5%A4%84%E7%90%86/">流式数据处理</a></div><div class="post_share"><div class="social-share" data-image="https://heavenimmortal.oss-cn-chengdu.aliyuncs.com/img/20210315195540.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2021/02/23/javaScript%E5%B7%A5%E5%85%B7jutils/"><img class="prev-cover" src="https://heavenimmortal.oss-cn-chengdu.aliyuncs.com/img/jutils-logo.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">Previous Post</div><div class="prev_info">javaScript工具jutils</div></div></a></div><div class="next-post pull-right"><a href="/2021/02/05/ViewUI%E7%9A%84%E8%A1%A8%E5%8D%95%E9%AA%8C%E8%AF%81%E8%A7%84%E5%88%99/"><img class="next-cover" src="https://heavenimmortal.oss-cn-chengdu.aliyuncs.com/img/bef3f726514dc325eed25d0f96b5f60d6c4adc45.jpg@1075w_602h.png" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">Next Post</div><div class="next_info">ViewUI的表单验证规则</div></div></a></div></nav></div><div class="aside_content" id="aside_content"><div class="card-widget card-info"><div class="card-content"><div class="card-info-avatar is-center"><img class="avatar-img" src="https://heavenimmortal.oss-cn-chengdu.aliyuncs.com/img/avatar.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/><div class="author-info__name">HeavenImmortal</div><div class="author-info__description">我苦苦的寻找，完美的代码究竟在哪里？</div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">44</div></a></div><div class="card-info-data-item is-center"><a href="/tags/"><div class="headline">Tags</div><div class="length-num">40</div></a></div><div class="card-info-data-item is-center"><a href="/categories/"><div class="headline">Categories</div><div class="length-num">9</div></a></div></div><a class="button--animated" id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xxxxxx"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/xxxxx" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:xxxxxx@gmail.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div></div><div class="card-widget card-announcement"><div class="card-content"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>Announcement</span></div><div class="announcement_content">This is my Blog</div></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="card-content"><div class="item-headline"><i class="fas fa-stream"></i><span>Catalog</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Flink"><span class="toc-number">1.</span> <span class="toc-text">Flink</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">2.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AE%80%E5%8D%95%E4%B8%8A%E6%89%8B"><span class="toc-number">3.</span> <span class="toc-text">简单上手</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%89%B9%E5%A4%84%E7%90%86wordCount"><span class="toc-number">3.1.</span> <span class="toc-text">批处理wordCount</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B5%81%E5%A4%84%E7%90%86WordCount"><span class="toc-number">3.2.</span> <span class="toc-text">流处理WordCount</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B5%81%E5%BC%8F%E6%95%B0%E6%8D%AE%E6%BA%90"><span class="toc-number">3.3.</span> <span class="toc-text">流式数据源</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Flink%E9%83%A8%E7%BD%B2"><span class="toc-number">4.</span> <span class="toc-text">Flink部署</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%89%E8%A3%85"><span class="toc-number">4.1.</span> <span class="toc-text">安装</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#job%E7%9A%84%E6%8F%90%E4%BA%A4%E6%96%B9%E5%BC%8F"><span class="toc-number">4.2.</span> <span class="toc-text">job的提交方式</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%BF%90%E8%A1%8C%E6%97%B6%E6%9E%B6%E6%9E%84"><span class="toc-number">5.</span> <span class="toc-text">运行时架构</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BF%90%E8%A1%8C%E6%97%B6%E7%BB%84%E4%BB%B6"><span class="toc-number">5.1.</span> <span class="toc-text">运行时组件</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%9C%E4%B8%9A%E7%AE%A1%E7%90%86%E5%99%A8%EF%BC%88jobManager%EF%BC%89"><span class="toc-number">5.1.1.</span> <span class="toc-text">作业管理器（jobManager）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%BB%E5%8A%A1%E7%AE%A1%E7%90%86%E5%99%A8%EF%BC%88TaskManager%EF%BC%89"><span class="toc-number">5.1.2.</span> <span class="toc-text">任务管理器（TaskManager）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86%E5%99%A8%EF%BC%88ResourceManager%EF%BC%89"><span class="toc-number">5.1.3.</span> <span class="toc-text">资源管理器（ResourceManager）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E5%8F%91%E5%99%A8%EF%BC%88Dispatcher%EF%BC%89"><span class="toc-number">5.1.4.</span> <span class="toc-text">分发器（Dispatcher）</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%BB%E5%8A%A1%E6%8F%90%E4%BA%A4%E6%B5%81%E7%A8%8B"><span class="toc-number">5.2.</span> <span class="toc-text">任务提交流程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%BB%E5%8A%A1%E8%B0%83%E5%BA%A6%E5%8E%9F%E7%90%86"><span class="toc-number">5.3.</span> <span class="toc-text">任务调度原理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B9%B6%E8%A1%8C%E5%BA%A6"><span class="toc-number">5.4.</span> <span class="toc-text">并行度</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#TaskManager-%E5%92%8C-Slots"><span class="toc-number">5.5.</span> <span class="toc-text">TaskManager 和 Slots</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B9%B6%E8%A1%8C%E5%AD%90%E4%BB%BB%E5%8A%A1%E7%9A%84%E5%88%86%E9%85%8D"><span class="toc-number">5.6.</span> <span class="toc-text">并行子任务的分配</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%A8%8B%E5%BA%8F%E4%B8%8E%E6%95%B0%E6%8D%AE%E6%B5%81%EF%BC%88DataFlow%EF%BC%89"><span class="toc-number">5.7.</span> <span class="toc-text">程序与数据流（DataFlow）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%89%A7%E8%A1%8C%E5%9B%BE%EF%BC%88ExecutionGraph%EF%BC%89"><span class="toc-number">5.8.</span> <span class="toc-text">执行图（ExecutionGraph）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E4%BC%A0%E8%BE%93%E5%BD%A2%E5%BC%8F"><span class="toc-number">5.9.</span> <span class="toc-text">数据传输形式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%BB%E5%8A%A1%E9%93%BE%EF%BC%88Operator-Chains%EF%BC%89"><span class="toc-number">5.10.</span> <span class="toc-text">任务链（Operator Chains）</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%B5%81%E5%A4%84%E7%90%86API"><span class="toc-number">6.</span> <span class="toc-text">流处理API</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Environment"><span class="toc-number">6.1.</span> <span class="toc-text">Environment</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Source"><span class="toc-number">6.2.</span> <span class="toc-text">Source</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#fromCollection"><span class="toc-number">6.2.1.</span> <span class="toc-text">fromCollection</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#readTextFile"><span class="toc-number">6.2.2.</span> <span class="toc-text">readTextFile</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#FlinkKafkaConsumer"><span class="toc-number">6.2.3.</span> <span class="toc-text">FlinkKafkaConsumer</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SourceFunction"><span class="toc-number">6.2.4.</span> <span class="toc-text">SourceFunction</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Transform%E8%BD%AC%E6%8D%A2%E7%AE%97%E5%AD%90"><span class="toc-number">6.3.</span> <span class="toc-text">Transform转换算子</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Map"><span class="toc-number">6.3.1.</span> <span class="toc-text">Map</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#flatMap"><span class="toc-number">6.3.2.</span> <span class="toc-text">flatMap</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#filter"><span class="toc-number">6.3.3.</span> <span class="toc-text">filter</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#KeyBy"><span class="toc-number">6.3.4.</span> <span class="toc-text">KeyBy</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Rolling-Aggregation"><span class="toc-number">6.3.5.</span> <span class="toc-text">Rolling Aggregation</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#reduce"><span class="toc-number">6.3.6.</span> <span class="toc-text">reduce</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Split-on-select"><span class="toc-number">6.3.7.</span> <span class="toc-text">Split on select</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Connect-on-CoMap"><span class="toc-number">6.3.8.</span> <span class="toc-text">Connect on CoMap</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Union"><span class="toc-number">6.3.9.</span> <span class="toc-text">Union</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Sink"><span class="toc-number">6.4.</span> <span class="toc-text">Sink</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Kafka"><span class="toc-number">6.4.1.</span> <span class="toc-text">Kafka</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Redis"><span class="toc-number">6.4.2.</span> <span class="toc-text">Redis</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Elasticsearch"><span class="toc-number">6.4.3.</span> <span class="toc-text">Elasticsearch</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#JDBC"><span class="toc-number">6.4.4.</span> <span class="toc-text">JDBC</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#window-API"><span class="toc-number">7.</span> <span class="toc-text">window API</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#window%E6%A6%82%E5%BF%B5"><span class="toc-number">7.1.</span> <span class="toc-text">window概念</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AA%97%E5%8F%A3%EF%BC%88window%EF%BC%89"><span class="toc-number">7.1.1.</span> <span class="toc-text">窗口（window）</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#window%E7%B1%BB%E5%9E%8B"><span class="toc-number">7.2.</span> <span class="toc-text">window类型</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BB%9A%E5%8A%A8%E7%AA%97%E5%8F%A3%EF%BC%88Tumbling-Windows%EF%BC%89"><span class="toc-number">7.2.1.</span> <span class="toc-text">滚动窗口（Tumbling Windows）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BB%91%E5%8A%A8%E7%AA%97%E5%8F%A3%EF%BC%88Sliding-Windows%EF%BC%89"><span class="toc-number">7.2.2.</span> <span class="toc-text">滑动窗口（Sliding Windows）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BC%9A%E8%AF%9D%E7%AA%97%E5%8F%A3%EF%BC%88Session-Windows%EF%BC%89"><span class="toc-number">7.2.3.</span> <span class="toc-text">会话窗口（Session Windows）</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#window-API-1"><span class="toc-number">7.3.</span> <span class="toc-text">window API</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AA%97%E5%8F%A3%E5%88%86%E9%85%8D%E5%99%A8%EF%BC%88window-assigner%EF%BC%89"><span class="toc-number">7.4.</span> <span class="toc-text">窗口分配器（window assigner）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E4%B8%8D%E5%90%8C%E7%B1%BB%E5%9E%8B%E7%9A%84%E7%AA%97%E5%8F%A3"><span class="toc-number">7.5.</span> <span class="toc-text">创建不同类型的窗口</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AA%97%E5%8F%A3%E5%87%BD%E6%95%B0%EF%BC%88window-function%EF%BC%89"><span class="toc-number">7.6.</span> <span class="toc-text">窗口函数（window function）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%B6%E5%AE%83%E5%8F%AF%E9%80%89-API"><span class="toc-number">7.7.</span> <span class="toc-text">其它可选 API</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Flink-%E4%B8%AD%E7%9A%84-%E6%97%B6%E9%97%B4%E8%AF%AD%E4%B9%89%E5%92%8C-watermark"><span class="toc-number">8.</span> <span class="toc-text">Flink 中的 时间语义和 watermark</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Flink-%E4%B8%AD%E7%9A%84%E6%97%B6%E9%97%B4%E8%AF%AD%E4%B9%89"><span class="toc-number">8.1.</span> <span class="toc-text">Flink 中的时间语义</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9C%A8%E4%BB%A3%E7%A0%81%E4%B8%AD%E8%AE%BE%E7%BD%AE-Event-Time"><span class="toc-number">8.2.</span> <span class="toc-text">在代码中设置 Event Time</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B9%B1%E5%BA%8F%E6%95%B0%E6%8D%AE%E7%9A%84%E5%BD%B1%E5%93%8D"><span class="toc-number">8.3.</span> <span class="toc-text">乱序数据的影响</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B0%B4%E4%BD%8D%E7%BA%BF%EF%BC%88Watermark%EF%BC%89"><span class="toc-number">8.4.</span> <span class="toc-text">水位线（Watermark）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#watermark-%E7%9A%84%E5%BC%95%E5%85%A5"><span class="toc-number">8.5.</span> <span class="toc-text">watermark 的引入</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#TimestampAssigner"><span class="toc-number">8.6.</span> <span class="toc-text">TimestampAssigner</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#watermark-%E7%9A%84%E8%AE%BE%E5%AE%9A"><span class="toc-number">8.7.</span> <span class="toc-text">watermark 的设定</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%8A%B6%E6%80%81%E7%AE%A1%E7%90%86"><span class="toc-number">9.</span> <span class="toc-text">状态管理</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Flink-%E4%B8%AD%E7%9A%84%E7%8A%B6%E6%80%81"><span class="toc-number">9.1.</span> <span class="toc-text">Flink 中的状态</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AE%97%E5%AD%90%E7%8A%B6%E6%80%81%EF%BC%88Operator-State%EF%BC%89"><span class="toc-number">9.2.</span> <span class="toc-text">算子状态（Operator State）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AE%97%E5%AD%90%E7%8A%B6%E6%80%81%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84"><span class="toc-number">9.2.1.</span> <span class="toc-text">算子状态数据结构</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%94%AE%E6%8E%A7%E7%8A%B6%E6%80%81%EF%BC%88Keyed-State%EF%BC%89"><span class="toc-number">9.3.</span> <span class="toc-text">键控状态（Keyed State）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%94%AE%E6%8E%A7%E7%8A%B6%E6%80%81%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84"><span class="toc-number">9.3.1.</span> <span class="toc-text">键控状态数据结构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%94%AE%E6%8E%A7%E7%8A%B6%E6%80%81%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="toc-number">9.3.2.</span> <span class="toc-text">键控状态的使用</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%8A%B6%E6%80%81%E5%90%8E%E7%AB%AF%EF%BC%88State-Backends%EF%BC%89"><span class="toc-number">9.4.</span> <span class="toc-text">状态后端（State Backends）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%80%89%E6%8B%A9%E4%B8%80%E4%B8%AA%E7%8A%B6%E6%80%81%E5%90%8E%E7%AB%AF"><span class="toc-number">9.4.1.</span> <span class="toc-text">选择一个状态后端</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ProcessFunction-API%EF%BC%88%E5%BA%95%E5%B1%82API%EF%BC%89"><span class="toc-number">10.</span> <span class="toc-text">ProcessFunction API（底层API）</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#KeyedProcessFunction"><span class="toc-number">10.1.</span> <span class="toc-text">KeyedProcessFunction</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#TimerService-%E5%92%8C-%E5%AE%9A%E6%97%B6%E5%99%A8%EF%BC%88Timers%EF%BC%89"><span class="toc-number">10.2.</span> <span class="toc-text">TimerService 和 定时器（Timers）</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%AE%B9%E9%94%99%E6%9C%BA%E5%88%B6"><span class="toc-number">11.</span> <span class="toc-text">容错机制</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E8%87%B4%E6%80%A7%E6%A3%80%E6%9F%A5%E7%82%B9%EF%BC%88checkpoint%EF%BC%89"><span class="toc-number">11.1.</span> <span class="toc-text">一致性检查点（checkpoint）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%8E%E6%A3%80%E6%9F%A5%E7%82%B9%E6%81%A2%E5%A4%8D%E7%8A%B6%E6%80%81"><span class="toc-number">11.2.</span> <span class="toc-text">从检查点恢复状态</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A3%80%E6%9F%A5%E7%82%B9%E7%9A%84%E5%AE%9E%E7%8E%B0%E7%AE%97%E6%B3%95"><span class="toc-number">11.3.</span> <span class="toc-text">检查点的实现算法</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Flink-%E6%A3%80%E6%9F%A5%E7%82%B9%E7%AE%97%E6%B3%95"><span class="toc-number">11.3.1.</span> <span class="toc-text">Flink 检查点算法</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BF%9D%E5%AD%98%E7%82%B9%EF%BC%88Savepoints%EF%BC%89"><span class="toc-number">11.4.</span> <span class="toc-text">保存点（Savepoints）</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%8A%B6%E6%80%81%E4%B8%80%E8%87%B4%E6%80%A7"><span class="toc-number">12.</span> <span class="toc-text">状态一致性</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%8A%B6%E6%80%81%E4%B8%80%E8%87%B4%E6%80%A7-1"><span class="toc-number">12.1.</span> <span class="toc-text">状态一致性</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E8%87%B4%E6%80%A7%E6%A3%80%E6%9F%A5%E7%82%B9%EF%BC%88checkpoint%EF%BC%89-1"><span class="toc-number">12.2.</span> <span class="toc-text">一致性检查点（checkpoint）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AB%AF%E5%88%B0%E7%AB%AF%EF%BC%88end-to-end%EF%BC%89%E7%8A%B6%E6%80%81%E4%B8%80%E8%87%B4%E6%80%A7"><span class="toc-number">12.3.</span> <span class="toc-text">端到端（end-to-end）状态一致性</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AB%AF%E5%88%B0%E7%AB%AF%E7%9A%84%E7%B2%BE%E7%A1%AE%E4%B8%80%E6%AC%A1%EF%BC%88exactly-once%EF%BC%89%E4%BF%9D%E8%AF%81"><span class="toc-number">12.4.</span> <span class="toc-text">端到端的精确一次（exactly-once）保证</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B9%82%E7%AD%89%E5%86%99%E5%85%A5%EF%BC%88Idempotent-Writes%EF%BC%89"><span class="toc-number">12.4.1.</span> <span class="toc-text">幂等写入（Idempotent Writes）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8B%E5%8A%A1%E5%86%99%E5%85%A5%EF%BC%88Transactional-Writes%EF%BC%89"><span class="toc-number">12.4.2.</span> <span class="toc-text">事务写入（Transactional Writes）</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Flink-Kafka-%E7%AB%AF%E5%88%B0%E7%AB%AF%E7%8A%B6%E6%80%81%E4%B8%80%E8%87%B4%E6%80%A7%E7%9A%84%E4%BF%9D%E8%AF%81"><span class="toc-number">12.5.</span> <span class="toc-text">Flink+Kafka 端到端状态一致性的保证</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Table-API-%E5%92%8C-Flink-SQL"><span class="toc-number">13.</span> <span class="toc-text">Table API 和 Flink SQL</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E7%A8%8B%E5%BA%8F%E7%BB%93%E6%9E%84"><span class="toc-number">13.1.</span> <span class="toc-text">基本程序结构</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA-TableEnvironment"><span class="toc-number">13.1.1.</span> <span class="toc-text">创建 TableEnvironment</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE-TableEnvironment"><span class="toc-number">13.1.2.</span> <span class="toc-text">配置 TableEnvironment</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E8%80%81%E7%89%88%E6%9C%AC-planner-%E7%9A%84%E6%B5%81%E5%BC%8F%E6%9F%A5%E8%AF%A2"><span class="toc-number">13.1.2.1.</span> <span class="toc-text">配置老版本 planner 的流式查询</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E8%80%81%E7%89%88%E6%9C%AC-planner-%E7%9A%84%E6%89%B9%E5%BC%8F%E6%9F%A5%E8%AF%A2"><span class="toc-number">13.1.2.2.</span> <span class="toc-text">配置老版本 planner 的批式查询</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE-blink-planner-%E7%9A%84%E6%B5%81%E5%BC%8F%E6%9F%A5%E8%AF%A2"><span class="toc-number">13.1.2.3.</span> <span class="toc-text">配置 blink planner 的流式查询</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE-blink-planner-%E7%9A%84%E6%89%B9%E5%BC%8F%E6%9F%A5%E8%AF%A2"><span class="toc-number">13.1.2.4.</span> <span class="toc-text">配置 blink planner 的批式查询</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A1%A8%EF%BC%88Table%EF%BC%89"><span class="toc-number">13.1.3.</span> <span class="toc-text">表（Table）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E8%A1%A8"><span class="toc-number">13.1.3.1.</span> <span class="toc-text">创建表</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%A1%A8%E7%9A%84%E6%9F%A5%E8%AF%A2-%E2%80%93-Table-API"><span class="toc-number">13.2.</span> <span class="toc-text">表的查询 – Table API</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BE%93%E5%87%BA"><span class="toc-number">13.3.</span> <span class="toc-text">输出</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BE%93%E5%87%BA%E8%A1%A8"><span class="toc-number">13.3.1.</span> <span class="toc-text">输出表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BE%93%E5%87%BA%E5%88%B0%E6%96%87%E4%BB%B6"><span class="toc-number">13.3.2.</span> <span class="toc-text">输出到文件</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9B%B4%E6%96%B0%E6%A8%A1%E5%BC%8F"><span class="toc-number">13.3.2.1.</span> <span class="toc-text">更新模式</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BE%93%E5%87%BA%E5%88%B0-Kafka"><span class="toc-number">13.3.3.</span> <span class="toc-text">输出到 Kafka</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BE%93%E5%87%BA%E5%88%B0-ES"><span class="toc-number">13.3.4.</span> <span class="toc-text">输出到 ES</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BE%93%E5%87%BA%E5%88%B0-MySql"><span class="toc-number">13.3.5.</span> <span class="toc-text">输出到 MySql</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B0%86-Table-%E8%BD%AC%E6%8D%A2%E6%88%90-DataStream"><span class="toc-number">13.4.</span> <span class="toc-text">将 Table 转换成 DataStream</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E4%B8%B4%E6%97%B6%E8%A7%86%E5%9B%BE%EF%BC%88Temporary-View%EF%BC%89"><span class="toc-number">13.5.</span> <span class="toc-text">创建临时视图（Temporary View）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E6%89%A7%E8%A1%8C%E8%AE%A1%E5%88%92"><span class="toc-number">13.6.</span> <span class="toc-text">查看执行计划</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8A%A8%E6%80%81%E8%A1%A8%EF%BC%88Dynamic-Tables%EF%BC%89"><span class="toc-number">13.7.</span> <span class="toc-text">动态表（Dynamic Tables）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B0%86%E6%B5%81%E8%BD%AC%E6%8D%A2%E6%88%90%E5%8A%A8%E6%80%81%E8%A1%A8"><span class="toc-number">13.7.1.</span> <span class="toc-text">将流转换成动态表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8C%81%E7%BB%AD%E6%9F%A5%E8%AF%A2"><span class="toc-number">13.7.2.</span> <span class="toc-text">持续查询</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B0%86%E5%8A%A8%E6%80%81%E8%A1%A8%E8%BD%AC%E6%8D%A2%E6%88%90-DataStream"><span class="toc-number">13.7.3.</span> <span class="toc-text">将动态表转换成 DataStream</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%97%B6%E9%97%B4%E7%89%B9%E6%80%A7"><span class="toc-number">13.8.</span> <span class="toc-text">时间特性</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9A%E4%B9%89%E5%A4%84%E7%90%86%E6%97%B6%E9%97%B4%EF%BC%88Processing-Time%EF%BC%89"><span class="toc-number">13.8.1.</span> <span class="toc-text">定义处理时间（Processing Time）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9A%E4%B9%89%E4%BA%8B%E4%BB%B6%E6%97%B6%E9%97%B4%EF%BC%88Event-Time%EF%BC%89"><span class="toc-number">13.8.2.</span> <span class="toc-text">定义事件时间（Event Time）</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AA%97%E5%8F%A3"><span class="toc-number">13.9.</span> <span class="toc-text">窗口</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Group-Windows"><span class="toc-number">13.9.1.</span> <span class="toc-text">Group Windows</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BB%9A%E5%8A%A8%E7%AA%97%E5%8F%A3%EF%BC%88Tumbling-windows%EF%BC%89"><span class="toc-number">13.9.2.</span> <span class="toc-text">滚动窗口（Tumbling windows）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BB%91%E5%8A%A8%E7%AA%97%E5%8F%A3%EF%BC%88Sliding-windows%EF%BC%89"><span class="toc-number">13.9.3.</span> <span class="toc-text">滑动窗口（Sliding windows）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BC%9A%E8%AF%9D%E7%AA%97%E5%8F%A3%EF%BC%88Session-windows%EF%BC%89"><span class="toc-number">13.9.4.</span> <span class="toc-text">会话窗口（Session windows）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SQL-%E4%B8%AD%E7%9A%84-Group-Windows"><span class="toc-number">13.9.5.</span> <span class="toc-text">SQL 中的 Group Windows</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Over-Windows"><span class="toc-number">13.9.6.</span> <span class="toc-text">Over Windows</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%97%A0%E7%95%8C-Over-Windows"><span class="toc-number">13.9.7.</span> <span class="toc-text">无界 Over Windows</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%89%E7%95%8C-Over-Windows"><span class="toc-number">13.9.8.</span> <span class="toc-text">有界 Over Windows</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SQL-%E4%B8%AD%E7%9A%84-Over-Windows"><span class="toc-number">13.9.9.</span> <span class="toc-text">SQL 中的 Over Windows</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%87%BD%E6%95%B0%EF%BC%88Functions%EF%BC%89"><span class="toc-number">13.10.</span> <span class="toc-text">函数（Functions）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%94%A8%E6%88%B7%E8%87%AA%E5%AE%9A%E4%B9%89%E5%87%BD%E6%95%B0%EF%BC%88UDF%EF%BC%89"><span class="toc-number">13.10.1.</span> <span class="toc-text">用户自定义函数（UDF）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A0%87%E9%87%8F%E5%87%BD%E6%95%B0%EF%BC%88Scalar-Functions%EF%BC%89"><span class="toc-number">13.10.2.</span> <span class="toc-text">标量函数（Scalar Functions）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A1%A8%E5%87%BD%E6%95%B0%EF%BC%88Table-Functions%EF%BC%89"><span class="toc-number">13.10.3.</span> <span class="toc-text">表函数（Table Functions）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%81%9A%E5%90%88%E5%87%BD%E6%95%B0%EF%BC%88Aggregate-Functions%EF%BC%89"><span class="toc-number">13.10.4.</span> <span class="toc-text">聚合函数（Aggregate Functions）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A1%A8%E8%81%9A%E5%90%88%E5%87%BD%E6%95%B0%EF%BC%88Table-Aggregate-Functions%EF%BC%89"><span class="toc-number">13.10.5.</span> <span class="toc-text">表聚合函数（Table Aggregate Functions）</span></a></li></ol></li></ol></li></ol></div></div></div><div class="card-widget card-recent-post"><div class="card-content"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Post</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2022/07/27/PgSql%E8%8E%B7%E5%8F%96json%E6%A0%BC%E5%BC%8F%E5%AD%97%E7%AC%A6%E4%B8%B2%E4%B8%AD%E6%9F%90%E4%B8%AA%E5%B1%9E%E6%80%A7%E7%9A%84%E5%80%BC/" title="PgSql获取json格式字符串中某个属性的值"><img src="https://heavenimmortal.oss-cn-chengdu.aliyuncs.com/img/20210401115543.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="PgSql获取json格式字符串中某个属性的值"/></a><div class="content"><a class="title" href="/2022/07/27/PgSql%E8%8E%B7%E5%8F%96json%E6%A0%BC%E5%BC%8F%E5%AD%97%E7%AC%A6%E4%B8%B2%E4%B8%AD%E6%9F%90%E4%B8%AA%E5%B1%9E%E6%80%A7%E7%9A%84%E5%80%BC/" title="PgSql获取json格式字符串中某个属性的值">PgSql获取json格式字符串中某个属性的值</a><time datetime="2022-07-27T02:28:39.864Z" title="Created 2022-07-27 10:28:39">2022-07-27</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/03/25/Mybatis-%E6%89%B9%E9%87%8F%E5%A4%84%E7%90%86/" title="MyBatis-批量处理"><img src="https://heavenimmortal.oss-cn-chengdu.aliyuncs.com/img/20210401115535.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="MyBatis-批量处理"/></a><div class="content"><a class="title" href="/2022/03/25/Mybatis-%E6%89%B9%E9%87%8F%E5%A4%84%E7%90%86/" title="MyBatis-批量处理">MyBatis-批量处理</a><time datetime="2022-03-25T03:17:21.963Z" title="Created 2022-03-25 11:17:21">2022-03-25</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2021/10/22/jvm/" title="No title"><img src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="No title"/></a><div class="content"><a class="title" href="/2021/10/22/jvm/" title="No title">No title</a><time datetime="2021-10-22T09:42:25.080Z" title="Created 2021-10-22 17:42:25">2021-10-22</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2021/09/30/typeScript/" title="TypeScript"><img src="https://heavenimmortal.oss-cn-chengdu.aliyuncs.com/img/20211019161458.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="TypeScript"/></a><div class="content"><a class="title" href="/2021/09/30/typeScript/" title="TypeScript">TypeScript</a><time datetime="2021-09-30T06:28:35.678Z" title="Created 2021-09-30 14:28:35">2021-09-30</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2021/09/22/OpenLayers/" title="OpenLayers"><img src="https://heavenimmortal.oss-cn-chengdu.aliyuncs.com/img/20210922152509.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="OpenLayers"/></a><div class="content"><a class="title" href="/2021/09/22/OpenLayers/" title="OpenLayers">OpenLayers</a><time datetime="2021-09-22T06:27:41.751Z" title="Created 2021-09-22 14:27:41">2021-09-22</time></div></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2022 By HeavenImmortal</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">广修亿劫，证吾神通!</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="Switch Between Traditional Chinese And Simplified Chinese">简</button><button id="darkmode" type="button" title="Switch Between Light And Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="Setting"><i class="fas fa-cog"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back To Top"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><div class="search-dialog__title" id="local-search-title">Local search</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="Search for Posts" type="text"/></div></div></div><hr/><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>Powered by</span> <a target="_blank" rel="noopener" href="https://github.com/wzpan/hexo-generator-search" style="color:#49B1F5;">hexo-generator-search</a></div></div></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><div id="search-mask"></div></div><div><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="/js/search/local-search.js"></script><script>var preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',()=> {preloader.endLoading()})</script><div class="js-pjax"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><script src="/css/mine.js"></script></div></body></html>